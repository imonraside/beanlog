<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>BeanLog</title>
  <meta name="theme-color" content="#ffffff">
  <meta name="mobile-web-app-capable" content="yes">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={darkMode:'class'}</script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&family=Montserrat:wght@600;700;900&family=Roboto+Mono:wght@400;500;700&display=swap');
    
    html, body { 
        height: 100%; 
        overflow: hidden; 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans KR", sans-serif; 
        background: #f8fafc;
    }
    
    .font-brand { font-family: 'Montserrat', sans-serif; }
    .font-timer { font-family: 'Montserrat', sans-serif; }
    .font-capture { font-family: 'Noto Sans KR', sans-serif; }
    
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    #app-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #333; border-radius: 50%; animation: spin 1s linear infinite; }
    .loader-white { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .animate-in { animation: fadeIn 0.3s ease-out forwards; }
    .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    .animate-pop { animation: pop 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    @keyframes pop { 0% { transform: scale(0.9); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    .step-active { background-color: #ffffff; border-left-width: 6px; border-color: #3b82f6; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: scale(1.02); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    .step-inactive { border-left-width: 2px; border-color: transparent; opacity: 0.6; filter: grayscale(100%); transform: scale(1); transition: all 0.4s ease; }
    
    .cropper-view-box, .cropper-face { outline: 2px solid white; }
    .dot-line { border-bottom: 2px dotted #cbd5e1; flex: 1; margin: 0 6px; position: relative; top: -4px; }
    .no-select { -webkit-user-select: none; user-select: none; }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "html-to-image": "https://esm.sh/html-to-image@1.11.11"
      }
    }
  </script>
  <script src="https://unpkg.com/@babel/standalone@7.23.8/babel.min.js"></script>
</head>
<body class="bg-slate-50 dark:bg-slate-950 text-slate-900 dark:text-slate-100 select-none overflow-hidden w-full h-full">
  <div id="app-loader"><div class="spinner"></div><p style="margin-top:15px; font-weight:bold; color:#666;">BeanLog loading</p></div>
  <div id="root" class="h-full w-full"></div>
  <script>setTimeout(()=>{const l=document.getElementById('app-loader');if(l)l.style.display='none'},1500);</script>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo, useRef, useCallback, useLayoutEffect } from 'react';
    import { createRoot } from 'react-dom/client';
    import * as htmlToImage from 'html-to-image';
    import { 
      Plus, Camera, Settings, ChevronLeft, Trash2, Coffee, Calendar, Star,
      RefreshCw, Zap, FileText, Clock, ChevronRight, Info, CheckCircle2,
      Quote, StickyNote, Award, Save, Search, X, Check, ShoppingBag, Download, Upload, RotateCcw, Link,
      ExternalLink, MapPin, Tag, User, Mountain, Flame, Bean, BeanOff, HelpCircle, Filter, LayoutList, LogOut, Sun, Moon, Monitor, Image as ImageIcon,
      ArrowUpDown, CalendarDays, MoreHorizontal, ToggleLeft, ToggleRight, PenTool, Minus, Calculator, Share2, Layers, Sparkles, Palette,
      Layout, Timer, Play, Pause, Droplet, RefreshCcw, Tornado, Target, Utensils, Waves, List, AlertCircle,
      LayoutDashboard, PieChart, BarChart3, ChevronLeftCircle, ChevronRightCircle, ChevronDown, ChevronsLeft, ChevronsRight
    } from 'lucide-react';

    // --- 1. GLOBAL HELPERS & CONSTANTS ---
    const STORAGE_KEY = "BEAN_LOG_MASTER_FINAL";
    const RECIPE_STORAGE_KEY = `${STORAGE_KEY}_recipes`;
    const APP_VERSION = "v1.1.3";
    const TAB = { BEANS: 'BEANS', TIMER: 'TIMER', STATS: 'STATS', SETTINGS: 'SETTINGS' };
    
    const INITIAL_BEAN = { id: null, name: "", country: "", region: "", variety: "", processing: "", altitude: "", roastingLevel: "", producer: "", roastingDate: "", purchaseDate: "", shop: "", purchaseUrl: "", weight: "", price: "", pricePerCup: "", notes: "", flavorDesc: "", memo: "", isFinished: false, isBlend: false, blendInfo: [], mainImage: null, ocrImage: null, tastings: [] };
    const INITIAL_TASTING = { date: new Date().toISOString().split('T')[0], scores: { acidity: 7.0, balance: 7.0, sweetness: 7.0, cleanCup: 7.0, body: 7.0, flavor: 7.0 }, isManualTotal: false, totalScore: 7.0, notes: "", desc: "", memo: "" };
    // [Fix] Empty Initial Recipe (Global Definition)
    const INITIAL_RECIPE = { id: null, title: "", bean: "", water: "", interval: "", endTime: "", memo: "" };

    const TASTE_ITEMS = [{ id: 'acidity', label: 'ì‚°ë¯¸' }, { id: 'balance', label: 'ë°¸ëŸ°ìŠ¤' }, { id: 'sweetness', label: 'ë‹¨ë§›' }, { id: 'cleanCup', label: 'í´ë¦°ì»µ' }, { id: 'body', label: 'ë°”ë””' }, { id: 'flavor', label: 'í–¥ë¯¸' }];
    const SCORE_LABELS_KO = { acidity: "ì‚°ë¯¸", balance: "ë°¸ëŸ°ìŠ¤", sweetness: "ë‹¨ë§›", cleanCup: "í´ë¦°ì»µ", body: "ë°”ë””", flavor: "í–¥ë¯¸" };

    const generateShareText = (bean, tasting) => {
        const score = getDisplayScore(tasting);
        const scoresText = Object.entries(tasting.scores).map(([key, val]) => `- ${SCORE_LABELS_KO[key]}: ${val}`).join('\n');
        return `[BeanLog ì‹œìŒ ê¸°ë¡]
ì›ë‘: ${bean.name}
êµ­ê°€: ${bean.country || '-'} / ì§€ì—­: ${bean.region || '-'}
ê°€ê³µ: ${bean.processing || '-'} / ë¡œìŠ¤íŒ…: ${bean.roastingLevel || '-'} (${bean.roastingDate || '-'})
êµ¬ë§¤ì²˜: ${bean.shop || '-'}

ë‚ ì§œ: ${tasting.date}
í‰ì : ${score}
[ì„¸ë¶€ ì ìˆ˜]
${scoresText}

ë…¸íŠ¸: ${tasting.notes || '-'}
í‰ê°€: ${tasting.desc || '-'}
ë©”ëª¨: ${tasting.memo || '-'}`;
    };

    const generateBeanShareText = (bean) => {
        const blendText = (bean.isBlend && bean.blendInfo) 
            ? `ë¸”ë Œë“œ ì •ë³´: ${bean.blendInfo.map(b => `${b.country} ${b.variety} ${b.ratio}%`.trim()).join(', ')}\n` 
            : `êµ­ê°€: ${bean.country || '-'} / ì§€ì—­: ${bean.region || '-'}\ní’ˆì¢…: ${bean.variety || '-'} / ê³ ë„: ${bean.altitude || '-'}\n`;

        return `[BeanLog ì›ë‘ ê¸°ë¡]
ì›ë‘: ${bean.name}
${blendText}ê°€ê³µ: ${bean.processing || '-'} / ë¡œìŠ¤íŒ…: ${bean.roastingLevel || '-'}
ìƒì‚°ì: ${bean.producer || '-'}
êµ¬ë§¤ì²˜: ${bean.shop || '-'} / êµ¬ë§¤ì¼: ${bean.purchaseDate || '-'}
ë¡œìŠ¤íŒ… ë‚ ì§œ: ${bean.roastingDate || '-'}
ê°€ê²©: ${bean.price ? `${Number(bean.price).toLocaleString()}ì›` : '-'} (${bean.weight || '-'}g)${bean.pricePerCup ? ` / í•œì”: ${Number(bean.pricePerCup).toLocaleString()}ì›` : ''}
${bean.purchaseUrl ? `ë§í¬: ${bean.purchaseUrl}\n` : ''}
ë…¸íŠ¸: ${bean.notes || '-'}
í–¥ë¯¸: ${bean.flavorDesc || '-'}
ë©”ëª¨: ${bean.memo || '-'}`;
    };

    // v1.8.1: Full Flavor Data Set (8 Categories, 87 Notes)
    const FLAVOR_DATA = [
      { id: 'fruity', label: 'ê³¼ì¼ (Fruity)', color: 'bg-red-500', bg: 'bg-red-50 dark:bg-red-900/20', text: 'text-red-700 dark:text-red-300', subs: [ { group: 'ë² ë¦¬ë¥˜ (Berry)', items: ['ë”¸ê¸°', 'ë¸”ë£¨ë² ë¦¬', 'ë¼ì¦ˆë² ë¦¬', 'ë¸”ë™ë² ë¦¬', 'í¬ëœë² ë¦¬', 'ë³µë¶„ì', 'ì‚°ë”¸ê¸°'] }, { group: 'ê°ê·¤ë¥˜ (Citrus)', items: ['ë ˆëª¬', 'ë¼ì„', 'ì˜¤ë Œì§€', 'ìëª½', 'ê·¤', 'ìœ ì', 'ë² ë¥´ê°€ëª»', 'ë§Œë‹¤ë¦°', 'íƒ ì €ë¦°'] }, { group: 'í•µê³¼ë¥˜ (Stone Fruit)', items: ['ë³µìˆ­ì•„', 'ì‚´êµ¬', 'ìë‘', 'ì²´ë¦¬', 'ì•µë‘', 'ì²œë„ë³µìˆ­ì•„', 'ìë‘(Plum)'] }, { group: 'ì—´ëŒ€ ê³¼ì¼ (Tropical)', items: ['ë§ê³ ', 'íŒŒì¸ì• í”Œ', 'ë°”ë‚˜ë‚˜', 'ì½”ì½”ë„›', 'íŒŒíŒŒì•¼', 'ë¦¬ì¹˜', 'íŒ¨ì…˜í›„ë¥´ì¸ ', 'ë©œë¡ ', 'ìˆ˜ë°•', 'í‚¤ìœ„'] }, { group: 'ê¸°íƒ€ ê³¼ì¼', items: ['ì‚¬ê³¼', 'ì²­ì‚¬ê³¼', 'ë°°', 'í¬ë„', 'ì²­í¬ë„', 'ë¨¸ìŠ¤ìº£', 'ì„ë¥˜', 'ë¬´í™”ê³¼', 'í† ë§ˆí† '] }, { group: 'ë§ë¦° ê³¼ì¼', items: ['ê±´í¬ë„', 'ë§ë¦° ìë‘(í”„ë£¬)', 'ê³¶ê°', 'ëŒ€ì¶”', 'ê±´ë¬´í™”ê³¼'] } ] },
      { id: 'floral', label: 'ê½ƒ/ì°¨ (Floral)', color: 'bg-fuchsia-500', bg: 'bg-fuchsia-50 dark:bg-fuchsia-900/20', text: 'text-fuchsia-700 dark:text-fuchsia-300', subs: [ { group: 'ê½ƒ í–¥ê¸°', items: ['ììŠ¤ë¯¼', 'ì¥ë¯¸', 'ì¹´ëª¨ë§ˆì¼', 'ë¼ë²¤ë”', 'íˆë¹„ìŠ¤ì»¤ìŠ¤', 'ì•„ì¹´ì‹œì•„', 'ì—˜ë”í”Œë¼ì›Œ', 'ë²šê½ƒ', 'ëª©ë ¨'] }, { group: 'ì°¨ (Tea)', items: ['í™ì°¨', 'ë…¹ì°¨', 'ì–¼ê·¸ë ˆì´', 'ìš°ë¡±ì°¨', 'ë§ì°¨', 'ë³´ë¦¬ì°¨', 'í—ˆë¸Œí‹°'] } ] },
      { id: 'sweet', label: 'ë‹¬ì½¤í•¨ (Sweet)', color: 'bg-orange-400', bg: 'bg-orange-50 dark:bg-orange-900/20', text: 'text-orange-700 dark:text-orange-300', subs: [ { group: 'ì„¤íƒ•/ì‹œëŸ½', items: ['ê¿€', 'í‘ì„¤íƒ•', 'ìº¬ë¼ë©œ', 'ë©”ì´í”Œ ì‹œëŸ½', 'ì¡°ì²­', 'ë‹¹ë°€', 'ë‹¬ê³ ë‚˜', 'í™©ì„¤íƒ•'] }, { group: 'ë””ì €íŠ¸/í¬ë¦¼', items: ['ë°”ë‹ë¼', 'ë²„í„°', 'í¬ë¦¼', 'ë§ˆì‹œë©œë¡œìš°', 'í† í”¼', 'ì—°ìœ ', 'ì»¤ìŠ¤í„°ë“œ', 'ìƒí¬ë¦¼'] } ] },
      { id: 'nutty', label: 'ê²¬ê³¼/ì´ˆì½” (Nutty)', color: 'bg-amber-700', bg: 'bg-amber-50 dark:bg-amber-900/20', text: 'text-amber-900 dark:text-amber-300', subs: [ { group: 'ì´ˆì½œë¦¿', items: ['ë‹¤í¬ ì´ˆì½œë¦¿', 'ë°€í¬ ì´ˆì½œë¦¿', 'ì¹´ì¹´ì˜¤ë‹™ìŠ¤', 'ì½”ì½”ì•„ íŒŒìš°ë”', 'ì´ˆì½”ì‹œëŸ½'] }, { group: 'ê²¬ê³¼ë¥˜', items: ['ì•„ëª¬ë“œ', 'í˜¸ë‘', 'ë•…ì½©', 'í—¤ì´ì¦ë„›', 'í”¼ì¹¸', 'ìºìŠˆë„›', 'ë§ˆì¹´ë‹¤ë¯¸ì•„', 'í”¼ìŠ¤íƒ€ì¹˜ì˜¤', 'ë°¤'] } ] },
      { id: 'roasted', label: 'ê³ ì†Œí•¨ (Roasted)', color: 'bg-stone-500', bg: 'bg-stone-100 dark:bg-stone-900/20', text: 'text-stone-700 dark:text-stone-300', subs: [ { group: 'ê³¡ë¬¼ (Cereal)', items: ['ê³¡ë¬¼', 'ë§¥ì•„', 'ë³¶ì€ ë³´ë¦¬', 'í† ìŠ¤íŠ¸', 'ëˆ„ë£½ì§€', 'ë»¥íŠ€ê¸°', 'ë¹„ìŠ¤í‚·', 'ë¼ì´ë§¥', 'ì˜¤íŠ¸ë°€'] }, { group: 'ë¡œìŠ¤íŠ¸ (Roast)', items: ['ìŠ¤ëª¨í‚¤', 'íƒ„ë§›', 'ì¬(Ash)', 'íƒ€ë°”ì½”', 'ê°€ì£½', 'í›ˆì œ'] }, { group: 'ê°ì¹ ë§› (Savory)', items: ['ê°„ì¥', 'ëœì¥', 'íŒì½˜', 'ë²„í„°ë§›'] } ] },
      { id: 'spices', label: 'í–¥ì‹ ë£Œ (Spices)', color: 'bg-rose-900', bg: 'bg-rose-50 dark:bg-rose-900/20', text: 'text-rose-900 dark:text-rose-300', subs: [ { group: 'ë¸Œë¼ìš´ ìŠ¤íŒŒì´ìŠ¤', items: ['ì‹œë‚˜ëª¬', 'ì •í–¥', 'ìœ¡ë‘êµ¬', 'ì•„ë‹ˆìŠ¤', 'ê°ì´ˆ', 'ê³„í”¼'] }, { group: 'í—ˆë¸Œ/ê¸°íƒ€', items: ['í›„ì¶”', 'ìƒê°•', 'ë¯¼íŠ¸', 'ì„¸ì´ì§€', 'ë”œ', 'ë ˆëª¬ê·¸ë¼ìŠ¤', 'ë°”ì§ˆ', 'ìœ ì¹¼ë¦½íˆ¬ìŠ¤', 'ì¹´ë ˆ'] } ] },
      { id: 'vegetal', label: 'ì±„ì†Œ/ì§€êµ¬ (Vegetal)', color: 'bg-green-600', bg: 'bg-green-50 dark:bg-green-900/20', text: 'text-green-700 dark:text-green-300', subs: [ { group: 'í™ë‚´ìŒ (Earthy)', items: ['í™', 'ë‚˜ë¬´(Woody)', 'ê±´ì´ˆ', 'ì§€í‘¸ë¼ê¸°', 'ë²„ì„¯', 'ì´ë¼', 'ìˆ²ë°”ë‹¥'] }, { group: 'ì±„ì†Œ (Vegetable)', items: ['ì˜¤ì´', 'ì™„ë‘ì½©', 'í˜¸ë°•', 'í”¼ë§', 'í’€(Grassy)', 'ì˜¬ë¦¬ë¸Œ', 'ê¹»ì'] } ] },
      { id: 'sour', label: 'ì‚°ë¯¸/ë°œíš¨ (Sour)', color: 'bg-yellow-500', bg: 'bg-yellow-50 dark:bg-yellow-900/20', text: 'text-yellow-800 dark:text-yellow-300', subs: [ { group: 'ì•Œì½œ/ë°œíš¨', items: ['ì™€ì¸', 'ìœ„ìŠ¤í‚¤', 'ëŸ¼', 'ìƒ´í˜ì¸', 'ë§‰ê±¸ë¦¬', 'ë°œíš¨ì·¨', 'ë±…ì‡¼'] }, { group: 'ì‚°ë¯¸/ê¸°íƒ€', items: ['ì‹ì´ˆ', 'ìš”ê±°íŠ¸', 'ì¹˜ì¦ˆ', 'ì‹œí¼í•œ', 'ê³ ë¬´', 'ì•½í’ˆ'] } ] }
    ];

    const safeStorage = {
      get: (key) => { try { return JSON.parse(localStorage.getItem(key)); } catch { return null; } },
      set: (key, value) => { try { localStorage.setItem(key, JSON.stringify(value)); return true; } catch { return false; } }
    };
    const formatTime = (sec) => `${Math.floor(sec/60)}:${(sec%60)<10?'0':''}${sec%60}`;
    const calculateRatio = (b, w) => { 
        const bean = parseFloat(b)||0; if(bean===0) return "0:0"; 
        let totalWater = 0; const matches = w.trim().match(/(\d+(?:\.\d+)?)(?:g)?/g); 
        if (matches) matches.forEach(m => { if (!m.includes('g')) totalWater += parseFloat(m); }); 
        return `1 : ${(totalWater/bean).toFixed(1)}`; 
    };

    const parseTags = (text) => {
        if (!text) return [];
        if (/[,/]/.test(text)) return text.split(/[,/]+/).map(t => t.trim()).filter(Boolean);
        return text.split(/\s+/).map(t => t.trim()).filter(Boolean);
    };
    const calcAvg = (scores) => { const values = Object.values(scores).map(v => parseFloat(v)); if (values.some(v => isNaN(v))) return "0.0"; return (values.reduce((a, b) => a + b, 0) / 6).toFixed(1); };
    const getDisplayScore = (tasting) => (tasting.isManualTotal && tasting.totalScore !== undefined) ? Number(tasting.totalScore).toFixed(1) : calcAvg(tasting.scores);
    const getMaxScoreVal = (tastings) => (!tastings.length) ? 0 : Math.max(...tastings.map(t => parseFloat(getDisplayScore(t))));
    const getMaxScore = (tastings) => getMaxScoreVal(tastings).toFixed(1);
    const getBestTastingNote = (tastings) => { if (!tastings || tastings.length === 0) return null; const sorted = [...tastings].sort((a, b) => parseFloat(getDisplayScore(b)) - parseFloat(getDisplayScore(a))); return sorted[0].notes; };
    const calcPricePer100g = (price, weight) => { if(!price || !weight) return null; const p = parseFloat(price.replace(/,/g, '')); const w = parseFloat(weight); if(isNaN(p) || isNaN(w) || w === 0) return null; return Math.round((p / w) * 100).toLocaleString(); };
    const formatWeight = (g) => { const num = parseFloat(g); if (isNaN(num)) return "0g"; if (num >= 1000) return `${(num/1000).toFixed(1)}kg`; return `${num}g`; };
    
    const getFlagEmoji = (countryName) => {
        if (!countryName) return null;
        const lower = countryName.toLowerCase().trim();
        const map = {
            'í•œêµ­': 'ğŸ‡°ğŸ‡·', 'korea': 'ğŸ‡°ğŸ‡·', 'ëŒ€í•œë¯¼êµ­': 'ğŸ‡°ğŸ‡·', 'ì—í‹°ì˜¤í”¼ì•„': 'ğŸ‡ªğŸ‡¹', 'ethiopia': 'ğŸ‡ªğŸ‡¹', 'ì½œë¡¬ë¹„ì•„': 'ğŸ‡¨ğŸ‡´', 'colombia': 'ğŸ‡¨ğŸ‡´',
            'ë¸Œë¼ì§ˆ': 'ğŸ‡§ğŸ‡·', 'brazil': 'ğŸ‡§ğŸ‡·', 'ê³¼í…Œë§ë¼': 'ğŸ‡¬ğŸ‡¹', 'guatemala': 'ğŸ‡¬ğŸ‡¹', 'ì¼€ëƒ': 'ğŸ‡°ğŸ‡ª', 'kenya': 'ğŸ‡°ğŸ‡ª',
            'ì½”ìŠ¤íƒ€ë¦¬ì¹´': 'ğŸ‡¨ğŸ‡·', 'costa rica': 'ğŸ‡¨ğŸ‡·', 'costarica': 'ğŸ‡¨ğŸ‡·', 'íŒŒë‚˜ë§ˆ': 'ğŸ‡µğŸ‡¦', 'panama': 'ğŸ‡µğŸ‡¦',
            'ì—˜ì‚´ë°”ë„ë¥´': 'ğŸ‡¸ğŸ‡»', 'el salvador': 'ğŸ‡¸ğŸ‡»', 'elsalvador': 'ğŸ‡¸ğŸ‡»', 'ì˜¨ë‘ë¼ìŠ¤': 'ğŸ‡­ğŸ‡³', 'honduras': 'ğŸ‡­ğŸ‡³',
            'ì¸ë„ë„¤ì‹œì•„': 'ğŸ‡®ğŸ‡©', 'indonesia': 'ğŸ‡®ğŸ‡©', 'ë² íŠ¸ë‚¨': 'ğŸ‡»ğŸ‡³', 'vietnam': 'ğŸ‡»ğŸ‡³', 'ì˜ˆë©˜': 'ğŸ‡¾ğŸ‡ª', 'yemen': 'ğŸ‡¾ğŸ‡ª',
            'ë¥´ì™„ë‹¤': 'ğŸ‡·ğŸ‡¼', 'rwanda': 'ğŸ‡·ğŸ‡¼', 'ë¶€ë£¬ë””': 'ğŸ‡§ğŸ‡®', 'burundi': 'ğŸ‡§ğŸ‡®', 'íƒ„ìë‹ˆì•„': 'ğŸ‡¹ğŸ‡¿', 'tanzania': 'ğŸ‡¹ğŸ‡¿',
            'ë©•ì‹œì½”': 'ğŸ‡²ğŸ‡½', 'mexico': 'ğŸ‡²ğŸ‡½', 'í˜ë£¨': 'ğŸ‡µğŸ‡ª', 'peru': 'ğŸ‡µğŸ‡ª', 'ë³¼ë¦¬ë¹„ì•„': 'ğŸ‡§ğŸ‡´', 'bolivia': 'ğŸ‡§ğŸ‡´',
            'ì—ì½°ë„ë¥´': 'ğŸ‡ªğŸ‡¨', 'ecuador': 'ğŸ‡ªğŸ‡¨', 'ì¸ë„': 'ğŸ‡®ğŸ‡³', 'india': 'ğŸ‡®ğŸ‡³', 'íŒŒí‘¸ì•„ë‰´ê¸°ë‹ˆ': 'ğŸ‡µğŸ‡¬', 'papua new guinea': 'ğŸ‡µğŸ‡¬',
            'ë¯¸êµ­': 'ğŸ‡ºğŸ‡¸', 'usa': 'ğŸ‡ºğŸ‡¸', 'us': 'ğŸ‡ºğŸ‡¸', 'í•˜ì™€ì´': 'ğŸ‡ºğŸ‡¸', 'ì¤‘êµ­': 'ğŸ‡¨ğŸ‡³', 'china': 'ğŸ‡¨ğŸ‡³', 'í˜¸ì£¼': 'ğŸ‡¦ğŸ‡º', 'australia': 'ğŸ‡¦ğŸ‡º', 'ë‹ˆì¹´ë¼ê³¼': 'ğŸ‡³ğŸ‡®',
        };
        for (const [key, emoji] of Object.entries(map)) { if (lower.includes(key)) return emoji; }
        return null;
    };
    
    const getRoastAge = (dateStr) => {
        if (!dateStr) return null;
        const now = new Date();
        const [y, m, d] = dateStr.split('-').map(Number);
        const roast = new Date(y, m - 1, d);
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const diff = Math.floor((today - roast) / (86400000));
        return diff >= 0 ? `+${diff}` : `${diff}`;
    };

    const DEMO_IMG_1 = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNmM2Y0ZjYiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg1MCA1MCkiPjxnIGZpbGw9IiNGRkYiIHN0cm9rZT0iI0QxRDVEQiIgc3Ryb2tlLXdpZHRoPSIyIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjMwIiByPSIxMiIvPjxjaXJjbGUgY3g9IjY5IiBjeT0iNDMiIHI9IjEyIi8+PGNpcmNsZSBjeD0iNjIiIGN5PSI2NSIgcj0iMTIiLz48Y2lyY2xlIGN4PSIzOCIgY3k9IjY1IiByPSIxMiIvPjxjaXJjbGUgY3g9IjMxIiBjeT0iNDMiIHI9IjEyIi8+PC9nPjxjaXJjbGUgY3g9IjUwIiBjeT0iNTAiIHI9IjEwIiBmaWxsPSIjRkJCRjI0Ii8+PC9nPjwvc3ZnPg==';
    const DEMO_IMG_2 = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIyMDAiIGZpbGw9IiNmM2Y0ZjYiLz48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMDAgMTAwKSIgc3Ryb2tlPSIjRkJCRjI0IiBzdHJva2Utd2lkdGg9IjgiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PGNpcmNsZSBjeD0iMCIgY3k9IjAiIHI9IjMwIiBmaWxsPSIjRkJCRjI0IiBzdHJva2U9Im5vbmUiLz48bGluZSB4MT0iMCIgeTE9Ii00MCIgeDI9IjAiIHkyPSItNTUiIC8+PGxpbmUgeDE9IjAiIHkxPSI0MCIgeDI9IjAiIHkyPSI1NSIgLz48bGluZSB4MT0iLTQwIiB5MT0iMCIgeDI9Ii01NSIgeTI9IjAiIC8+PGxpbmUgeDE9IjQwIiB5MT0iMCIgeDI9IjU1IiB5Mj0iMCIgLz48bGluZSB4MT0iLTI4LjI4IiB5MT0iLTI4LjI4IiB4Mj0iLTM4Ljg5IiB5Mj0iLTM4Ljg5IiAvPjxsaW5lIHgxPSIyOC4yOCIgeTE9IjI4LjI4IiB4Mj0iMzguODkiIHkyPSIzOC44OSIgLz48bGluZSB4MT0iLTI4LjI4IiB5MT0iMjguMjgiIHgyPSItMzguODkiIHkyPSIzOC44OSIgLz48bGluZSB4MT0iMjguMjgiIHkxPSItMjguMjgiIHgyPSIzOC44OSIgeTI9Ii0zOC44OSIgLz48L2c+PC9zdmc+';

    const getDemoData = () => {
        const now = new Date();
        const d = (days) => new Date(now.getTime() - days * 86400000).toISOString().split('T')[0];
        
        return [
            {
                id: `demo_${Date.now() + 1}`, name: "ì—í‹°ì˜¤í”¼ì•„ ì˜ˆê°€ì²´í”„ G1", country: "ì—í‹°ì˜¤í”¼ì•„", region: "ì˜ˆê°€ì²´í”„", variety: "Heirloom", processing: "Washed", altitude: "1900-2200m", roastingLevel: "Light", producer: "", roastingDate: d(15), purchaseDate: d(10), shop: "ë°ëª¨ ì»¤í”¼ ë¡œìŠ¤í„°ìŠ¤", purchaseUrl: "", weight: "200", price: "22000", pricePerCup: "", notes: "ììŠ¤ë¯¼, ë² ë¥´ê°€ëª», ë³µìˆ­ì•„, ê¿€", flavorDesc: "ê½ƒí–¥ê¸°ì™€ í•¨ê»˜ ìƒí¼í•œ ê³¼ì¼ì˜ ì‚°ë¯¸ê°€ ë§¤ë ¥ì ì…ë‹ˆë‹¤.", memo: "í•¸ë“œë“œë¦½ìœ¼ë¡œ ë‚´ë ¸ì„ ë•Œ ê°€ì¥ ë§›ì´ ì¢‹ì•˜ìŒ.", isFinished: false, isBlend: false, blendInfo: [], mainImage: DEMO_IMG_1,
                tastings: [{ date: d(5), scores: { acidity: 8.5, balance: 8.0, sweetness: 8.2, cleanCup: 8.5, body: 7.5, flavor: 8.8 }, isManualTotal: false, totalScore: 0, notes: "ììŠ¤ë¯¼, ë ˆëª¬, ë³µìˆ­ì•„", desc: "í–¥ì´ í­ë°œì ì´ë‹¤. ì‚°ë¯¸ê°€ ê¸°ë¶„ ì¢‹ê²Œ ëŠê»´ì§„ë‹¤.", memo: "í•˜ë¦¬ì˜¤ V60 / 93ë„ / 1:16 ë¹„ìœ¨" }]
            },
            {
                id: `demo_${Date.now() + 2}`, name: "í•˜ìš°ìŠ¤ ë¸”ë Œë“œ 'ì„ ìƒ¤ì¸'", country: "", region: "", variety: "", processing: "", altitude: "", roastingLevel: "Medium", producer: "", roastingDate: d(25), purchaseDate: d(20), shop: "ë°ëª¨ ì»¤í”¼ ë¡œìŠ¤í„°ìŠ¤", purchaseUrl: "", weight: "500", price: "35000", pricePerCup: "", notes: "ê²¬ê³¼ë¥˜, ë‹¤í¬ ì´ˆì½œë¦¿, ì¢‹ì€ ë°¸ëŸ°ìŠ¤", flavorDesc: "ë§¤ì¼ ë§ˆì‹œê¸° ì¢‹ì€ ê³ ì†Œí•˜ê³  ê· í˜•ì¡íŒ ì»¤í”¼.", memo: "", isFinished: true, isBlend: true, blendInfo: [{ country: "ë¸Œë¼ì§ˆ", variety: "Catuai", ratio: "60" }, { country: "ì½œë¡¬ë¹„ì•„", variety: "Castillo", ratio: "40" }], mainImage: DEMO_IMG_2,
                tastings: [{ date: d(15), scores: { acidity: 7.0, balance: 8.5, sweetness: 7.8, cleanCup: 8.0, body: 8.2, flavor: 7.5 }, isManualTotal: false, totalScore: 0, notes: "ì•„ëª¬ë“œ, ì´ˆì½œë¦¿, ì¹´ë¼ë©œ", desc: "ê³ ì†Œí•¨ì´ ì§€ë°°ì ì´ë©°, ì‹ì—ˆì„ ë•Œ ë‹¨ë§›ì´ ì˜¬ë¼ì˜¨ë‹¤.", memo: "ìë™ ë¨¸ì‹ ìœ¼ë¡œ ì¶”ì¶œ" }]
            },
            {
                id: `demo_${Date.now() + 3}`, name: "ìŠ¤íƒ€ë²…ìŠ¤ ì˜¤ëŠ˜ì˜ ì»¤í”¼", shop: "ìŠ¤íƒ€ë²…ìŠ¤", pricePerCup: "4200", weight: "", purchaseDate: d(2), notes: "ë¬´ë‚œí•œ ë§›, ì•½ê°„ì˜ ìŠ¤ëª¨í‚¤í•¨", isFinished: false, isBlend: true,
                tastings: [{ date: d(2), scores: { acidity: 6.5, balance: 7.0, sweetness: 6.5, cleanCup: 7.0, body: 7.5, flavor: 6.5 }, isManualTotal: true, totalScore: "7.0", notes: "ìŠ¤ëª¨í‚¤, íƒ„ë§›", desc: "ì§„í•˜ê³  ë¬´ë‚œí•œ ë§›.", memo: "" }]
            },
            {
                id: `demo_${Date.now() + 4}`, name: "ë¸”ë£¨ë³´í‹€ ë†€ë¼ í”Œë¡œíŠ¸", shop: "ë¸”ë£¨ë³´í‹€", pricePerCup: "7500", weight: "", purchaseDate: d(1), notes: "ë‹¬ì½¤í•œ ë¼ë–¼, ì•„ì´ìŠ¤í¬ë¦¼", isFinished: false, isBlend: true,
                tastings: []
            }
        ];
    };

    // --- 2. GLOBAL COMPONENTS (Defined at top) ---

    const FontLoader = () => {
        useEffect(() => {
          const fontUrl = 'https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Noto+Sans+KR:wght@400;500;700;900&family=Roboto+Mono:wght@500;700&display=swap';
          fetch(fontUrl)
            .then(res => res.text())
            .then(css => {
              const style = document.createElement('style');
              style.textContent = css;
              document.head.appendChild(style);
              document.documentElement.classList.add('font-loaded');
            })
            .catch(e => console.log('Font load skipped:', e));
        }, []);
        return null;
    };

    // --- Global Components ---
    /* ================================================================
       [DO NOT MODIFY START] CustomBeanIcon (Restored from v1.8.1 - Exact Match)
       !!! CRITICAL: Do not summarize or change path data !!!
    ================================================================ */
    const CustomBeanIcon = ({ size = 24, className = "" }) => (
      <svg 
        width={size} 
        height={size} 
        viewBox="212 184 600 600" 
        className={className}
        xmlns="http://www.w3.org/2000/svg"
        version="1.1"
        style={{ shapeRendering: "geometricPrecision", textRendering: "geometricPrecision", imageRendering: "optimizeQuality", fillRule: "evenodd", clipRule: "evenodd" }}
      >
        <g className="fill-current" stroke="currentColor" strokeWidth="20" strokeLinejoin="round" strokeLinecap="round">
            <path fillOpacity="0.9" d="M 606.5,191.5 C 626.3,189.9 645.6,192.1 664.5,198C 675.1,200.9 679.6,207.8 678,218.5C 673.5,239.2 662,254.5 643.5,264.5C 641.1,262.9 641.1,261.4 643.5,260C 642.4,258.6 641.1,257.6 639.5,257C 642.3,254.8 642,253.3 638.5,252.5C 653.5,243.8 662,230.8 664,213.5C 656.9,208.9 649.1,206.4 640.5,206C 628.2,204.8 615.9,204.3 603.5,204.5C 604.3,203.6 606,203.1 608.5,203C 605.1,202.8 601.8,202.3 598.5,201.5C 599.2,198.6 600.5,196.1 602.5,194C 601.5,193.7 600.5,193.3 599.5,193C 602,192.8 604.4,192.3 606.5,191.5 Z"/>
            <path fillOpacity="0.8" d="M 708.5,221.5 C 732.2,236 749.7,256 761,281.5C 773.9,310.9 780.4,341.8 780.5,374C 780.4,399.5 777.7,424.7 772.5,449.5C 768.5,441.6 765.5,433.2 763.5,424.5C 771.2,379 767,334.6 751,291.5C 741.7,269.9 727.9,251.9 709.5,237.5C 712.1,237.3 712.1,236.8 709.5,236C 710.8,230.9 709.5,226.6 705.5,223C 706.7,222.8 707.7,222.3 708.5,221.5 Z"/>
            <path fillOpacity="1.0" d="M 638.5,252.5 C 642,253.3 642.3,254.8 639.5,257C 641.1,257.6 642.4,258.6 643.5,260C 641.1,261.4 641.1,262.9 643.5,264.5C 630.7,271.7 618.1,279.2 605.5,287C 591.7,296.9 579.1,308.1 567.5,320.5C 563.5,318.7 559.7,318.7 556,320.5C 554.7,319.1 554.2,317.4 554.5,315.5C 560.9,307.6 567.9,300.1 575.5,293C 594.8,276.9 615.8,263.4 638.5,252.5 Z"/>
            <path fillOpacity="0.8" d="M 606.5,191.5 C 604.4,192.3 602,192.8 599.5,193C 600.5,193.3 601.5,193.7 602.5,194C 600.5,196.1 599.2,198.6 598.5,201.5C 601.8,202.3 605.1,202.8 608.5,203C 606,203.1 604.3,203.6 603.5,204.5C 591.2,206.3 578.8,208.8 566.5,212C 529.9,223.1 496.3,239.8 465.5,262C 411.7,302.1 368.2,351.3 335,409.5C 310.1,452.9 293.6,499.2 285.5,548.5C 284.8,551.2 284.2,553.8 283.5,556.5C 282.7,557 282,558.3 281.5,560.5C 280.7,559.6 280.2,558.6 280,557.5C 279.7,558.3 279.2,559 278.5,559.5C 276.6,559.1 275.1,558.1 274,556.5C 273.7,557.2 273.3,557.8 273,558.5C 272.8,556.3 272.3,554.3 271.5,552.5C 276.3,515 286.4,479 302,444.5C 343,354.6 405.2,283.4 488.5,231C 515.5,215.2 544.1,203.6 574.5,196C 585,193.5 595.7,192 606.5,191.5 Z"/>
            <path fillOpacity="0.9" d="M 554.5,315.5 C 554.2,317.4 554.7,319.1 556,320.5C 559.7,318.7 563.5,318.7 567.5,320.5C 528.7,366.6 506.6,420 501,480.5C 491.1,533.4 469.1,580.4 435,621.5C 428.2,628.3 421.3,635.2 414.5,642C 407.2,648 399.5,653.5 391.5,658.5C 391.2,657 390.2,656.3 388.5,656.5C 387.7,651.4 384.7,649.4 379.5,650.5C 389.2,644.3 398.5,637.5 407.5,630C 433.2,606 453,577.8 467,545.5C 480.9,510.7 489.9,474.7 494,437.5C 504.4,391.7 524.6,351 554.5,315.5 Z"/>
            <path d="M 763.5,424.5 C 765.5,433.2 768.5,441.6 772.5,449.5C 748.4,553.2 695.8,639 614.5,707C 576.4,737.9 533.4,759.6 485.5,772C 474.2,774.2 462.9,776 451.5,777.5C 452.6,776.7 453.9,776.2 455.5,776C 452.2,775.7 448.8,775.3 445.5,775C 443.7,772.8 441.7,770.8 439.5,769C 443.5,766.7 447.8,765.3 452.5,765C 450.2,764.5 447.9,764.3 445.5,764.5C 445.5,764.2 445.5,763.8 445.5,763.5C 461.7,762.6 477.7,760.1 493.5,756C 533.4,743.5 569.8,724.5 602.5,699C 684.1,632.5 736.4,547.7 759.5,444.5C 760.9,442.5 761.6,440.2 761.5,437.5C 761.8,433 762.4,428.6 763.5,424.5 Z"/>
            <path d="M 271.5,552.5 C 272.3,554.3 272.8,556.3 273,558.5C 273.3,557.8 273.7,557.2 274,556.5C 275.1,558.1 276.6,559.1 278.5,559.5C 279.2,559 279.7,558.3 280,557.5C 280.2,558.6 280.7,559.6 281.5,560.5C 282,558.3 282.7,557 283.5,556.5C 283.5,559.5 283.5,562.5 283.5,565.5C 280.6,594.5 282.8,623.2 290,651.5C 295.9,673.2 306.4,692.2 321.5,708.5C 319.9,708.5 318.2,708.5 316.5,708.5C 314,709.7 314,710.9 316.5,712C 314,714.2 314.3,716.2 317.5,718C 316.7,719.6 317.3,720.6 319.5,721C 318.6,721.3 317.9,721.8 317.5,722.5C 298.3,704.7 285.1,683.1 278,657.5C 268.3,622.8 266.2,587.8 271.5,552.5 Z"/>
            <path fillOpacity="1.0" d="M 708.5,221.5 C 707.7,222.3 706.7,222.8 705.5,223C 709.5,226.6 710.8,230.9 709.5,236C 712.1,236.8 712.1,237.3 709.5,237.5C 708,236.7 706.7,236.7 705.5,237.5C 699.6,253.4 690.6,267.2 678.5,279C 664.2,289.5 649.5,299.5 634.5,309C 590.3,346.8 562.2,394.3 550,451.5C 546,481.8 539.3,511.5 530,540.5C 504.3,613.9 456.4,667.4 386.5,701C 373.4,709.9 365.4,722.1 362.5,737.5C 363,741.8 365,745.3 368.5,748C 380.6,756.1 393.9,760.9 408.5,762.5C 411.3,763.3 414.3,763.8 417.5,764C 426.8,764.5 436.1,764.6 445.5,764.5C 447.9,764.3 450.1,764.5 452.5,765C 447.8,765.3 443.5,766.6 439.5,769C 441.7,770.8 443.7,772.8 445.5,775C 448.8,775.3 452.1,775.6 455.5,776C 453.9,776.2 452.6,776.7 451.5,777.5C 422.4,780.6 394.8,776.1 368.5,764C 350.4,755.3 344.9,741.4 352,722.5C 359.2,707.2 370.1,695 384.5,686C 446.4,656.0 489.5,608.9 514,544.5C 519.5,529.1 524.2,513.4 528,497.5C 531.7,473.6 536.4,449.9 542,426.5C 557.4,375.6 585.3,333.1 625.5,299C 636.6,290.5 648.3,282.9 660.5,276C 678.3,262.5 690.3,245 696.5,223.5C 700,220.3 704,219.7 708.5,221.5 Z"/>
            <path fillOpacity="1.0" d="M 379.5,650.5 C 384.7,649.3 387.7,651.3 388.5,656.5C 390.1,656.2 391.1,656.9 391.5,658.5C 377.8,665.8 365.3,674.8 354,685.5C 343.7,697 336.2,710.2 331.5,725C 326.2,727.4 321.5,726.6 317.5,722.5C 317.9,721.7 318.5,721.2 319.5,721C 317.3,720.5 316.6,719.5 317.5,718C 314.3,716.1 313.9,714.1 316.5,712C 313.9,710.9 313.9,709.7 316.5,708.5C 318.1,708.5 319.8,708.5 321.5,708.5C 322.3,709.5 323.2,709.5 324,708.5C 335.1,682.1 353.6,662.8 379.5,650.5 Z"/>
        </g>
        <g fill="white" fillOpacity="0.3"><path d="M 603.5,204.5 C 615.9,204.3 628.2,204.8 640.5,206C 649.1,206.4 656.9,208.9 664,213.5C 662,230.8 653.5,243.8 638.5,252.5C 615.8,263.4 594.8,276.9 575.5,293C 567.9,300.1 560.9,307.6 554.5,315.5C 524.6,351 504.4,391.7 494,437.5C 489.9,474.7 480.9,510.7 467,545.5C 453,577.8 433.2,606 407.5,630C 398.5,637.5 389.2,644.3 379.5,650.5C 353.7,662.8 335.2,682.2 324,708.5C 323.2,709.6 322.4,709.6 321.5,708.5C 306.4,692.2 295.9,673.2 290,651.5C 282.8,623.2 280.6,594.5 283.5,565.5C 284.9,560.1 285.6,554.4 285.5,548.5C 293.6,499.2 310.1,452.9 335,409.5C 368.2,351.3 411.7,302.1 465.5,262C 496.3,239.8 529.9,223.1 566.5,212C 578.8,208.8 591.2,206.3 603.5,204.5 Z"/></g>
      </svg>
    );
    /* [DO NOT MODIFY END] */

    const useLongPress = (callback = () => {}, speed = 100, delay = 400) => {
      const timerRef = useRef(null); 
      const delayRef = useRef(null); 
      const isTouchRef = useRef(false);
      const start = useCallback((event) => {
        if (event.type === 'touchstart') isTouchRef.current = true;
        else if (event.type === 'mousedown' && isTouchRef.current) return;
        callback(); 
        delayRef.current = setTimeout(() => { timerRef.current = setInterval(callback, speed); }, delay);
      }, [callback, speed, delay]);
      const stop = useCallback(() => {
        if (delayRef.current) clearTimeout(delayRef.current);
        if (timerRef.current) clearInterval(timerRef.current);
        delayRef.current = null; timerRef.current = null;
        setTimeout(() => { isTouchRef.current = false; }, 500);
      }, []);
      return { onMouseDown: start, onMouseUp: stop, onMouseLeave: stop, onTouchStart: (e) => { if(e.cancelable) e.preventDefault(); start(e); }, onTouchEnd: stop };
    };

    const ScoreButton = ({ onClick, icon: Icon }) => {
      const longPressProps = useLongPress(onClick, 80, 400); 
      return <button {...longPressProps} className="w-8 h-8 bg-white rounded-full shadow border flex items-center justify-center active:scale-95 transition-transform no-select">{Icon}</button>;
    };

    const ScoreButtonPlus = ({ onClick, icon: Icon }) => {
      const longPressProps = useLongPress(onClick, 80, 400); 
      return <button {...longPressProps} className="w-8 h-8 bg-slate-900 rounded-full shadow flex items-center justify-center active:scale-95 transition-transform no-select">{Icon}</button>;
    };

    const AccurateRadarChart = ({ scores }) => {
      const size = 100, center = size / 2, radius = size * 0.45;
      const keys = ['acidity', 'balance', 'sweetness', 'cleanCup', 'body', 'flavor'];
      const labels = ['ì‚°ë¯¸', 'ë°¸ëŸ°ìŠ¤', 'ë‹¨ë§›', 'í´ë¦°ì»µ', 'ë°”ë””', 'í–¥ë¯¸'];
      const getPoint = (value, index) => { const angle = (Math.PI * 2 * index) / 6 - Math.PI / 2; const val = parseFloat(value) || 0; const r = (val / 10) * radius; return `${center + r * Math.cos(angle)},${center + r * Math.sin(angle)}`; };
      const gridLevels = [10, 8, 6, 4, 2];
      const bgPoints = gridLevels.map(scale => keys.map((_, i) => getPoint(scale, i)).join(' '));
      const dataPoints = keys.map((key, i) => getPoint(scores[key], i)).join(' ');
      const labelCoords = keys.map((_, i) => { const angle = (Math.PI * 2 * i) / 6 - Math.PI / 2; const r = radius + 12; return { x: center + r * Math.cos(angle), y: center + r * Math.sin(angle), text: labels[i] }; });
      return (
        <svg width="100%" height="100%" viewBox={`0 0 ${size} ${size}`} className="overflow-visible font-capture">
          {bgPoints.map((pts, i) => <polygon key={i} points={pts} fill="none" stroke="#e2e8f0" strokeWidth={i === 0 ? "0.8" : "0.5"} />)}
          {keys.map((_, i) => { const end = getPoint(10, i).split(','); return <line key={i} x1={center} y1={center} x2={end[0]} y2={end[1]} stroke="#e2e8f0" strokeWidth="0.8" /> })}
          <polygon points={dataPoints} fill="rgba(120, 53, 15, 0.3)" stroke="#78350f" strokeWidth="1.5" />
          {labelCoords.map((l, i) => <text key={i} x={l.x} y={l.y} textAnchor="middle" dominantBaseline="middle" fontSize="8" fill="#64748b" fontWeight="bold">{l.text}</text>)}
        </svg>
      );
    };

    const RadarChart = ({ scores }) => {
        const size=120, center=size/2, radius=size*0.4;
        const pts = TASTE_ITEMS.map((item, i) => { const angle = (Math.PI*2*i)/6 - Math.PI/2; const val = parseFloat(scores[item.id])||0; return `${center + (val/10)*radius * Math.cos(angle)},${center + (val/10)*radius * Math.sin(angle)}`; }).join(' ');
        return <svg width={size} height={size} className="overflow-visible">{[1,2,3,4,5].map(s=><polygon key={s} points={TASTE_ITEMS.map((_,i)=>{const a=(Math.PI*2*i)/6-Math.PI/2;const r=(s/5)*radius;return`${center+r*Math.cos(a)},${center+r*Math.sin(a)}`;}).join(' ')} fill="none" stroke="#e2e8f0" strokeWidth="1"/>)}<polygon points={pts} fill="rgba(120, 53, 15, 0.3)" stroke="#78350f" strokeWidth="2"/>{TASTE_ITEMS.map((t,i)=><text key={i} x={center+(radius+15)*Math.cos((Math.PI*2*i)/6-Math.PI/2)} y={center+(radius+15)*Math.sin((Math.PI*2*i)/6-Math.PI/2)} textAnchor="middle" dominantBaseline="middle" fontSize="9" fontWeight="bold" fill="#475569">{t.label}</text>)}</svg>;
    };

    const ImageCropper = ({ imageSrc, aspectRatio, onComplete, onCancel }) => {
      const imageRef = useRef(null);
      const cropperRef = useRef(null);

      useLayoutEffect(() => {
        if (imageRef.current) {
          cropperRef.current = new Cropper(imageRef.current, {
            aspectRatio: aspectRatio,
            viewMode: 1,
            autoCropArea: 0.9,
            background: false,
            guides: true,
            rotatable: true,
          });
        }
        return () => {
          if (cropperRef.current) {
            cropperRef.current.destroy();
          }
        };
      }, [imageSrc, aspectRatio]);

      const handleCrop = () => {
        if (cropperRef.current) {
          const canvas = cropperRef.current.getCroppedCanvas({ width: 800, height: 800 });
          if (canvas) {
            onComplete(canvas.toDataURL('image/jpeg', 0.85));
          }
        }
      };

      return (
        <div className="fixed inset-0 z-[60] bg-black/90 flex flex-col animate-in fade-in">
          <div className="flex-1 relative bg-black flex items-center justify-center p-4 overflow-hidden">
             <img ref={imageRef} src={imageSrc} alt="Crop" style={{ maxWidth: '100%', maxHeight: '80vh', opacity: 0 }} />
          </div>
          <div className="p-5 bg-slate-900 flex justify-between gap-4">
             <button onClick={onCancel} className="flex-1 py-3 bg-slate-800 text-white rounded-xl font-bold">ì·¨ì†Œ</button>
             <button onClick={handleCrop} className="flex-1 py-3 bg-white text-slate-900 rounded-xl font-bold">ì™„ë£Œ</button>
          </div>
        </div>
      );
    };

    const FlavorPicker = ({ onClose, onConfirm, initialNotes = "" }) => {
        const [activeTab, setActiveTab] = useState('fruity');
        const [selectedNotes, setSelectedNotes] = useState(parseTags(initialNotes));
        const toggleNote = (note) => setSelectedNotes(selectedNotes.includes(note) ? selectedNotes.filter(n => n !== note) : [...selectedNotes, note]);
        const activeCategory = FLAVOR_DATA.find(d => d.id === activeTab);
        return (
            <div className="fixed inset-0 z-50 bg-black/50 flex items-end sm:items-center justify-center animate-in fade-in backdrop-blur-sm dark:bg-black/70" onClick={onClose}>
                <div className="w-full max-w-md h-[85vh] sm:h-[700px] bg-white dark:bg-slate-900 sm:rounded-[32px] rounded-t-[32px] shadow-2xl flex flex-col relative animate-slide-up overflow-hidden font-sans" onClick={e=>e.stopPropagation()}>
                    <div className="p-5 pb-2 flex justify-between items-center bg-white dark:bg-slate-900 z-10 shrink-0"><div><h2 className="text-xl font-black text-slate-900 dark:text-white flex items-center gap-2"><Palette size={20} className="text-indigo-500"/> Flavor Picker</h2><p className="text-xs text-slate-400 mt-1">ì›í•˜ëŠ” ë§›ì„ í„°ì¹˜í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”.</p></div><button onClick={onClose} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700"><X size={20}/></button></div>
                    <div className="border-b border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 shrink-0"><div className="flex overflow-x-auto no-scrollbar px-5 gap-2 pb-3 pt-1">{FLAVOR_DATA.map((cat) => (<button key={cat.id} onClick={() => setActiveTab(cat.id)} className={`whitespace-nowrap px-3.5 py-1.5 rounded-full text-xs font-bold transition-all ${activeTab === cat.id ? `${cat.color} text-white shadow-md scale-105` : 'bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700'}`}>{cat.label.split(' ')[0]}</button>))}</div></div>
                    <div className={`flex-1 overflow-y-auto p-5 pb-32 transition-colors duration-300 ${activeCategory.bg}`}>{activeCategory.subs.map((sub, idx) => (<div key={idx} className="mb-6 animate-pop" style={{ animationDelay: `${idx * 50}ms` }}><h3 className={`text-xs font-bold ${activeCategory.text} uppercase mb-2 ml-1 opacity-80 flex items-center gap-1`}><span className="w-1.5 h-1.5 rounded-full bg-current"></span> {sub.group}</h3><div className="flex flex-wrap gap-2">{sub.items.map((item) => { const isSelected = selectedNotes.includes(item); return (<button key={item} onClick={() => toggleNote(item)} className={`px-3 py-2 rounded-xl text-xs font-bold border-2 transition-all ${isSelected ? 'bg-slate-800 border-slate-800 text-white shadow-md scale-105' : 'bg-white border-transparent text-slate-600 hover:border-slate-200'}`}>{item}</button>) })}</div></div>))}</div>
                    <div className="absolute bottom-0 left-0 right-0 bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800 p-5 z-20 pb-8 sm:pb-5 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]"><div className="flex overflow-x-auto no-scrollbar gap-2 mb-4 pb-1 min-h-[30px] items-center">{selectedNotes.length > 0 ? selectedNotes.map(note => (<span key={note} className="whitespace-nowrap px-3 py-1 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 rounded-lg text-xs font-bold flex items-center gap-1 border border-slate-200 dark:border-slate-700 animate-pop">{note} <button onClick={() => toggleNote(note)}><X size={10} className="text-slate-400 hover:text-red-500"/></button></span>)) : <span className="text-xs text-slate-400">ì„ íƒëœ ë§›ì´ ì—†ìŠµë‹ˆë‹¤.</span>}</div><button onClick={() => onConfirm(selectedNotes.join(', '))} className="w-full bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2 hover:bg-slate-800 dark:hover:bg-slate-200"><Check size={18}/> {selectedNotes.length}ê°œ ì„ íƒ ì™„ë£Œ</button></div>
                </div>
            </div>
        );
    };
    
    const ShareModal = ({ bean, tasting, onClose }) => {
        const cardRef = useRef(null); const [generatedImg, setGeneratedImg] = useState(null); const [isGenerating, setIsGenerating] = useState(true);
        const totalScore = getDisplayScore(tasting); const beanTags = parseTags(bean.notes); const tastingTags = parseTags(tasting.notes);
        const specs = [{ label: "Region", value: bean.region, icon: <MapPin size={8}/> }, { label: "Process", value: bean.processing, icon: <Layers size={8}/> }, { label: "Roast", value: bean.roastingLevel, icon: <Flame size={8}/> }, { label: "Variety", value: bean.variety, icon: <Tag size={8}/> }].filter(s => s.value);
        useEffect(() => { const generate = async () => { await new Promise(r => setTimeout(r, 800)); if(cardRef.current) { try { const blob = await htmlToImage.toBlob(cardRef.current, { quality: 0.95, backgroundColor: '#ffffff', skipAutoScale: true, pixelRatio: 2, filter: (n) => n.tagName !== 'LINK' }); if (blob) { setGeneratedImg(URL.createObjectURL(blob)); } } catch(e) { console.error(e); } finally { setIsGenerating(false); } } }; generate(); }, []);
        const handleDownload = () => { if (generatedImg) { const link = document.createElement('a'); link.download = `BeanLog_${bean.name}_${tasting.date}.jpg`; link.href = generatedImg; link.click(); } };
        return (
            <div className="fixed inset-0 z-[60] bg-black/90 flex flex-col items-center justify-center p-4 animate-in fade-in">
                <div className="fixed top-0 left-[-9999px]"><div ref={cardRef} className="w-[320px] bg-white rounded-sm shadow-2xl overflow-hidden font-capture text-slate-800"><div className="relative h-60 bg-slate-200">{bean.mainImage ? (<div className="absolute inset-0 bg-cover bg-center" style={{ backgroundImage: `url(${bean.mainImage})` }} />) : (<div className="absolute inset-0 flex items-center justify-center text-slate-400"><CustomBeanIcon size={128} className="opacity-50"/></div>)}<div className="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div><div className="absolute bottom-0 left-0 right-0 p-5 text-white z-10"><div className="flex items-center justify-between mb-2 opacity-100 items-start"><span className="text-[10px] font-black text-white font-capture whitespace-nowrap drop-shadow-md truncate max-w-[70%]">{bean.shop || "Home Cafe"}</span><div className="flex flex-col items-end drop-shadow-md">{bean.roastingDate && <span className="text-[8px] font-medium opacity-90 mb-0.5 whitespace-nowrap">Roast: {bean.roastingDate}</span>}<span className="text-[10px] font-bold opacity-100 whitespace-nowrap">Taste: {tasting.date}</span></div></div><h1 className="text-lg font-black leading-snug mb-1 line-clamp-2 drop-shadow-md font-capture">{bean.name}</h1><p className="text-xs font-bold text-amber-400 mb-3 whitespace-nowrap">{bean.country}</p><div className="flex flex-wrap gap-1.5">{specs.map((s, i) => (<span key={i} className="inline-flex items-center gap-1 px-1.5 h-[18px] rounded bg-black/40 border border-white/20 text-[9px] font-medium text-slate-100"><span className="opacity-70 flex items-center">{s.icon}</span> <span className="leading-none pt-[1.5px] whitespace-nowrap">{s.value}</span></span>))}</div></div></div><div className="p-5 flex flex-col gap-4 bg-white"><div className="grid grid-cols-1 gap-3">{beanTags.length > 0 && (<div className="flex items-start gap-3"><span className="h-[20px] flex items-center justify-center text-[9px] font-black text-amber-700 bg-amber-50 px-2 rounded border border-amber-100 w-14 shrink-0 pt-[1px] gap-1"><CustomBeanIcon size={10} /> BEAN</span><p className="text-xs font-medium text-slate-600 leading-relaxed pt-[1px]">{beanTags.join(', ')}</p></div>)}{tastingTags.length > 0 && (<div className="flex items-start gap-3"><span className="h-[20px] flex items-center justify-center text-[9px] font-black text-blue-700 bg-blue-50 px-2 rounded border border-blue-100 w-14 shrink-0 pt-[1px] gap-1"><Coffee size={10} /> TASTE</span><p className="text-xs font-medium text-slate-600 leading-relaxed pt-[1px]">{tastingTags.join(', ')}</p></div>)}</div><div className="space-y-2 pt-2 border-t border-dashed border-slate-100">{tasting.desc && (<p className="text-xs text-slate-700 font-medium leading-relaxed"><Quote size={12} className="inline text-slate-300 mr-1 -mt-1"/>{tasting.desc}</p>)}{(tasting.memo || bean.memo) && (<div className="flex gap-2 items-start"><StickyNote size={12} className="text-slate-400 shrink-0 mt-0.5"/><div className="text-[10px] text-slate-500 font-medium leading-snug whitespace-pre-wrap">{tasting.memo || bean.memo}</div></div>)}</div></div><div className="bg-slate-50 border-t border-slate-100 p-4 px-5 flex items-center justify-between gap-3"><div className="flex flex-col shrink-0 items-center justify-center"><span className="text-[8px] font-bold text-slate-400 uppercase tracking-widest mb-0.5">Total</span><span className="text-4xl font-black text-slate-900 tracking-tighter leading-none font-capture">{totalScore}</span></div><div className="flex-1 grid grid-cols-2 gap-x-3 text-[9px] text-slate-500 font-bold border-l border-slate-200 pl-4">{Object.entries(tasting.scores).map(([k,v])=><div key={k} className="flex justify-between w-full items-end"><span>{SCORE_LABELS_KO[k]}</span><span className="dot-line"></span><span className="text-slate-900 text-[10px] font-black">{Number(v).toFixed(1)}</span></div>)}</div><div className="w-[70px] h-[70px] shrink-0"><AccurateRadarChart scores={tasting.scores} /></div></div><div className="bg-slate-900 text-white text-center py-2"><p className="text-[8px] font-bold tracking-[0.2em] uppercase opacity-60 font-brand">Recorded with BeanLog</p></div></div></div>
                <div className="flex flex-col items-center gap-6">{isGenerating ? (<div className="flex flex-col items-center text-white gap-2"><div className="loader-white"></div><span className="text-xs">ì¹´ë“œ ë§Œë“œëŠ” ì¤‘...</span></div>) : (<div className="flex flex-col items-center animate-in zoom-in-95 duration-300"><img src={generatedImg} className="w-[300px] rounded-lg shadow-2xl mb-4" alt="Review Card" /><p className="text-white text-sm font-bold animate-pulse">ğŸ‘† ì´ë¯¸ì§€ë¥¼ ê¾¹ ëˆŒëŸ¬ ì €ì¥í•˜ì„¸ìš”</p></div>)}<button onClick={onClose} className="bg-white/20 text-white px-8 py-3 rounded-full font-bold backdrop-blur-sm hover:bg-white/30 transition-colors">ë‹«ê¸°</button>{generatedImg && (<button onClick={handleDownload} className="text-white/60 text-xs hover:text-white underline">ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ìœ¼ë¡œ ì €ì¥í•˜ê¸°</button>)}</div>
            </div>
        );
    };

    const BeanShareModal = ({ bean, onClose }) => {
        const cardRef = useRef(null); const [generatedImg, setGeneratedImg] = useState(null); const [isGenerating, setIsGenerating] = useState(true);
        const beanTags = parseTags(bean.notes);
        const specs = [{ label: "Region", value: bean.region, icon: <MapPin size={8}/> }, { label: "Variety", value: bean.variety, icon: <Tag size={8}/> }, { label: "Process", value: bean.processing, icon: <Layers size={8}/> }, { label: "Altitude", value: bean.altitude, icon: <Mountain size={8}/> }, { label: "Producer", value: bean.producer, icon: <User size={8}/> }, { label: "Roast", value: bean.roastingLevel, icon: <Flame size={8}/> }].filter(s => s.value);
        useEffect(() => { const generate = async () => { await new Promise(r => setTimeout(r, 800)); if(cardRef.current) { try { const blob = await htmlToImage.toBlob(cardRef.current, { quality: 0.95, backgroundColor: '#ffffff', skipAutoScale: true, pixelRatio: 2, filter: (n) => n.tagName !== 'LINK' }); if (blob) { setGeneratedImg(URL.createObjectURL(blob)); } } catch(e) { console.error(e); } finally { setIsGenerating(false); } } }; generate(); }, []);
        const handleDownload = () => { if (generatedImg) { const link = document.createElement('a'); link.download = `BeanLog_Bean_${bean.name}.jpg`; link.href = generatedImg; link.click(); } };
        return (
            <div className="fixed inset-0 z-[60] bg-black/90 flex flex-col items-center justify-center p-4 animate-in fade-in">
                <div className="fixed top-0 left-[-9999px]"><div ref={cardRef} className="w-[320px] bg-white rounded-sm shadow-2xl overflow-hidden font-capture text-slate-800"><div className="relative h-64 bg-slate-200">{bean.mainImage ? (<div className="absolute inset-0 bg-cover bg-center" style={{ backgroundImage: `url(${bean.mainImage})` }} />) : (<div className="absolute inset-0 flex items-center justify-center text-slate-400"><CustomBeanIcon size={128} className="opacity-50"/></div>)}<div className="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div><div className="absolute bottom-0 left-0 right-0 p-5 text-white z-10"><div className="flex items-center justify-between mb-2 opacity-100 items-start"><span className="text-[10px] font-black text-white font-capture whitespace-nowrap drop-shadow-md truncate max-w-[70%]">{bean.shop || "Home Cafe"}</span><div className="flex flex-col items-end drop-shadow-md">{bean.roastingDate && <span className="text-[8px] font-medium opacity-90 mb-0.5 whitespace-nowrap">Roast: {bean.roastingDate}</span>}</div></div><h1 className="text-2xl font-black leading-snug mb-1 line-clamp-2 drop-shadow-md font-capture">{bean.name}</h1><p className="text-sm font-bold text-amber-400 mb-3 whitespace-nowrap">{bean.country}</p></div></div><div className="p-5 flex flex-col gap-4 bg-white"><div className="flex flex-wrap gap-1.5">{specs.map((s, i) => (<span key={i} className="inline-flex items-center gap-1 px-2 py-1 rounded bg-slate-100 border border-slate-200 text-[9px] font-bold text-slate-600"><span className="opacity-50 flex items-center">{s.icon}</span> <span className="leading-none pt-[1px] whitespace-nowrap">{s.value}</span></span>))}</div><div className="grid grid-cols-1 gap-3">{beanTags.length > 0 && (<div className="flex items-start gap-3"><span className="h-[20px] flex items-center justify-center text-[9px] font-black text-amber-700 bg-amber-50 px-2 rounded border border-amber-100 w-14 shrink-0 pt-[1px] gap-1"><CustomBeanIcon size={10} /> NOTE</span><p className="text-xs font-medium text-slate-600 leading-relaxed pt-[1px]">{beanTags.join(', ')}</p></div>)}</div><div className="space-y-2 pt-2 border-t border-dashed border-slate-100">{bean.flavorDesc && (<p className="text-xs text-slate-700 font-medium leading-relaxed"><Quote size={12} className="inline text-slate-300 mr-1 -mt-1"/>{bean.flavorDesc}</p>)}{bean.memo && (<div className="flex gap-2 items-start"><StickyNote size={12} className="text-slate-400 shrink-0 mt-0.5"/><div className="text-[10px] text-slate-500 font-medium leading-snug whitespace-pre-wrap">{bean.memo}</div></div>)}</div></div><div className="bg-slate-900 text-white text-center py-2"><p className="text-[8px] font-bold tracking-[0.2em] uppercase opacity-60 font-brand">Recorded with BeanLog</p></div></div></div>
                <div className="flex flex-col items-center gap-6">{isGenerating ? (<div className="flex flex-col items-center text-white gap-2"><div className="loader-white"></div><span className="text-xs">ì¹´ë“œ ë§Œë“œëŠ” ì¤‘...</span></div>) : (<div className="flex flex-col items-center animate-in zoom-in-95 duration-300"><img src={generatedImg} className="w-[300px] rounded-lg shadow-2xl mb-4" alt="Bean Card" /><p className="text-white text-sm font-bold animate-pulse">ğŸ‘† ì´ë¯¸ì§€ë¥¼ ê¾¹ ëˆŒëŸ¬ ì €ì¥í•˜ì„¸ìš”</p></div>)}<button onClick={onClose} className="bg-white/20 text-white px-8 py-3 rounded-full font-bold backdrop-blur-sm hover:bg-white/30 transition-colors">ë‹«ê¸°</button>{generatedImg && (<button onClick={handleDownload} className="text-white/60 text-xs hover:text-white underline">ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ìœ¼ë¡œ ì €ì¥í•˜ê¸°</button>)}</div>
            </div>
        );
    };

    // --- Helper Components & Functions for Timer (Moved outside for stability) ---
    
    // Timer Icons Component (Scoped)
    const MiniIcon = ({ iconType, isMain }) => {
        let IconComp = Droplet; let colorClass = "text-slate-400";
        if (iconType === 'BEAN') return <div className={`flex items-center justify-center ${isMain?'w-8 h-8 bg-amber-100 shadow-sm rounded-full border border-amber-200':'w-6 h-6'}`}><CustomBeanIcon size={isMain?20:16} className="text-amber-700"/></div>;
        switch (iconType) {
            case 'CLOSE': IconComp = ToggleRight; colorClass = "text-orange-500 rotate-180"; break;
            case 'OPEN': IconComp = ToggleRight; colorClass = "text-orange-500"; break;
            case 'STIR': IconComp = Utensils; colorClass = "text-purple-500"; break;
            case 'SWIRL': IconComp = Waves; colorClass = "text-purple-500"; break;
            case 'CIRCLE': IconComp = RefreshCcw; colorClass = "text-blue-500"; break;
            case 'SPIRAL': IconComp = Tornado; colorClass = "text-blue-500"; break;
            case 'CENTER': IconComp = Target; colorClass = "text-blue-500"; break;
            case 'POUR': IconComp = Droplet; colorClass = "text-blue-500"; break;
            case 'CLOCK': IconComp = Clock; colorClass = "text-slate-400"; break;
            case 'CHECK': IconComp = Check; colorClass = "text-green-500"; break;
            default: IconComp = Play;
        }
        return <div className={`flex items-center justify-center ${isMain?'w-8 h-8 bg-white shadow-sm rounded-full border border-slate-100':'w-6 h-6'}`}><IconComp size={isMain?18:14} className={colorClass} strokeWidth={isMain?2.5:2} /></div>;
    };

    const TimerStepRow = ({ step, isCurrent, isPast, itemRef }) => (
        <div ref={itemRef} className={`flex items-center gap-4 p-5 rounded-2xl border transition-all duration-500 cursor-pointer ${isCurrent ? `bg-white dark:bg-slate-900 shadow-xl step-active border-l-8 dark:border-slate-800` : (isPast ? 'bg-slate-100 dark:bg-slate-800 opacity-60 grayscale border-transparent step-inactive' : 'bg-white dark:bg-slate-900 border-transparent opacity-70')}`}>
            <div className={`rounded-xl p-1.5 flex items-center gap-1 border shrink-0 min-w-[60px] justify-center transition-colors ${isCurrent ? 'bg-blue-50 dark:bg-blue-900/20 border-blue-100 dark:border-blue-900/30' : 'bg-slate-50 dark:bg-slate-800 border-slate-100 dark:border-slate-700'}`}>
                {step.icons && step.icons.length > 0 ? step.icons.map((item, idx) => <MiniIcon key={idx} iconType={item.icon} isMain={item.type === 'MAIN'} />) : <Clock size={16} className="text-slate-300"/>}
            </div>
            <div className="flex-1 min-w-0">
                <div className="flex justify-between items-center mb-0.5"><span className={`text-[10px] font-bold uppercase tracking-wider ${isCurrent ? 'text-blue-500' : 'text-slate-400'}`}>{step.originalCmd || 'STEP'}</span><span className="text-[10px] font-mono text-slate-400 bg-slate-100 px-1.5 rounded">{step.timeRange}</span></div>
                <h3 className={`text-base font-bold leading-tight break-keep flex flex-wrap items-baseline gap-1 ${isCurrent ? 'text-slate-900 dark:text-slate-100' : 'text-slate-500 dark:text-slate-500'}`}>
                    <span>{step.desc}</span>
                    {step.cumWater && (
                        <span className="text-xs text-blue-500 font-medium whitespace-nowrap ml-1">
                            (ëˆ„ì  {step.cumWater}ml{step.pourCount ? ` â€¢ ${step.pourCount}ì°¨ í‘¸ì–´` : ''})
                        </span>
                    )}
                </h3>
            </div>
        </div>
    );

    const parseStepCommand = (inputStr) => {
        const lower = inputStr.toLowerCase().trim();
        const numMatch = lower.match(/(\d+(?:\.\d+)?)/);
        const value = numMatch ? parseFloat(numMatch[0]) : null;
        let prefixStr = "", suffixStr = "";
        if (value !== null) {
            const numIndex = lower.indexOf(numMatch[0]);
            prefixStr = lower.substring(0, numIndex);
            suffixStr = lower.substring(numIndex + numMatch[0].length);
        } else { prefixStr = lower; }

        const dict = {
            pre: { cl: { text: "ìŠ¤ìœ„ì¹˜ ë‹«ê³ ", icon: 'CLOSE' }, op: { text: "ìŠ¤ìœ„ì¹˜ ì—´ê³ ", icon: 'OPEN' }, st: { text: "ì “ê³ ", icon: 'STIR' }, sw: { text: "í”ë“¤ê³ ", icon: 'SWIRL' } },
            post: { cl: { text: "ìŠ¤ìœ„ì¹˜ ë‹«ê¸°", icon: 'CLOSE' }, op: { text: "ìŠ¤ìœ„ì¹˜ ì—´ê¸°", icon: 'OPEN' }, st: { text: "ì “ê¸°", icon: 'STIR' }, sw: { text: "í”ë“¤ê¸°", icon: 'SWIRL' } },
            style: { c: { text: "Circle", icon: 'CIRCLE' }, s: { text: "Spiral", icon: 'SPIRAL' }, ct: { text: "Center", icon: 'CENTER' }, k: { text: "Center", icon: 'CENTER' } }
        };

        const analyze = (str, type) => {
            let temp = str, items = [], foundStyle = null;
            ['cl', 'op', 'st', 'sw'].forEach(key => { if (temp.includes(key)) { items.push({ ...dict[type][key], key }); temp = temp.replace(key, ''); } });
            if (temp.includes('ct') || temp.includes('k')) { foundStyle = dict.style.ct; } else if (temp.includes('s')) { foundStyle = dict.style.s; } else if (temp.includes('c')) { foundStyle = dict.style.c; }
            return { items, foundStyle };
        };

        const pre = analyze(prefixStr, 'pre'), suf = analyze(suffixStr, 'post');
        let sentenceParts = [], icons = [];

        pre.items.forEach(item => {
            let text = item.text;
            if (value === null && dict.post[item.key]) text = dict.post[item.key].text;
            sentenceParts.push(text); icons.push({ type: 'PRE', icon: item.icon });
        });

        const appliedStyle = pre.foundStyle || suf.foundStyle;
        let stepMeta = { value: null, isBean: false };

        if (value !== null) {
            const isBean = lower.includes('g') && !lower.includes('ml');
            stepMeta = { value, isBean };
            if (isBean) { sentenceParts.push(`+ ì›ë‘ ${value}g`); icons.push({ type: 'MAIN', icon: 'BEAN' }); }
            else { 
                let pourText = `+${value}ml`;
                if (appliedStyle) pourText += ` (${appliedStyle.text})`;
                sentenceParts.push(pourText); icons.push({ type: 'MAIN', icon: appliedStyle ? appliedStyle.icon : 'POUR' }); 
            }
        }

        if (suf.items.length > 0) {
            if (sentenceParts.length > 0) sentenceParts.push("í›„");
            suf.items.forEach(item => { sentenceParts.push(item.text); icons.push({ type: 'POST', icon: item.icon }); });
        }
        
        return { fullText: sentenceParts.join(' '), icons, stepMeta };
    };

    const parseRecipe = (data) => {
        const waterSteps = data.water.trim().split(/\s+/), intervalSteps = data.interval.trim().split(/\s+/);
        const [min, sec] = data.endTime.includes(':') ? data.endTime.split(':').map(Number) : [0, parseInt(data.endTime)];
        const totalSec = min * 60 + sec;
        let accTime = 0, cumWater = 0; const timeline = [];
        let pourCounter = 0;

        waterSteps.forEach((stepToken, i) => {
            let duration = parseInt(intervalSteps[i] || 0);
            if (i === waterSteps.length - 1 || isNaN(duration) || duration === 0) { const remaining = totalSec - accTime; duration = remaining > 0 ? remaining : 0; }
            const startTime = accTime, endTimeStr = formatTime(accTime + duration), timeRange = `${formatTime(startTime)} ~ ${endTimeStr}`;
            const { fullText, icons, stepMeta } = parseStepCommand(stepToken);
            
            let currentCumWater = null;
            let currentPourCount = null;

            if (stepMeta.value && !stepMeta.isBean) { 
                cumWater += stepMeta.value; 
                currentCumWater = cumWater; 
                pourCounter++;
                currentPourCount = pourCounter;
            }

            timeline.push({ startTime, duration, timeRange, desc: fullText || stepToken, icons, originalCmd: stepToken, cumWater: currentCumWater, pourCount: currentPourCount });
            accTime += duration;
        });

        if (accTime < totalSec) timeline.push({ startTime: accTime, duration: totalSec - accTime, timeRange: `${formatTime(accTime)} ~ ${formatTime(totalSec)}`, desc: 'ì¶”ì¶œ ëŒ€ê¸° (Drawdown)', icons: [{ type: 'MAIN', icon: 'CLOCK' }] });
        timeline.push({ startTime: totalSec, timeRange: formatTime(totalSec), desc: 'ì¶”ì¶œ ì¢…ë£Œ (Finish)', duration: 0, icons: [{ type: 'MAIN', icon: 'CHECK' }] });
        return timeline;
    };


    // --- BEANS TAB ---
    const BeansTab = ({ active, globalApiKey, navProps, onNavConsumed, navKey }) => {
        const VIEW = { LIST: 'LIST', DETAIL: 'DETAIL', EDIT_BEAN: 'EDIT_BEAN', EDIT_TASTING: 'EDIT_TASTING' };
        const NOTE_MODE = { BEAN: 'BEAN', TASTING: 'TASTING' };
        const SORT_MODE = { CREATED_DESC: 'CREATED_DESC', PURCHASE_DESC: 'PURCHASE_DESC', ROAST_DESC: 'ROAST_DESC', SCORE_DESC: 'SCORE_DESC', STATUS_ASC: 'STATUS_ASC' };
        const SORT_LABELS = { [SORT_MODE.CREATED_DESC]: 'ìµœê·¼ ì…ë ¥ìˆœ', [SORT_MODE.PURCHASE_DESC]: 'ìµœê·¼ êµ¬ë§¤ì¼ìˆœ', [SORT_MODE.ROAST_DESC]: 'ìµœê·¼ ë¡œìŠ¤íŒ…ìˆœ', [SORT_MODE.SCORE_DESC]: 'í‰ì  ë†’ì€ìˆœ', [SORT_MODE.STATUS_ASC]: 'ë‚¨ì€ ì›ë‘ ë¨¼ì €' };

        const [view, setView] = useState(VIEW.LIST);
        const [beans, setBeans] = useState([]);
        const [selectedId, setSelectedId] = useState(null);
        const [editTastingIdx, setEditTastingIdx] = useState(null);
        const [searchTerm, setSearchTerm] = useState("");
        const [filterMode, setFilterMode] = useState("ALL");
        const [listNoteMode, setListNoteMode] = useState(NOTE_MODE.BEAN);
        const [sortMode, setSortMode] = useState(SORT_MODE.CREATED_DESC);
        const [showSortMenu, setShowSortMenu] = useState(false);
        const [shareData, setShareData] = useState(null);
        const [showImportInput, setShowImportInput] = useState(false);
        const [importUrl, setImportUrl] = useState("");
        const [showAddMenu, setShowAddMenu] = useState(false);
        const [shareBeanData, setShareBeanData] = useState(null);
        const [beanMenuIdx, setBeanMenuIdx] = useState(null);
        const [isProcessing, setIsProcessing] = useState(false);
        const [isSaving, setIsSaving] = useState(false);
        const [toast, setToast] = useState(null);
        const [showFlavorPicker, setShowFlavorPicker] = useState(false);
        const [pickerTarget, setPickerTarget] = useState(null);
        const [beanForm, setBeanForm] = useState({ ...INITIAL_BEAN });
        const [tastingForm, setTastingForm] = useState({ ...INITIAL_TASTING });
        const [tempOcrImage, setTempOcrImage] = useState(null);
        const [cropImage, setCropImage] = useState(null);
        const [cropTargetField, setCropTargetField] = useState(null);
        const [cropRatio, setCropRatio] = useState(NaN);
        const [showRandomPopup, setShowRandomPopup] = useState(false);
        const [randomBean, setRandomBean] = useState(null);
        const [tastingMenuIdx, setTastingMenuIdx] = useState(null);
        const longPressTimer = useRef(null);
        const isLongPress = useRef(false);
        
        const addBlendInfo = () => setBeanForm(prev => ({ ...prev, blendInfo: [...(prev.blendInfo || []), { country: "", variety: "", ratio: "" }] }));
        const removeBlendInfo = (idx) => setBeanForm(prev => ({ ...prev, blendInfo: prev.blendInfo.filter((_, i) => i !== idx) }));
        const updateBlendInfo = (idx, field, val) => setBeanForm(prev => ({ ...prev, blendInfo: prev.blendInfo.map((item, i) => i === idx ? { ...item, [field]: val } : item) }));

        // Scroll Management Refs
        const mainRef = useRef(null);
        const scrollMap = useRef({});

        // --- SCROLL MANAGEMENT LOGIC START ---
        const saveScrollPosition = (currentView, currentId) => {
             if (mainRef.current) {
                 const key = currentView === VIEW.DETAIL ? `DETAIL-${currentId}` : currentView;
                 scrollMap.current[key] = mainRef.current.scrollTop;
             }
        };

        useLayoutEffect(() => {
            if (active && mainRef.current) {
                 requestAnimationFrame(() => {
                     const key = view === VIEW.DETAIL ? `DETAIL-${selectedId}` : view;
                     mainRef.current.scrollTop = scrollMap.current[key] || 0;
                 });
            }
        }, [view, selectedId]);

        const updateView = (newView, id = null) => {
            saveScrollPosition(view, selectedId);
            window.history.pushState({ view: newView, id, tab: TAB.BEANS }, '');
            setView(newView);
            setSelectedId(id);
        };
        
        const replaceView = (newView, id = null) => {
            saveScrollPosition(view, selectedId);
            window.history.replaceState({ view: newView, id, tab: TAB.BEANS }, '');
            setView(newView);
            setSelectedId(id);
        };
        
        const goBack = () => window.history.back();
        // --- SCROLL MANAGEMENT LOGIC END ---

        const pickRandomBean = () => {
            const availableBeans = beans.filter(b => !b.isFinished && b.weight && parseFloat(b.weight) > 0);
            if (availableBeans.length === 0) { showToastMsg("ì¶”ì²œí•  ì›ë‘ê°€ ì—†ìŠµë‹ˆë‹¤. (ì¡°ê±´: ë³´ìœ  ì¤‘ì¸ ì›ë‘)"); return; }
            const random = availableBeans[Math.floor(Math.random() * availableBeans.length)];
            setRandomBean(random);
            // [Fix] Push history for modal
            window.history.pushState({ view, id: selectedId, tab: TAB.BEANS, modal: 'RANDOM' }, '');
            setShowRandomPopup(true);
        };

        // [Deep Link Handler]
        useEffect(() => {
            // [Fix 1] Check beans.length to prevent race condition when data isn't loaded yet
            if (active && navProps && beans.length > 0) {
                if (navProps.view === 'EDIT_TASTING' && navProps.beanId) {
                    const targetBean = beans.find(b => String(b.id) === String(navProps.beanId));
                    if (targetBean) {
                        // Use provided tasting object directly if available, or try to find it
                        // This fixes "cannot read property of undefined" when tasting form is not set
                        const targetTasting = navProps.tasting || (targetBean.tastings ? targetBean.tastings[0] : null);
                        
                        if (targetTasting) {
                             setSelectedId(navProps.beanId);
                             // Need to find index for delete/update operations
                             const tIdx = targetBean.tastings.findIndex(t => t === targetTasting || (t.date === targetTasting.date && JSON.stringify(t.scores) === JSON.stringify(targetTasting.scores)));
                             setEditTastingIdx(tIdx !== -1 ? tIdx : 0);
                             setTastingForm(targetTasting);
                             setView(VIEW.EDIT_TASTING);
                        } else {
                            // Fallback to detail if no tasting found
                            setSelectedId(navProps.beanId);
                            setView(VIEW.DETAIL);
                        }
                    }
                } else if (navProps.view === 'DETAIL' && navProps.beanId) {
                    setSelectedId(navProps.beanId);
                    setView(VIEW.DETAIL);
                }
                onNavConsumed();
            }
        }, [active, navProps, beans, onNavConsumed]);

        // [History Handler]
        useEffect(() => {
            if (!active) return;
            const handlePop = (event) => {
                if(showAddMenu) { setShowAddMenu(false); return; }
                if(showImportInput) { setShowImportInput(false); return; }
                if(shareBeanData) { setShareBeanData(null); return; }
                if(beanMenuIdx !== null) { setBeanMenuIdx(null); return; }
                if(shareData) { setShareData(null); return; }
                if(cropImage) { setCropImage(null); return; }
                if(showFlavorPicker) { setShowFlavorPicker(false); return; }
                if(showRandomPopup) { setShowRandomPopup(false); return; }
                if(tastingMenuIdx !== null) { setTastingMenuIdx(null); return; }
                
                if (event.state && event.state.tab === TAB.BEANS) {
                    if (event.state.view) {
                        setView(event.state.view);
                        if (event.state.id !== undefined) setSelectedId(event.state.id);
                    }
                } else if (!event.state) {
                    setView(VIEW.LIST);
                    setSelectedId(null);
                }
            };
            window.addEventListener('popstate', handlePop);
            return () => window.removeEventListener('popstate', handlePop);
        }, [active, shareData, cropImage, showFlavorPicker, showRandomPopup, tastingMenuIdx, shareBeanData, beanMenuIdx, showImportInput, showAddMenu]);

        // [New] Handle Share Link (Import Data)
        useEffect(() => {
            if (!active) return;
            const params = new URLSearchParams(window.location.search);
            const shareCode = params.get('share');
            if (shareCode) {
                try {
                    const json = decodeURIComponent(escape(atob(shareCode.replace(/ /g, '+'))));
                    const data = JSON.parse(json);
                    setBeanForm(prev => ({ ...INITIAL_BEAN, ...data })); 
                    setTempOcrImage(null);
                    setView(VIEW.EDIT_BEAN);
                    showToastMsg("ê³µìœ ëœ ì›ë‘ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
                    window.history.replaceState({ view: VIEW.LIST, tab: TAB.BEANS }, '', window.location.pathname);
                    window.history.pushState({ view: VIEW.EDIT_BEAN, tab: TAB.BEANS }, '', window.location.pathname);
                } catch (e) { console.error(e); showToastMsg("ì˜ëª»ëœ ê³µìœ  ë§í¬ì…ë‹ˆë‹¤."); }
            }
        }, [active]);

        // [Fix for Ghost View]
        useEffect(() => {
            if (active && !navProps) {
                if (new URLSearchParams(window.location.search).has('share')) return;
                const currentState = window.history.state;
                if (currentState && currentState.view && currentState.tab === TAB.BEANS) {
                    setView(currentState.view);
                    setSelectedId(currentState.id || null);
                } else {
                    // Default to LIST only if no valid state
                   if (!selectedId) setView(VIEW.LIST);
                }
            }
        }, [active, navProps, navKey]);

        const openLink = (url) => {
            if (!url) return;
            let target = url;
            if (!/^https?:\/\//i.test(target)) {
                target = 'http://' + target;
            }
            window.open(target, '_blank');
        };

        useEffect(() => {
            try {
              let loadedData = safeStorage.get(`${STORAGE_KEY}_data`);
              if (Array.isArray(loadedData)) {
                setBeans(loadedData.map(b => ({ ...INITIAL_BEAN, ...b, tastings: Array.isArray(b.tastings) ? b.tastings : [] })));
              }
              const savedNoteMode = safeStorage.get(`${STORAGE_KEY}_note_mode`); if (savedNoteMode) setListNoteMode(savedNoteMode);
              const savedSortMode = safeStorage.get(`${STORAGE_KEY}_sort_mode`); if (savedSortMode) setSortMode(savedSortMode);
            } catch (e) { console.error(e); }
        }, [active]);

        const showToastMsg = (msg) => { setToast(msg); setTimeout(() => setToast(null), 3000); };
        const activeBean = useMemo(() => beans.find(b => String(b.id) === String(selectedId)) || null, [beans, selectedId]);
        const onSelectFile = (e, field) => { if (e.target.files && e.target.files.length > 0) { const reader = new FileReader(); reader.readAsDataURL(e.target.files[0]); reader.onload = () => { setCropImage(reader.result); setCropTargetField(field); setCropRatio(field === 'main' ? 1 : NaN); }; } e.target.value = null; };
        const onCropFinish = (croppedBase64) => { if (cropTargetField === 'main') setBeanForm(prev => ({ ...prev, mainImage: croppedBase64 })); else if (cropTargetField === 'ocr') setTempOcrImage(croppedBase64); setCropImage(null); };
        
        const runOCR = async () => {
            if (!tempOcrImage) return showToastMsg("ë¶„ì„í•  ì‚¬ì§„ì„ ë“±ë¡í•´ì£¼ì„¸ìš”.");
            if (!globalApiKey) return showToastMsg("ì„¤ì • íƒ­ì—ì„œ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            setIsProcessing(true);
            try {
                const base64Data = tempOcrImage.split(',')[1];
                const promptText = `Analyze the coffee bean image and return a valid JSON object. Rules: 1. Extract 'altitude' (look for 'm', 'masl'). 2. Separate 'notes' (short) and 'flavorDesc'. 3. Translate 'notes', 'flavorDesc', 'memo' to KOREAN. 4. Dates YYYY-MM-DD. 5. Return ONLY JSON. Keys: { "name": "", "country": "", "region": "", "altitude": "", "variety": "", "processing": "", "roastingLevel": "", "producer": "", "shop": "", "roastingDate": "", "purchaseUrl": "", "price": "", "weight": "", "notes": "", "flavorDesc": "", "memo": "" }`;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${globalApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: promptText },
                                { inlineData: { mimeType: "image/jpeg", data: base64Data } }
                            ]
                        }]
                    })
                });
                const res = await response.json();
                const text = res.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    const clean = text.replace(/```json|```/g, "").trim();
                    setBeanForm(p => ({ ...p, ...JSON.parse(clean) }));
                    showToastMsg("ì •ë³´ ì…ë ¥ ì™„ë£Œ!");
                } else throw new Error();
            } catch (e) {
                showToastMsg("ë¶„ì„ ì‹¤íŒ¨");
                console.error(e);
            } finally {
                setIsProcessing(false);
            }
        };
        
        const saveData = (updatedBeans, nextId, isNew) => { 
            if(safeStorage.set(`${STORAGE_KEY}_data`, updatedBeans)) { 
                setBeans(updatedBeans); setIsSaving(false); 
                setTimeout(() => { 
                    setTempOcrImage(null); 
                    if (isNew !== null) { 
                        if (isNew) { replaceView(VIEW.DETAIL, nextId); } else { goBack(); } 
                    } else {
                        // ìˆ˜ì • ëª¨ë“œì—ì„œ ì €ì¥ í›„ ë’¤ë¡œê°€ê¸° (ìƒì„¸ ë˜ëŠ” ì´ì „ í™”ë©´ìœ¼ë¡œ)
                        goBack();
                    }
                }, 300); 
            } else { setIsSaving(false); showToastMsg("ìš©ëŸ‰ ë¶€ì¡±!"); } 
        };
        
        const handleSaveBean = () => { 
            if (!beanForm.name.trim()) return showToastMsg("ì´ë¦„ ì…ë ¥ í•„ìš”"); 
            setIsSaving(true); 
            setTimeout(() => { 
                const isNew = !beanForm.id; 
                const id = isNew ? Date.now() : beanForm.id; 
                const newBean = { ...beanForm, id, tastings: beanForm.tastings || [], ocrImage: null }; 
                let newBeans = !isNew ? beans.map(b => String(b.id) === String(id) ? newBean : b) : [newBean, ...beans]; 
                saveData(newBeans, id, isNew); 
            }, 300); 
        };

        const handleSaveTasting = () => { if (!selectedId) return; setIsSaving(true); setTimeout(() => { const newBeans = beans.map(b => { if (String(b.id) === String(selectedId)) { const tList = [...b.tastings]; if (editTastingIdx !== null) tList[editTastingIdx] = tastingForm; else tList.unshift({ ...tastingForm, id: Date.now() }); return { ...b, tastings: tList }; } return b; }); saveData(newBeans, selectedId, false); }, 300); };
        const handleDelete = () => { if (confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { const newBeans = beans.filter(b => String(b.id) !== String(selectedId)); if (safeStorage.set(`${STORAGE_KEY}_data`, newBeans)) { setBeans(newBeans); updateView(VIEW.LIST); } } };
        const handleDeleteTasting = () => { if (confirm("ì‚­ì œ?")) { const newBeans = beans.map(b => { if (String(b.id) === String(selectedId)) { return { ...b, tastings: b.tastings.filter((_, i) => i !== editTastingIdx) }; } return b; }); saveData(newBeans, selectedId, false); } };
        const updateScore = (id, delta) => { setTastingForm(prev => { let nextVal = prev.scores[id] + delta; if (nextVal < 0) nextVal = 0; if (nextVal > 10) nextVal = 10; nextVal = Math.round(nextVal * 10) / 10; return { ...prev, scores: { ...prev.scores, [id]: nextVal } }; }); };
        
        const handleTextShare = async (bean, tasting) => {
            const text = generateShareText(bean, tasting);

            if (navigator.share) {
                try { await navigator.share({ text }); } catch (e) { console.log(e); }
            } else {
                try { await navigator.clipboard.writeText(text); showToastMsg("í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); } catch (e) { showToastMsg("ë³µì‚¬ ì‹¤íŒ¨"); }
            }
            setTastingMenuIdx(null);
        };

        const handleDeleteTastingItem = (idx) => {
            if (confirm("ì´ ì‹œìŒ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                const newBeans = beans.map(b => {
                    if (String(b.id) === String(selectedId)) {
                        const newTastings = b.tastings.filter((_, i) => i !== idx);
                        return { ...b, tastings: newTastings };
                    }
                    return b;
                });
                saveData(newBeans, selectedId, false);
                setTastingMenuIdx(null);
            }
        };

        const handleTouchStart = (idx) => { isLongPress.current = false; longPressTimer.current = setTimeout(() => { isLongPress.current = true; setTastingMenuIdx(idx); if (navigator.vibrate) navigator.vibrate(50); }, 2000); };
        const handleTouchEnd = () => { if (longPressTimer.current) clearTimeout(longPressTimer.current); };

        const handleBeanTouchStart = (id) => { isLongPress.current = false; longPressTimer.current = setTimeout(() => { isLongPress.current = true; setBeanMenuIdx(id); if (navigator.vibrate) navigator.vibrate(50); }, 2000); };
        const handleBeanTouchEnd = () => { if (longPressTimer.current) clearTimeout(longPressTimer.current); };

        const handleBeanTextShare = async (bean) => {
            const text = generateBeanShareText(bean);
            if (navigator.share) {
                try { await navigator.share({ text }); } catch (e) { console.log(e); }
            }
            else { try { await navigator.clipboard.writeText(text); showToastMsg("í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); } catch (e) { showToastMsg("ë³µì‚¬ ì‹¤íŒ¨"); } }
            setBeanMenuIdx(null);
        };

        const handleAppShare = async () => {
            const bean = beans.find(b => b.id === beanMenuIdx);
            if (!bean) return;

            const shareObj = {
                name: bean.name, country: bean.country, region: bean.region, variety: bean.variety,
                processing: bean.processing, altitude: bean.altitude, roastingLevel: bean.roastingLevel,
                producer: bean.producer, shop: bean.shop, roastingDate: bean.roastingDate,
                purchaseDate: bean.purchaseDate, purchaseUrl: bean.purchaseUrl, price: bean.price,
                weight: bean.weight, pricePerCup: bean.pricePerCup, notes: bean.notes,
                flavorDesc: bean.flavorDesc, memo: bean.memo, isBlend: bean.isBlend, blendInfo: bean.blendInfo
            };

            try {
                const json = JSON.stringify(shareObj);
                const encoded = btoa(unescape(encodeURIComponent(json)));
                const longUrl = `${window.location.href.split('?')[0]}?share=${encodeURIComponent(encoded)}`;
                let shareUrl = longUrl;

                try {
                    showToastMsg("ë§í¬ ë‹¨ì¶• ì¤‘...");
                    const res = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(longUrl)}`);
                    if (res.ok) { const short = await res.text(); if(short.startsWith('http')) shareUrl = short; }
                } catch(e) { console.log("Shortening failed"); }

                if (navigator.share) { await navigator.share({ title: bean.name, text: `[BeanLog] ${bean.name} ì›ë‘ ì •ë³´ ê³µìœ `, url: shareUrl }); } 
                else { await navigator.clipboard.writeText(shareUrl); showToastMsg("ê³µìœ  ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); }
            } catch (e) { console.error(e); showToastMsg("ê³µìœ  ì‹¤íŒ¨"); }
            setBeanMenuIdx(null);
        };

        const handleImportBean = async () => {
            if (!importUrl.trim()) return;
            showToastMsg("ë§í¬ ì •ë³´ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘...");
            try {
                let shareCode = null;
                try {
                    const urlObj = new URL(importUrl);
                    shareCode = new URLSearchParams(urlObj.search).get('share');
                } catch (e) {}

                if (!shareCode) {
                    try {
                        const res = await fetch(`https://unshorten.me/json/${encodeURIComponent(importUrl)}`);
                        if (res.ok) { const json = await res.json(); if (json.resolved_url) { shareCode = new URLSearchParams(new URL(json.resolved_url).search).get('share'); } }
                    } catch (e) { console.log("Expansion failed"); }
                }

                if (shareCode) {
                    const json = decodeURIComponent(escape(atob(shareCode.replace(/ /g, '+'))));
                    const data = JSON.parse(json);
                    setBeanForm(prev => ({ ...INITIAL_BEAN, ...data }));
                    setTempOcrImage(null);
                    updateView(VIEW.EDIT_BEAN);
                    showToastMsg("ì›ë‘ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
                    setShowImportInput(false);
                    setImportUrl("");
                } else {
                    showToastMsg("ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ê¸´ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”)");
                }
            } catch (e) { console.error(e); showToastMsg("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
        };

        const handleShopChange = (e) => { const val = e.target.value; setBeanForm(prev => ({ ...prev, shop: val })); if (!beanForm.purchaseUrl) { const match = beans.find(b => b.shop && b.shop.toLowerCase() === val.toLowerCase() && b.purchaseUrl); if (match) { setBeanForm(prev => ({ ...prev, purchaseUrl: match.purchaseUrl })); showToastMsg(`URL ìë™ ì…ë ¥: ${match.shop}`); } } };
        const sortedBeans = useMemo(() => { let result = beans; if (filterMode === 'BEAN') result = result.filter(b => b.weight); else if (filterMode === 'CUP') result = result.filter(b => b.pricePerCup); if (searchTerm.trim()) { const terms = searchTerm.toLowerCase().split(/\s+/).filter(t => t.length > 0); result = result.filter(bean => { const text = [bean.name, bean.country, bean.region, bean.variety, bean.processing, bean.roastingLevel, bean.shop, bean.notes, bean.flavorDesc, bean.memo, ...(bean.tastings ? bean.tastings.map(t => `${t.notes} ${t.memo}`) : [])].join(" ").toLowerCase(); return terms.every(t => text.includes(t)); }); } return [...result].sort((a, b) => { switch (sortMode) { case SORT_MODE.PURCHASE_DESC: if (!a.purchaseDate) return 1; if (!b.purchaseDate) return -1; return b.purchaseDate.localeCompare(a.purchaseDate); case SORT_MODE.ROAST_DESC: if (!a.roastingDate) return 1; if (!b.roastingDate) return -1; return b.roastingDate.localeCompare(a.roastingDate); case SORT_MODE.SCORE_DESC: const scoreA = getMaxScoreVal(a.tastings); const scoreB = getMaxScoreVal(b.tastings); if (scoreA !== scoreB) return scoreB - scoreA; return b.id - a.id; case SORT_MODE.STATUS_ASC: const getRank = (item) => { const isBean = !!item.weight; if (isBean) return item.isFinished ? 1 : 0; return 2; }; const rankA = getRank(a); const rankB = getRank(b); if (rankA !== rankB) return rankA - rankB; return b.id - a.id; case SORT_MODE.CREATED_DESC: default: return b.id - a.id; } }); }, [beans, searchTerm, filterMode, sortMode]);

        if(!active) return null;

        return (
            <div className={`h-full flex flex-col bg-slate-50 dark:bg-slate-950 relative ${active ? 'block' : 'hidden'}`}>
                {/* ... BeansTab Content ... */}
                {showImportInput && (
                    <div className="fixed inset-0 z-[70] bg-black/50 dark:bg-black/70 flex items-center justify-center p-4 animate-in fade-in" onClick={() => setShowImportInput(false)}>
                        <div className="bg-white dark:bg-slate-900 w-full max-w-xs rounded-2xl p-6 shadow-xl animate-pop space-y-4" onClick={e => e.stopPropagation()}>
                            <h3 className="text-lg font-bold text-slate-900 dark:text-white">ê³µìœ  ë§í¬ë¡œ ì›ë‘ ì¶”ê°€</h3><input className="w-full bg-slate-100 dark:bg-slate-800 dark:text-white p-3 rounded-xl text-sm font-bold outline-none" placeholder="https://..." value={importUrl} onChange={(e) => setImportUrl(e.target.value)} /><div className="flex gap-2"><button onClick={() => setShowImportInput(false)} className="flex-1 py-3 bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 rounded-xl font-bold">ì·¨ì†Œ</button><button onClick={handleImportBean} className="flex-1 py-3 bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 rounded-xl font-bold">ë¶ˆëŸ¬ì˜¤ê¸°</button></div>
                        </div>
                    </div>
                )}
                {cropImage && <ImageCropper imageSrc={cropImage} aspectRatio={cropRatio} onComplete={onCropFinish} onCancel={() => setCropImage(null)} />}
                {shareBeanData && <BeanShareModal bean={shareBeanData} onClose={() => setShareBeanData(null)} />}
                {shareData && <ShareModal bean={shareData.bean} tasting={shareData.tasting} onClose={() => setShareData(null)} />}
                {showFlavorPicker && (<FlavorPicker onClose={() => setShowFlavorPicker(false)} onConfirm={(text) => { if (pickerTarget === 'bean') { setBeanForm(prev => ({ ...prev, notes: text })); } else if (pickerTarget === 'tasting') { setTastingForm(prev => ({ ...prev, notes: text })); } setShowFlavorPicker(false); }} initialNotes={pickerTarget === 'bean' ? beanForm.notes : tastingForm.notes} />)}
                
                {showRandomPopup && randomBean && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/40 dark:bg-black/70 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]" onClick={() => window.history.back()}>
                        <div className="w-full max-w-xs bg-white dark:bg-slate-900 rounded-3xl shadow-2xl relative overflow-hidden animate-[scaleIn_0.2s_ease-out]" style={{ animation: 'pop 0.3s cubic-bezier(0.16, 1, 0.3, 1)' }} onClick={e => e.stopPropagation()}>
                            <div className="bg-amber-50 dark:bg-amber-900/20 p-4 flex justify-between items-center border-b border-amber-100 dark:border-amber-900/30">
                                <div className="flex items-center gap-1.5 text-amber-600"><Sparkles size={16} fill="currentColor" /><span className="text-xs font-bold uppercase tracking-wider">Today's Pick</span></div>
                                <button onClick={() => window.history.back()} className="bg-white dark:bg-slate-800 text-slate-400 p-1.5 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors"><X size={16}/></button>
                            </div>
                            <div className="p-6 pt-5 text-center flex flex-col items-center gap-1">
                                <h2 className="text-xl font-black text-slate-900 dark:text-white leading-tight mb-1 break-keep word-keep">{randomBean.name}</h2>
                                <div className="flex flex-wrap justify-center gap-1.5 mb-4">{randomBean.country && <span className="px-2 py-0.5 bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 rounded text-[10px] font-bold border border-slate-200 dark:border-slate-700">{randomBean.country}</span>}{randomBean.roastingLevel && <span className="px-2 py-0.5 bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-400 rounded text-[10px] font-bold border border-amber-100 dark:border-amber-900/30">{randomBean.roastingLevel}</span>}</div>
                                {randomBean.notes && (<p className="text-xs text-slate-400 mb-6 line-clamp-1">"{randomBean.notes}"</p>)}
                                <button onClick={() => { setShowRandomPopup(false); replaceView(VIEW.DETAIL, randomBean.id); }} className="px-6 py-2.5 bg-slate-900 dark:bg-slate-100 hover:bg-slate-800 dark:hover:bg-slate-200 text-white dark:text-slate-900 rounded-xl text-xs font-bold transition-all active:scale-95 shadow-lg shadow-slate-200 dark:shadow-none">ìƒì„¸ ì •ë³´ ë³´ê¸°</button>
                            </div>
                        </div>
                    </div>
                )}

                {toast && <div className="fixed top-10 left-1/2 -translate-x-1/2 bg-slate-900/90 text-white px-6 py-3 rounded-full text-xs font-bold shadow-xl z-[70] whitespace-nowrap">{toast}</div>}

                {view === VIEW.LIST && (
                    <>
                        <header className="p-5 pb-3 pt-4 bg-white dark:bg-slate-900 border-b dark:border-slate-800 sticky top-0 z-10 bg-white/90 dark:bg-slate-900/90 backdrop-blur space-y-3">
                            <div className="flex justify-between items-center">
                                <div><h1 className="text-2xl font-black font-brand flex items-center gap-1 dark:text-white">BeanLog <CustomBeanIcon size={24} className="text-[#4b2c20] dark:text-amber-500"/></h1><p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest font-brand">Coffee bean archive</p></div>
                                <div className="flex gap-2">
                                    <button onClick={pickRandomBean} className="w-10 h-10 bg-amber-50 dark:bg-amber-900/20 text-amber-600 dark:text-amber-400 rounded-full flex items-center justify-center border border-amber-100 dark:border-amber-900/30 active:scale-95 transition-transform"><Sparkles size={18}/></button>
                                    <div className="relative">
                                        <button onClick={() => setShowAddMenu(!showAddMenu)} className={`w-10 h-10 rounded-full flex items-center justify-center active:scale-95 transition-all ${showAddMenu ? 'bg-slate-900 text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700'}`}><Plus size={20}/></button>
                                        {showAddMenu && (
                                            <>
                                                <div className="fixed inset-0 z-20" onClick={() => setShowAddMenu(false)}></div>
                                                <div className="absolute right-0 top-full mt-2 w-40 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border dark:border-slate-700 p-2 z-30 flex flex-col gap-1 animate-in slide-in-from-top-2">
                                                    <button onClick={() => { setShowAddMenu(false); setBeanForm({ ...INITIAL_BEAN }); setTempOcrImage(null); updateView(VIEW.EDIT_BEAN); }} className="text-left px-3 py-3 rounded-xl text-xs font-bold flex items-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300"><Plus size={16}/> ì§ì ‘ ì¶”ê°€</button>
                                                    <button onClick={() => { setShowAddMenu(false); setShowImportInput(true); }} className="text-left px-3 py-3 rounded-xl text-xs font-bold flex items-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-300"><Link size={16}/> ë§í¬ë¡œ ì¶”ê°€</button>
                                                </div>
                                            </>
                                        )}
                                    </div>
                                </div>
                            </div>
                            <div className="relative"><Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} /><input className="w-full bg-slate-100 dark:bg-slate-800 dark:text-white p-3 pl-10 rounded-2xl text-sm font-bold outline-none" placeholder="ê²€ìƒ‰..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />{searchTerm && <button onClick={() => setSearchTerm("")} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400"><X size={16} fill="currentColor" className="text-slate-300"/></button>}</div>
                            <div className="flex gap-2"><div className="flex-1 flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">{["ALL", "BEAN", "CUP"].map(mode => (<button key={mode} onClick={() => setFilterMode(mode)} className={`flex-1 py-1.5 text-xs font-bold rounded-lg transition-all ${filterMode === mode ? 'bg-white dark:bg-slate-600 text-slate-900 dark:text-white shadow-sm' : 'text-slate-400'}`}>{mode === 'ALL' ? 'ì „ì²´' : (mode === 'BEAN' ? 'ì›ë‘' : 'í•œì”')}</button>))}</div><button onClick={() => { const newMode = listNoteMode === NOTE_MODE.BEAN ? NOTE_MODE.TASTING : NOTE_MODE.BEAN; setListNoteMode(newMode); safeStorage.set(`${STORAGE_KEY}_note_mode`, newMode); showToastMsg(newMode === NOTE_MODE.BEAN ? "ì›ë‘ ë…¸íŠ¸ ë³´ê¸°" : "ì‹œìŒ ë…¸íŠ¸ ë³´ê¸°"); }} className="px-3 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 flex items-center justify-center transition-colors hover:bg-slate-200 dark:hover:bg-slate-700">{listNoteMode === NOTE_MODE.BEAN ? <CustomBeanIcon size={18}/> : <Coffee size={18}/>}</button><div className="relative"><button onClick={() => setShowSortMenu(!showSortMenu)} className={`h-full px-3 rounded-xl flex items-center justify-center transition-colors ${showSortMenu ? 'bg-slate-900 text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400'}`}><ArrowUpDown size={16} /></button>{showSortMenu && (<><div className="fixed inset-0 z-20" onClick={() => setShowSortMenu(false)}></div><div className="absolute right-0 top-full mt-2 w-48 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border dark:border-slate-700 p-2 z-30 flex flex-col gap-1 animate-in slide-in-from-top-2"><div className="px-3 py-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b dark:border-slate-700 mb-1">Sort By</div>{[SORT_MODE.CREATED_DESC, SORT_MODE.PURCHASE_DESC, SORT_MODE.ROAST_DESC, SORT_MODE.SCORE_DESC, SORT_MODE.STATUS_ASC].map(mode => (<button key={mode} onClick={() => { setSortMode(mode); safeStorage.set(`${STORAGE_KEY}_sort_mode`, mode); setShowSortMenu(false); }} className={`text-left px-3 py-2 rounded-lg text-xs font-bold flex items-center justify-between ${sortMode === mode ? 'bg-slate-100 dark:bg-slate-700 text-slate-900 dark:text-white' : 'text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-700'}`}><span>{SORT_LABELS[mode]}</span> {sortMode === mode && <Check size={14}/>}</button>))}</div></>)}</div></div>
                            {sortMode !== SORT_MODE.CREATED_DESC && <div className="flex justify-end"><span className="text-[10px] font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded flex items-center gap-1">{SORT_LABELS[sortMode]} ì •ë ¬ ì¤‘ <ArrowUpDown size={10}/></span></div>}
                        </header>
                        <main className="flex-1 p-4 space-y-4 overflow-y-auto pb-24" ref={mainRef}>
                            {sortedBeans.length === 0 ? <div className="py-20 text-center opacity-40 font-bold">{searchTerm ? "ê²€ìƒ‰ ê²°ê³¼ ì—†ìŒ" : "ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤"}</div> : sortedBeans.map(bean => (
                                <div key={bean.id} 
                                    className="bg-white dark:bg-slate-900 p-4 rounded-3xl shadow-sm border dark:border-slate-800 flex items-start gap-4 active:scale-95 transition-transform relative overflow-hidden select-none"
                                    onTouchStart={() => handleBeanTouchStart(bean.id)} onTouchEnd={handleBeanTouchEnd} onMouseDown={() => handleBeanTouchStart(bean.id)} onMouseUp={handleBeanTouchEnd} onMouseLeave={handleBeanTouchEnd}
                                    onContextMenu={(e) => { e.preventDefault(); setBeanMenuIdx(bean.id); }}
                                    onClick={() => { if (isLongPress.current) return; if (beanMenuIdx !== null) { setBeanMenuIdx(null); return; } updateView(VIEW.DETAIL, bean.id); }}
                                >
                                    <div className="flex flex-col items-center gap-1.5 shrink-0">
                                        <div className={`w-16 h-16 rounded-xl bg-slate-100 dark:bg-slate-800 overflow-hidden relative flex items-center justify-center ${bean.isFinished ? 'text-slate-300 dark:text-slate-600' : 'text-amber-800 dark:text-amber-500'}`}>{bean.mainImage ? <img src={bean.mainImage} className="w-full h-full object-cover"/> : <CustomBeanIcon size={32}/>}</div>
                                        <div className="flex items-center gap-1">{bean.tastings.length > 0 && (<span className="bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-400 px-1.5 py-0.5 rounded-md text-[10px] font-bold flex items-center gap-0.5 border border-amber-100 dark:border-amber-900/30"><Star size={8} fill="currentColor"/> {getMaxScore(bean.tastings)}</span>)}{bean.isFinished ? <CustomBeanIcon size={14} className="text-slate-300 dark:text-slate-600"/> : (bean.weight ? <CustomBeanIcon size={14} className="text-amber-700 dark:text-amber-500"/> : <Coffee size={14} className="text-slate-700 dark:text-slate-400"/>)}</div>
                                    </div>
                                    <div className="flex-1 min-w-0 space-y-1">
                                        <h3 className="font-black text-lg break-words leading-tight text-slate-900 dark:text-slate-100">{bean.name}</h3>
                                        <div className="text-xs text-slate-500 dark:text-slate-400 font-medium whitespace-normal leading-relaxed break-words"><span className="font-bold text-slate-700 dark:text-slate-300">{bean.shop || "-"}</span><span className="mx-1">Â·</span>{bean.roastingLevel || "-"}<span className="mx-1">Â·</span>{bean.purchaseDate || "-"}{bean.weight && bean.roastingDate && <><span className="mx-1">Â·</span><span className="text-amber-600 dark:text-amber-500 font-bold">{getRoastAge(bean.roastingDate)}</span></>}</div>
                                        <div className="text-slate-400 text-xs mt-1 leading-tight line-clamp-2">{parseTags(listNoteMode === NOTE_MODE.TASTING ? (getBestTastingNote(bean.tastings) || bean.notes) : bean.notes).join(', ')}</div>
                                    </div>
                                    {beanMenuIdx === bean.id && (
                                        <div className="absolute inset-0 bg-slate-900/95 z-20 flex items-center justify-center gap-6 animate-in fade-in" onClick={(e) => e.stopPropagation()} onMouseDown={(e) => e.stopPropagation()} onTouchStart={(e) => e.stopPropagation()}>
                                            <button onClick={(e) => { e.stopPropagation(); setShareBeanData(bean); setBeanMenuIdx(null); }} className="flex flex-col items-center text-white gap-1"><div className="p-2 bg-slate-800 rounded-full"><ImageIcon size={20}/></div><span className="text-[10px] font-bold">ì›ë‘ ì¹´ë“œ</span></button>
                                            <button onClick={(e) => { e.stopPropagation(); handleBeanTextShare(bean); }} className="flex flex-col items-center text-white gap-1"><div className="p-2 bg-slate-800 rounded-full"><FileText size={20}/></div><span className="text-[10px] font-bold">í…ìŠ¤íŠ¸</span></button>
                                            <button onClick={(e) => { e.stopPropagation(); handleAppShare(); }} className="flex flex-col items-center text-white gap-1"><div className="p-2 bg-slate-800 rounded-full"><Share2 size={20}/></div><span className="text-[10px] font-bold">ì•± ê³µìœ </span></button>
                                            <button onClick={(e) => { e.stopPropagation(); setBeanMenuIdx(null); }} className="absolute top-0 right-0 p-4 text-slate-500 hover:text-slate-300"><X size={20}/></button>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </main>
                    </>
                )}

                {view === VIEW.DETAIL && activeBean && (
                    <div className="flex flex-col h-full bg-white dark:bg-slate-900">
                        <header className="p-4 pt-4 border-b dark:border-slate-800 flex justify-between items-center sticky top-0 z-10 bg-white dark:bg-slate-900"><button onClick={goBack} className="p-2"><ChevronLeft/></button><span className="font-bold text-xs uppercase tracking-widest text-slate-400">Detail</span><button onClick={() => { setBeanForm({ ...activeBean }); setTempOcrImage(null); updateView(VIEW.EDIT_BEAN, activeBean.id); }} className="text-sm font-bold underline px-2">ìˆ˜ì •</button></header>
                        <main className="flex-1 overflow-y-auto pb-24" ref={mainRef}>
                            <div className="p-6 pb-0">
                                <div className="flex items-center gap-2 mb-4"><h1 className="text-3xl font-black leading-tight break-words dark:text-white">{activeBean.name}</h1>{activeBean.isFinished && <span className="bg-slate-200 dark:bg-slate-800 text-slate-500 dark:text-slate-400 text-[10px] font-bold px-2 py-0.5 rounded h-fit whitespace-nowrap">SOLD OUT</span>}</div>
                                <div className="flex gap-4 items-start">
                                    <div className="w-1/2 aspect-square bg-slate-100 dark:bg-slate-800 relative rounded-2xl overflow-hidden shadow-sm shrink-0">{activeBean.mainImage ? <img src={activeBean.mainImage} className="w-full h-full object-cover"/> : <div className={`absolute inset-0 flex items-center justify-center ${activeBean.isFinished ? 'text-slate-300 dark:text-slate-600' : 'text-amber-800 dark:text-amber-500'}`}><CustomBeanIcon size={96}/></div>}</div>
                                    <div className="w-1/2 flex flex-wrap content-start gap-1.5">
                                        {activeBean.isBlend && activeBean.blendInfo && activeBean.blendInfo.length > 0 ? (
                                            <div className="w-full space-y-1">
                                                <span className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Blend Info</span>
                                                {activeBean.blendInfo.map((info, i) => (
                                                    <div key={i} className="flex items-center gap-1.5 text-[11px] bg-slate-50 dark:bg-slate-800 px-2 py-1 rounded border border-slate-100 dark:border-slate-700">
                                                        {info.country && <span className="font-bold dark:text-slate-200">{getFlagEmoji(info.country)} {info.country}</span>}
                                                        {info.variety && <span className="text-slate-500 dark:text-slate-400">{info.variety}</span>}
                                                        {info.ratio && <span className="font-mono text-amber-600 dark:text-amber-500 font-bold ml-auto">{info.ratio}%</span>}
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <>
                                                {activeBean.country && <span className="bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 px-2 py-1 rounded text-[10px] font-bold flex items-center gap-1">{getFlagEmoji(activeBean.country) ? <span className="text-[11px] leading-none">{getFlagEmoji(activeBean.country)}</span> : <MapPin size={10} />} {activeBean.country}</span>}
                                                {activeBean.region && <span className="bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 px-2 py-1 rounded text-[10px] font-bold border border-slate-200 dark:border-slate-700 flex items-center gap-1"><MapPin size={10} /> {activeBean.region}</span>}
                                                {activeBean.variety && <span className="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 px-2 py-1 rounded text-[10px] font-bold border border-slate-200 dark:border-slate-700 flex items-center gap-1"><Tag size={10} /> {activeBean.variety}</span>}
                                                {activeBean.processing && <span className="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 px-2 py-1 rounded text-[10px] font-bold border border-slate-200 dark:border-slate-700 flex items-center gap-1"><Layers size={10} /> {activeBean.processing}</span>}
                                                {activeBean.producer && <span className="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 px-2 py-1 rounded text-[10px] font-bold border border-slate-200 dark:border-slate-700 flex items-center gap-1"><User size={10} /> {activeBean.producer}</span>}
                                                {activeBean.altitude && <span className="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 px-2 py-1 rounded text-[10px] font-bold border border-slate-200 dark:border-slate-700 flex items-center gap-1"><Mountain size={10} /> {activeBean.altitude}</span>}
                                            </>
                                        )}
                                        {activeBean.roastingLevel && <span className="bg-amber-100 dark:bg-amber-900/20 text-amber-900 dark:text-amber-400 px-2 py-1 rounded text-[10px] font-bold border border-amber-200 dark:border-amber-900/30 flex items-center gap-1"><Flame size={10} /> {activeBean.roastingLevel}</span>}
                                        {activeBean.weight && activeBean.roastingDate && <span className="bg-slate-50 dark:bg-slate-800 text-slate-500 dark:text-slate-400 px-2 py-1 rounded text-[10px] font-bold border border-slate-200 dark:border-slate-700 flex items-center gap-1"><Calendar size={10} className="text-slate-400"/> {activeBean.roastingDate}</span>}
                                        {activeBean.weight && activeBean.roastingDate && <span className="bg-amber-50 dark:bg-amber-900/20 text-amber-600 dark:text-amber-400 px-2 py-1 rounded text-[10px] font-bold border border-amber-100 dark:border-amber-900/30 flex items-center gap-1">Roast {getRoastAge(activeBean.roastingDate)}</span>}
                                    </div>
                                </div>
                            </div>
                            <div className="p-6 space-y-6">
                                {(activeBean.notes || activeBean.flavorDesc) && (<div className="bg-amber-50 dark:bg-amber-900/20 p-5 rounded-2xl border border-amber-100 dark:border-amber-900/30 relative"><Quote size={20} className="absolute top-4 right-4 text-amber-200 dark:text-amber-800 opacity-50" /><span className="text-[10px] font-bold text-amber-500 uppercase block mb-3">Flavor Notes</span><div className="flex flex-wrap gap-2 mb-3">{parseTags(activeBean.notes).map((note, idx) => (<span key={idx} className="bg-white dark:bg-slate-800 text-amber-800 dark:text-amber-400 px-3 py-1.5 rounded-full text-xs font-bold border border-amber-100 dark:border-amber-900/30 shadow-sm">{note}</span>))}</div>{activeBean.flavorDesc && <p className="text-amber-900 dark:text-amber-200 text-sm font-medium italic leading-relaxed border-t border-amber-200 dark:border-amber-900/30 pt-3 mt-2">{activeBean.flavorDesc}</p>}</div>)}
                                <div className="bg-white dark:bg-slate-900 border border-slate-100 dark:border-slate-800 p-5 rounded-3xl shadow-sm space-y-3"><div className="flex justify-between items-center"><h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-1"><ShoppingBag size={12}/> Purchase Info</h3>{activeBean.purchaseUrl && (<button onClick={() => openLink(activeBean.purchaseUrl)} className="text-[10px] font-bold text-blue-500 bg-blue-50 dark:bg-blue-900/20 px-2 py-1 rounded-lg flex items-center gap-1">êµ¬ë§¤ì²˜ ë°©ë¬¸ <ExternalLink size={10}/></button>)}</div><div className="flex justify-between items-center text-sm font-medium dark:text-slate-300"><span>êµ¬ë§¤ì²˜</span> <span className="font-bold dark:text-white">{activeBean.shop || '-'}</span></div><div className="flex justify-between items-center text-sm font-medium dark:text-slate-300"><span>êµ¬ë§¤ì¼</span> <span className="font-bold dark:text-white">{activeBean.purchaseDate || '-'}</span></div>{activeBean.weight && activeBean.price && (<div className="flex justify-between items-center text-sm font-medium dark:text-slate-300"><span>ê°€ê²© ({activeBean.weight}g)</span> <div className="text-right"><span className="font-bold block dark:text-white">{Number(activeBean.price).toLocaleString()}ì›</span><span className="text-[10px] text-slate-400">100gë‹¹ {calcPricePer100g(activeBean.price, activeBean.weight)}ì›</span></div></div>)}{activeBean.pricePerCup && (<div className="flex justify-between items-center text-sm font-medium pt-2 border-t border-dashed dark:border-slate-800 dark:text-slate-300"><span>í•œ ì” ê°€ê²©</span> <span className="font-bold text-amber-700 dark:text-amber-500">{Number(activeBean.pricePerCup).toLocaleString()}ì›</span></div>)}</div>
                                {activeBean.memo && <div className="bg-slate-50 dark:bg-slate-800 p-5 rounded-2xl border dark:border-slate-700 text-slate-600 dark:text-slate-300 text-sm whitespace-pre-wrap">{activeBean.memo}</div>}
                                <div className="pt-6 border-t dark:border-slate-800"><div className="flex justify-between items-center mb-4"><h2 className="font-black text-xl dark:text-white">ì‹œìŒ ê¸°ë¡</h2><div className="flex gap-2"><button onClick={() => { const updatedBeans = beans.map(b => String(b.id) === String(activeBean.id) ? { ...b, isFinished: !b.isFinished } : b); if(safeStorage.set(`${STORAGE_KEY}_data`, updatedBeans)) { setBeans(updatedBeans); } }} className={`px-3 py-1.5 rounded-full text-xs font-bold border transition-colors ${activeBean.isFinished ? 'bg-slate-200 dark:bg-slate-800 text-slate-500 dark:text-slate-400 border-transparent' : 'bg-white dark:bg-slate-900 text-slate-700 dark:text-slate-300 border-slate-200 dark:border-slate-700'}`}>{activeBean.isFinished ? "ì›ë‘ ì†Œì§„ë¨" : "ì›ë‘ ë³´ìœ  ì¤‘"}</button><button onClick={() => { setTastingForm({...INITIAL_TASTING}); setEditTastingIdx(null); updateView(VIEW.EDIT_TASTING, activeBean.id); }} className="bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 px-3 py-1.5 rounded-full text-xs font-bold">+ ì¶”ê°€</button></div></div>{activeBean.tastings.length === 0 ? <p className="text-center text-slate-400 text-xs py-4">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p> : (<div className="space-y-3">{activeBean.tastings.map((t, idx) => (
                                    <div key={idx} 
                                        className="bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl border dark:border-slate-700 flex items-center gap-4 active:scale-95 cursor-pointer relative overflow-hidden select-none" 
                                        onTouchStart={() => handleTouchStart(idx)} onTouchEnd={handleTouchEnd} onMouseDown={() => handleTouchStart(idx)} onMouseUp={handleTouchEnd} onMouseLeave={handleTouchEnd}
                                        onContextMenu={(e) => { e.preventDefault(); setTastingMenuIdx(idx); }}
                                        onClick={() => { if (isLongPress.current) return; if (tastingMenuIdx !== null) { setTastingMenuIdx(null); return; } setTastingForm(t); setEditTastingIdx(idx); updateView(VIEW.EDIT_TASTING, activeBean.id); }}
                                    >
                                        <div className="w-12 h-12 bg-white dark:bg-slate-900 rounded-xl flex items-center justify-center font-black border dark:border-slate-700 text-sm dark:text-white">{getDisplayScore(t)}</div>
                                        <div className="flex-1 min-w-0"><p className="font-bold text-sm mb-1 dark:text-white">{t.date}</p><div className="flex flex-wrap gap-1">{t.notes ? parseTags(t.notes).map((n, i) => <span key={i} className="text-[10px] bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300 px-1.5 py-0.5 rounded border dark:border-slate-600">{n}</span>) : <span className="text-xs text-slate-300">ë…¸íŠ¸ ì—†ìŒ</span>}</div></div>
                                        {tastingMenuIdx === idx && (
                                            <div className="absolute inset-0 bg-slate-900/95 z-20 flex items-center justify-center gap-6 animate-in fade-in" 
                                                onClick={(e) => e.stopPropagation()}
                                                onMouseDown={(e) => e.stopPropagation()}
                                                onTouchStart={(e) => e.stopPropagation()}
                                            >
                                                <button onClick={(e) => { e.stopPropagation(); setShareData({ bean: activeBean, tasting: t }); setTastingMenuIdx(null); }} className="flex flex-col items-center text-white gap-1"><div className="p-2 bg-slate-800 rounded-full"><ImageIcon size={20}/></div><span className="text-[10px] font-bold">ì´ë¯¸ì§€ ê³µìœ </span></button>
                                                <button onClick={(e) => { e.stopPropagation(); handleTextShare(activeBean, t); }} className="flex flex-col items-center text-white gap-1"><div className="p-2 bg-slate-800 rounded-full"><FileText size={20}/></div><span className="text-[10px] font-bold">í…ìŠ¤íŠ¸ ê³µìœ </span></button>
                                                <button onClick={(e) => { e.stopPropagation(); handleDeleteTastingItem(idx); }} className="flex flex-col items-center text-red-400 gap-1"><div className="p-2 bg-red-900/20 rounded-full"><Trash2 size={20}/></div><span className="text-[10px] font-bold">ì‚­ì œ</span></button>
                                                <button onClick={(e) => { e.stopPropagation(); setTastingMenuIdx(null); }} className="absolute top-0 right-0 p-4 text-slate-500 hover:text-slate-300"><X size={20}/></button>
                                            </div>
                                        )}
                                    </div>
                                ))}</div>)}</div>
                            </div>
                        </main>
                    </div>
                )}

                {view === VIEW.EDIT_BEAN && (
                    <div className="flex flex-col h-full bg-white dark:bg-slate-900">
                        <header className="p-4 pt-4 border-b dark:border-slate-800 flex justify-between items-center sticky top-0 z-10 bg-white dark:bg-slate-900"><button onClick={() => { goBack(); }} className="p-2"><ChevronLeft/></button><h1 className="font-black dark:text-white">ì›ë‘ ì…ë ¥</h1><button onClick={handleSaveBean} disabled={isSaving} className="bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 px-4 py-2 rounded-full text-xs font-bold disabled:bg-slate-300 dark:disabled:bg-slate-700">{isSaving ? 'ì €ì¥...' : 'ì™„ë£Œ'}</button></header>
                        <main className="flex-1 overflow-y-auto p-6 space-y-6 pb-64">
                            <div className="flex gap-4"><label className="flex-1 aspect-square bg-slate-100 dark:bg-slate-800 rounded-2xl flex flex-col items-center justify-center border-2 border-dashed dark:border-slate-700 relative overflow-hidden active:scale-95 transition-transform">{beanForm.mainImage ? <img src={beanForm.mainImage} className="w-full h-full object-cover"/> : <><Camera size={24} className="text-slate-400"/><span className="text-[10px] font-bold text-slate-400 mt-1">ëŒ€í‘œì‚¬ì§„</span></>}<input type="file" className="hidden" accept="image/*" onChange={(e) => onSelectFile(e, 'main')} /></label><label className="flex-1 aspect-square bg-blue-50 dark:bg-blue-900/20 rounded-2xl flex flex-col items-center justify-center border-2 border-dashed border-blue-200 dark:border-blue-900/30 relative overflow-hidden active:scale-95 transition-transform">{tempOcrImage ? <><img src={tempOcrImage} className="w-full h-full object-cover opacity-50"/><CheckCircle2 className="absolute text-blue-600" size={24}/></> : <><FileText size={24} className="text-blue-400"/><span className="text-[10px] font-bold text-blue-400 mt-1">OCR ë¶„ì„ìš©</span></>}<input type="file" className="hidden" accept="image/*" onChange={(e) => onSelectFile(e, 'ocr')} /></label></div><button onClick={runOCR} disabled={isProcessing} className="w-full py-3 bg-blue-100 dark:bg-blue-900/40 text-blue-900 dark:text-blue-300 font-bold rounded-2xl flex items-center justify-center gap-2">{isProcessing ? <RefreshCw className="animate-spin" size={16}/> : <Zap size={16}/>} {isProcessing ? "ë¶„ì„ ì¤‘..." : "AI ì •ë³´ ìë™ ì…ë ¥"}</button>
                            <div className="space-y-4"><input className="w-full text-2xl font-black border-b dark:border-slate-800 py-2 outline-none bg-transparent dark:text-white" placeholder="ì›ë‘ ì´ë¦„ (í•„ìˆ˜)" value={beanForm.name} onChange={e => setBeanForm({...beanForm, name: e.target.value})}/>
                            <div className="flex items-center gap-3 p-4 bg-slate-50 dark:bg-slate-800 rounded-xl"><input type="checkbox" checked={beanForm.isBlend} onChange={e => setBeanForm({...beanForm, isBlend: e.target.checked})} className="w-5 h-5 accent-slate-900"/><label className="text-sm font-bold text-slate-700 dark:text-slate-300">ë¸”ë Œë“œ ì›ë‘ (Blend)</label></div>
                            {beanForm.isBlend ? (
                                <div className="space-y-3 bg-slate-50 dark:bg-slate-800 p-4 rounded-xl">
                                    <div className="flex justify-between items-center"><h3 className="text-xs font-bold text-slate-400 uppercase">ë¸”ë Œë”© ì •ë³´</h3><button onClick={addBlendInfo} className="text-xs font-bold text-blue-500">+ ì¶”ê°€</button></div>
                                    {(beanForm.blendInfo || []).map((info, idx) => (
                                        <div key={idx} className="relative border-t border-slate-200 dark:border-slate-700 pt-3 mt-3 first:border-t-0 first:pt-0 first:mt-0">
                                            <div className="space-y-2">
                                                <div className="flex gap-2">
                                                    <input className="flex-1 bg-white dark:bg-slate-900 dark:text-white p-2 rounded-lg text-sm font-bold outline-none border border-slate-200 dark:border-slate-700" placeholder="êµ­ê°€" value={info.country} onChange={e => updateBlendInfo(idx, 'country', e.target.value)} />
                                                    <input className="w-24 bg-white dark:bg-slate-900 dark:text-white p-2 rounded-lg text-sm font-bold outline-none border border-slate-200 dark:border-slate-700" placeholder="ë¹„ìœ¨ (%)" value={info.ratio} onChange={e => updateBlendInfo(idx, 'ratio', e.target.value)} />
                                                </div>
                                                <input className="w-full bg-white dark:bg-slate-900 dark:text-white p-2 rounded-lg text-sm font-bold outline-none border border-slate-200 dark:border-slate-700" placeholder="í’ˆì¢…" value={info.variety} onChange={e => updateBlendInfo(idx, 'variety', e.target.value)} />
                                            </div>
                                            <button onClick={() => removeBlendInfo(idx)} className="absolute top-3 right-0 p-1 text-slate-400 hover:text-red-500"><X size={14}/></button>
                                        </div>
                                    ))}
                                    {(!beanForm.blendInfo || beanForm.blendInfo.length === 0) && <div className="text-center text-xs text-slate-400 py-2">ë¸”ë Œë”© ì •ë³´ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.</div>}
                                    <input className="w-full bg-white dark:bg-slate-900 dark:text-white p-3 rounded-xl text-sm font-bold outline-none border border-slate-200 dark:border-slate-700 mt-2" placeholder="ë¡œìŠ¤íŒ… í¬ì¸íŠ¸" value={beanForm.roastingLevel} onChange={e => setBeanForm({...beanForm, roastingLevel: e.target.value})}/>
                                </div>
                            ) : (
                                <><div className="grid grid-cols-2 gap-3"><input className="bg-slate-50 dark:bg-slate-800 dark:text-white p-3 rounded-xl text-sm font-bold outline-none" placeholder="ë‚˜ë¼ (Country)" value={beanForm.country} onChange={e => setBeanForm({...beanForm, country: e.target.value})}/><input className="bg-slate-50 dark:bg-slate-800 dark:text-white p-3 rounded-xl text-sm font-bold outline-none" placeholder="ì§€ì—­ (Region)" value={beanForm.region} onChange={e => setBeanForm({...beanForm, region: e.target.value})}/><input className="bg-slate-50 dark:bg-slate-800 dark:text-white p-3 rounded-xl text-sm font-bold outline-none" placeholder="í’ˆì¢…" value={beanForm.variety} onChange={e => setBeanForm({...beanForm, variety: e.target.value})}/><input className="bg-slate-50 dark:bg-slate-800 dark:text-white p-3 rounded-xl text-sm font-bold outline-none" placeholder="ê°€ê³µ ë°©ì‹" value={beanForm.processing} onChange={e => setBeanForm({...beanForm, processing: e.target.value})}/><input className="bg-slate-50 dark:bg-slate-800 dark:text-white p-3 rounded-xl text-sm font-bold outline-none" placeholder="ê³ ë„ (m)" value={beanForm.altitude} onChange={e => setBeanForm({...beanForm, altitude: e.target.value})}/><input className="bg-slate-50 dark:bg-slate-800 dark:text-white p-3 rounded-xl text-sm font-bold outline-none" placeholder="ë¡œìŠ¤íŒ… í¬ì¸íŠ¸" value={beanForm.roastingLevel} onChange={e => setBeanForm({...beanForm, roastingLevel: e.target.value})}/></div><input className="w-full bg-slate-50 dark:bg-slate-800 dark:text-white p-3 rounded-xl text-sm font-bold outline-none" placeholder="ìƒì‚°ì/ë†ì¥" value={beanForm.producer} onChange={e => setBeanForm({...beanForm, producer: e.target.value})}/></>
                            )}
                            <div className="bg-slate-50 dark:bg-slate-800 p-3 rounded-xl flex flex-col justify-center"><label className="text-[10px] font-bold text-slate-400 uppercase mb-1">ë¡œìŠ¤íŒ… ë‚ ì§œ</label><input type="date" className="bg-transparent font-bold outline-none w-full dark:text-white" value={beanForm.roastingDate} onChange={e => setBeanForm({...beanForm, roastingDate: e.target.value})}/></div><div className="space-y-3 pt-2"><h3 className="text-xs font-bold text-slate-400 uppercase">êµ¬ë§¤ ì •ë³´</h3><div className="bg-slate-50 dark:bg-slate-800 p-3 rounded-xl flex flex-col justify-center"><label className="text-[10px] font-bold text-slate-400 uppercase mb-1">êµ¬ë§¤ì¼ (Purchase Date)</label><input type="date" className="bg-transparent font-bold outline-none w-full dark:text-white" value={beanForm.purchaseDate} onChange={e => setBeanForm({...beanForm, purchaseDate: e.target.value})}/></div><div className="space-y-1"><label className="text-xs font-bold text-slate-500 dark:text-slate-400 ml-1">êµ¬ë§¤ì²˜ (Shop)</label><div className="relative"><ShoppingBag className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18}/><input list="shop-suggestions" className="w-full bg-slate-100 dark:bg-slate-800 dark:text-white p-3 pl-10 rounded-xl text-sm font-bold outline-none" placeholder="ì˜ˆ: Momos Coffee" value={beanForm.shop} onChange={handleShopChange}/><datalist id="shop-suggestions">{[...new Set(beans.map(b => b.shop).filter(Boolean))].map((shop, i) => (<option key={i} value={shop} />))}</datalist></div></div><input className="w-full bg-slate-50 dark:bg-slate-800 dark:text-white p-3 rounded-xl text-sm font-bold outline-none" placeholder="êµ¬ë§¤ URL (http://...)" value={beanForm.purchaseUrl} onChange={e => setBeanForm({...beanForm, purchaseUrl: e.target.value})}/><div className="grid grid-cols-2 gap-3"><div className="col-span-2"></div><input className="bg-slate-50 dark:bg-slate-800 dark:text-white p-3 rounded-xl text-sm font-bold outline-none" placeholder="ìš©ëŸ‰ (g)" value={beanForm.weight} onChange={e => setBeanForm({...beanForm, weight: e.target.value})}/><input className="bg-slate-50 dark:bg-slate-800 dark:text-white p-3 rounded-xl text-sm font-bold outline-none" placeholder="ê°€ê²© (ì›)" value={beanForm.price} onChange={e => setBeanForm({...beanForm, price: e.target.value})}/></div><input className="w-full bg-slate-50 dark:bg-slate-800 dark:text-white p-3 rounded-xl text-sm font-bold outline-none" placeholder="í•œ ì” ê°€ê²© (ì¹´í˜)" value={beanForm.pricePerCup} onChange={e => setBeanForm({...beanForm, pricePerCup: e.target.value})}/></div><div className="space-y-2"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Flavor Keywords</label><div className="relative"><input className="w-full bg-amber-50 dark:bg-amber-900/20 p-4 pr-12 rounded-xl text-sm font-bold text-amber-900 dark:text-amber-400 outline-none placeholder-amber-900/30" placeholder="ë² ë¦¬, ì´ˆì½œë¦¿ (ì½¤ë§ˆ êµ¬ë¶„)" value={beanForm.notes} onChange={e => setBeanForm({...beanForm, notes: e.target.value})}/><button onClick={() => { setPickerTarget('bean'); setShowFlavorPicker(true); }} className="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-white dark:bg-slate-800 rounded-lg shadow-sm text-amber-600 dark:text-amber-400 border border-amber-100 dark:border-amber-900/30"><Palette size={16}/></button></div></div><textarea className="w-full bg-amber-50 dark:bg-amber-900/20 p-4 rounded-2xl h-24 text-sm font-medium text-amber-900 dark:text-amber-400 outline-none resize-none" placeholder="í–¥ë¯¸ì— ëŒ€í•œ ìì„¸í•œ ì„¤ëª… (ì¤„ê¸€)" value={beanForm.flavorDesc} onChange={e => setBeanForm({...beanForm, flavorDesc: e.target.value})}/><textarea className="w-full bg-slate-50 dark:bg-slate-800 dark:text-white p-4 rounded-2xl h-24 text-sm outline-none resize-none" placeholder="ë©”ëª¨" value={beanForm.memo} onChange={e => setBeanForm({...beanForm, memo: e.target.value})}/></div>
                            {selectedId && <button onClick={handleDelete} className="w-full py-4 text-red-500 font-bold bg-red-50 dark:bg-red-900/20 rounded-2xl flex items-center justify-center gap-2"><Trash2 size={18}/> ì‚­ì œ</button>}
                        </main>
                    </div>
                )}

                {view === VIEW.EDIT_TASTING && (
                    <div className="flex flex-col h-full bg-white dark:bg-slate-900">
                        <header className="p-4 border-b dark:border-slate-800 flex justify-between items-center sticky top-0 z-10 bg-white dark:bg-slate-900"><button onClick={() => { goBack(); }} className="p-2"><ChevronLeft/></button><h1 className="font-black dark:text-white">í‰ê°€ ì‘ì„±</h1><button onClick={handleSaveTasting} disabled={isSaving} className="bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 px-5 py-2 rounded-full text-xs font-bold disabled:bg-slate-300 dark:disabled:bg-slate-700">{isSaving ? 'ì €ì¥...' : 'ì™„ë£Œ'}</button></header>
                        <main className="flex-1 overflow-y-auto p-6 space-y-8 pb-64">
                            <input type="date" className="w-full bg-slate-50 dark:bg-slate-800 dark:text-white p-3 rounded-2xl text-center font-bold outline-none" value={tastingForm.date} onChange={e => setTastingForm({...tastingForm, date: e.target.value})}/>
                            <div className="flex items-center justify-between"><div className="text-center flex-1 flex flex-col items-center"><div className="relative"><div className="inline-flex items-center justify-center w-24 h-24 bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 rounded-3xl text-4xl font-black shadow-xl mb-2">{tastingForm.isManualTotal ? (<input type="number" className="w-full bg-transparent text-center text-white dark:text-slate-900 outline-none" value={tastingForm.totalScore || ""} onChange={(e) => setTastingForm(prev => ({ ...prev, totalScore: e.target.value }))} placeholder="0.0"/>) : ( calcAvg(tastingForm.scores) )}</div><button onClick={() => setTastingForm(prev => { const nextMode = !prev.isManualTotal; return { ...prev, isManualTotal: nextMode, totalScore: nextMode ? calcAvg(prev.scores) : undefined }; })} className="absolute -right-2 -top-2 bg-white dark:bg-slate-800 text-slate-900 dark:text-white p-1.5 rounded-full shadow-md border dark:border-slate-700">{tastingForm.isManualTotal ? <Calculator size={12}/> : <PenTool size={12}/>}</button></div><p className="text-[10px] font-bold text-slate-400 uppercase">{tastingForm.isManualTotal ? "Manual Score" : "Total Score"}</p></div><div className="flex-1 flex justify-center"><RadarChart scores={tastingForm.scores} /></div></div>
                            <div className="grid grid-cols-2 gap-3">{TASTE_ITEMS.map(item => (<div key={item.id} className="bg-slate-50 dark:bg-slate-800 p-3 rounded-2xl flex flex-col items-center justify-center gap-2"><span className="text-xs font-bold uppercase text-slate-500 dark:text-slate-400">{item.label}</span><div className="flex items-center gap-2"><ScoreButton onClick={() => updateScore(item.id, -0.1)} icon={<Minus size={14} className="text-slate-400"/>} /><input type="number" value={tastingForm.scores[item.id]} onChange={(e) => setTastingForm(prev => ({ ...prev, scores: { ...prev.scores, [item.id]: e.target.value } }))} className="w-12 text-center font-black text-xl bg-transparent outline-none p-0 m-0 border-0 focus:ring-0 dark:text-white" /><ScoreButtonPlus onClick={() => updateScore(item.id, +0.1)} icon={<Plus size={14} className="text-white"/>} /></div></div>))}</div>
                            <div className="space-y-2"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Keywords</label><div className="relative"><input className="w-full bg-amber-50 dark:bg-amber-900/20 p-4 pr-12 rounded-xl text-sm font-bold text-amber-900 dark:text-amber-400 outline-none placeholder-amber-900/30" placeholder="ì‚°ë¯¸, ë‹¨ë§› (ì½¤ë§ˆ êµ¬ë¶„)" value={tastingForm.notes} onChange={e => setTastingForm({...tastingForm, notes: e.target.value})}/><button onClick={() => { setPickerTarget('tasting'); setShowFlavorPicker(true); }} className="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-white dark:bg-slate-800 rounded-lg shadow-sm text-amber-600 dark:text-amber-400 border border-amber-100 dark:border-amber-900/30"><Palette size={16}/></button></div></div>
                            <textarea className="w-full bg-amber-50 dark:bg-amber-900/20 p-4 rounded-2xl h-24 text-sm font-medium text-amber-900 dark:text-amber-400 outline-none resize-none" placeholder="ë§›ì— ëŒ€í•œ ìì„¸í•œ í‰ê°€" value={tastingForm.desc} onChange={e => setTastingForm({...tastingForm, desc: e.target.value})}/><textarea className="w-full bg-slate-50 dark:bg-slate-800 dark:text-white p-4 rounded-2xl h-32 text-sm outline-none resize-none" placeholder="ë ˆì‹œí”¼ / ë©”ëª¨" value={tastingForm.memo} onChange={e => setTastingForm({...tastingForm, memo: e.target.value})}/>
                            {editTastingIdx !== null && (<button onClick={handleDeleteTasting} className="w-full py-4 text-red-500 font-bold bg-red-50 dark:bg-red-900/20 rounded-2xl flex items-center justify-center gap-2 mt-4"><Trash2 size={16}/> ì´ ê¸°ë¡ ì‚­ì œ</button>)}
                        </main>
                    </div>
                )}
            </div>
        );
    };

    // --- TIMER TAB ---
    const TimerTab = ({ active, setIsTimerRunning, navKey }) => { 
        // v54 Constants & Default Recipes (Restored)
        const DEFAULT_RECIPES = [
            { id: 1, title: "ê¸°ë³¸ í‘¸ì–´ ì˜¤ë²„ 20g", bean: "20", water: "60 80 80 80", interval: "30 30 30", endTime: "3:00", memo: "ë¬¼ ì˜¨ë„ëŠ” 93ë„ê°€ ì ë‹¹í•©ë‹ˆë‹¤.\nëœ¸ ë“¤ì´ê¸°ëŠ” 30ì´ˆ ì •ë„ ì§„í–‰í•´ì£¼ì„¸ìš”." },
            { id: 2, title: "10g í‘¸ì–´ì˜¤ë²„", bean: "10", water: "30 40 40 40", interval: "30 30 30", endTime: "2:10", memo: "" },
            { id: 3, title: "ìŠ¤ìœ„ì¹˜ 10g", bean: "10", water: "cl150 10g op", interval: "20 120", endTime: "3:20", memo: "ìŠ¤ìœ„ì¹˜ë¥¼ ë‹«ê³  ë¬¼ì„ í•œ ë²ˆì— ë¶“ìŠµë‹ˆë‹¤." },
            { id: 4, title: "ìŠ¤ìœ„ì¹˜ ë¦¬ë²„ìŠ¤ 15g", bean: "15", water: "cl30 15g 30 op 170", interval: "30 30 30 10", endTime: "3:00", memo: "ì¹¨ì¶œì‹ê³¼ íˆ¬ê³¼ì‹ì„ í˜¼í•©í•œ ë°©ì‹ì…ë‹ˆë‹¤." },
            { id: 5, title: "ë°ëª¨ìš©", bean: "15", water: "cl30 15g s30st op ct170sw sw", interval: "3 3 3 3 3", endTime: "0:20", memo: "ë‹¤ì–‘í•œ ì‚¬ìš© ì˜ˆì‹œ ë ˆì‹œí”¼ì…ë‹ˆë‹¤." }
        ];

        // Main Timer Logic
        const [mode, setMode] = useState('EDIT'); 
        const [recipe, setRecipe] = useState({...INITIAL_RECIPE});
        const [recipes, setRecipes] = useState(DEFAULT_RECIPES);
        const [showList, setShowList] = useState(false);
        const [showMemo, setShowMemo] = useState(false);
        const [timeline, setTimeline] = useState([]);
        const [time, setTime] = useState(0);
        const [run, setRun] = useState(false);
        const [stepIdx, setStepIdx] = useState(0);
        const scrollRef = useRef(null), itemRefs = useRef([]);
        
        // [New] Modal states for confirmation
        const [showSaveModal, setShowSaveModal] = useState(false);
        const [showDeleteModal, setShowDeleteModal] = useState(false);
        const [deleteTargetId, setDeleteTargetId] = useState(null);
        const [toast, setToast] = useState(null);

        const showToastMsg = (msg) => { setToast(msg); setTimeout(() => setToast(null), 3000); };

        useEffect(() => { 
            if (active) {
                const r = safeStorage.get(RECIPE_STORAGE_KEY); 
                if(r && Array.isArray(r) && r.length > 0) setRecipes(r);
                else setRecipes(DEFAULT_RECIPES); 
            }
        }, [active]);

        // Sync Timer State with App
        useEffect(() => {
            setIsTimerRunning(run);
        }, [run, setIsTimerRunning]);

        const openRecipeList = () => {
            window.history.pushState({ tab: TAB.TIMER, modal: 'LIST' }, '');
            setShowList(true);
        };
        useEffect(() => {
            if (active && !run) openRecipeList();
        }, [active, navKey]);

        const openMemo = () => {
             window.history.pushState({ tab: TAB.TIMER, modal: 'MEMO' }, '');
             setShowMemo(true);
        };
        const handleSettingClick = () => {
            setRun(false);
            setMode('EDIT');
            window.history.replaceState({ tab: TAB.TIMER, mode: 'EDIT' }, '');
        };

        useEffect(() => {
            const handlePop = (event) => {
                if(!active) return;
                
                const modal = event.state ? event.state.modal : null;
                setShowList(modal === 'LIST');
                setShowMemo(modal === 'MEMO');
                setShowSaveModal(modal === 'SAVE');
                setShowDeleteModal(modal === 'DELETE');

                if (mode === 'TIMER') { 
                     if (!event.state || event.state.mode !== 'TIMER') {
                         setMode('EDIT'); 
                         setRun(false); 
                     }
                }
            };
            window.addEventListener('popstate', handlePop);
            return () => window.removeEventListener('popstate', handlePop);
        }, [active, mode]);

        useEffect(() => {
            let wakeLock = null;
            const requestWakeLock = async () => { if ('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) { console.log('Wake Lock Error:', err); } } };
            const releaseWakeLock = async () => { if (wakeLock !== null) { await wakeLock.release(); wakeLock = null; } };
            if (active && mode === 'TIMER') { requestWakeLock(); } else { releaseWakeLock(); }
            return () => { releaseWakeLock(); };
        }, [active, mode]); 

        const goBackFromTimer = () => { window.history.back(); };

        useEffect(() => { let i; if(run) i = setInterval(() => setTime(p=>{ if(p>=timeline[timeline.length-1]?.startTime){setRun(false);return p;} return p+1; }), 1000); return ()=>clearInterval(i); }, [run, timeline]);
        
        const scrollToStep = (index) => {
            const list = scrollRef.current;
            if (!list) return;
            if (index === 0) { list.scrollTo({ top: 0, behavior: 'smooth' }); return; }
            const item = itemRefs.current[index];
            if (item) { 
                const containerHeight = list.clientHeight;
                const itemHeight = item.clientHeight;
                const targetTop = item.offsetTop - (containerHeight / 2) + (itemHeight / 2);
                list.scrollTo({ top: targetTop, behavior: 'smooth' }); 
            }
        };

        useLayoutEffect(() => { if (active && mode === 'TIMER') { scrollToStep(stepIdx); } }, [stepIdx, mode, active]);
        useEffect(() => { if(mode==='TIMER') { const idx = timeline.findLastIndex(s=>s.startTime<=time); if(idx!==-1) setStepIdx(idx); } }, [time, mode]);

        // [Fix] Save Modal Logic
        const handleSaveRequest = () => {
            if (!recipe.title?.trim()) {
                showToastMsg("ë¹ˆì¹¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
                return;
            }
            window.history.pushState({ tab: TAB.TIMER, modal: 'SAVE' }, '');
            setShowSaveModal(true);
        };

        const confirmSave = (isOverwrite) => {
            let updatedRecipes;
            if (isOverwrite && recipe.id) {
                updatedRecipes = recipes.map(r => r.id === recipe.id ? recipe : r);
            } else {
                updatedRecipes = [...recipes, { ...recipe, id: Date.now() }];
            }
            setRecipes(updatedRecipes);
            safeStorage.set(RECIPE_STORAGE_KEY, updatedRecipes);
            // Close modal by going back
            window.history.back();
        };

        const loadR = (r) => { 
            setRecipe(r); 
            if (mode === 'TIMER') {
                setTimeline(parseRecipe(r));
                setTime(0);
                setRun(false);
                setStepIdx(0);
                if (scrollRef.current) scrollRef.current.scrollTo({ top: 0, behavior: 'smooth' });
            }
            // [Fix] Close list modal
            if (showList) window.history.back(); 
        };

        // [Fix] Delete Modal Logic
        const handleDelRequest = (id, e) => { 
            e.stopPropagation(); 
            setDeleteTargetId(id);
            window.history.pushState({ tab: TAB.TIMER, modal: 'DELETE' }, '');
            setShowDeleteModal(true);
        };
        
        const confirmDelete = () => {
            if (deleteTargetId) {
                const n = recipes.filter(r => r.id !== deleteTargetId);
                setRecipes(n);
                safeStorage.set(RECIPE_STORAGE_KEY, n);
            }
            window.history.back();
        };
        
        const startBrewing = () => { 
            if (!recipe.title?.trim() || !recipe.bean?.trim() || !recipe.water?.trim() || !recipe.interval?.trim() || !recipe.endTime?.trim()) {
                showToastMsg("ë¹ˆì¹¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
                return;
            }
            const newTimeline = parseRecipe(recipe);
            setTimeline(newTimeline); 
            // Push history for Timer Mode
            window.history.pushState({ tab: TAB.TIMER, mode: 'TIMER' }, ''); 
            setMode('TIMER'); 
            setTime(0); 
            setRun(false); 
            setStepIdx(0); 
        };
        const handleReset = () => { setRun(false); setTime(0); setStepIdx(0); if (scrollRef.current) { scrollRef.current.scrollTo({ top: 0, behavior: 'smooth' }); } };
        const toggleRun = () => { if (!run && time === 0) { if (scrollRef.current) scrollRef.current.scrollTo({ top: 0, behavior: 'smooth' }); } setRun(!run); };
        
        const curStep = timeline[stepIdx] || {};
        const curRatio = useMemo(()=>calculateRatio(recipe.bean, recipe.water),[recipe.bean,recipe.water]);

        return (
            <div className={`h-full flex flex-col bg-slate-50 dark:bg-slate-950 relative ${active ? 'block' : 'hidden'}`}>
                {toast && <div className="fixed top-10 left-1/2 -translate-x-1/2 bg-slate-900/90 text-white px-6 py-3 rounded-full text-xs font-bold shadow-xl z-[120] whitespace-nowrap animate-in fade-in slide-in-from-top-2">{toast}</div>}

                {/* [Fix] Save Modal */}
                {showSaveModal && (
                    <div className="absolute inset-0 z-[110] bg-black/50 dark:bg-black/70 flex items-center justify-center p-4 animate-in fade-in" onClick={() => window.history.back()}>
                        <div className="bg-white dark:bg-slate-900 w-full max-w-xs rounded-2xl p-5 shadow-xl animate-pop" onClick={e => e.stopPropagation()}>
                            <h3 className="text-lg font-bold mb-3 text-slate-900 dark:text-white">ë ˆì‹œí”¼ ì €ì¥</h3>
                            <div className="flex flex-col gap-2">
                                {recipe.id && (
                                    <button onClick={() => confirmSave(true)} className="w-full py-3 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-xl font-bold hover:bg-blue-100 dark:hover:bg-blue-900/30">
                                        ê¸°ì¡´ ë ˆì‹œí”¼ ë®ì–´ì“°ê¸°
                                    </button>
                                )}
                                <button onClick={() => confirmSave(false)} className="w-full py-3 bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 rounded-xl font-bold hover:bg-slate-800 dark:hover:bg-slate-200">
                                    ìƒˆ ë ˆì‹œí”¼ë¡œ ì €ì¥
                                </button>
                                <button onClick={() => window.history.back()} className="w-full py-3 text-slate-400 font-bold hover:text-slate-600 dark:hover:text-slate-300">
                                    ì·¨ì†Œ
                                </button>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* [Fix] Delete Modal */}
                {showDeleteModal && (
                    <div className="absolute inset-0 z-[110] bg-black/50 dark:bg-black/70 flex items-center justify-center p-4 animate-in fade-in" onClick={() => window.history.back()}>
                        <div className="bg-white dark:bg-slate-900 w-full max-w-xs rounded-2xl p-5 shadow-xl animate-pop" onClick={e => e.stopPropagation()}>
                            <div className="flex flex-col items-center gap-2 mb-4">
                                <div className="w-10 h-10 bg-red-50 dark:bg-red-900/20 text-red-500 dark:text-red-400 rounded-full flex items-center justify-center">
                                    <Trash2 size={20} />
                                </div>
                                <h3 className="text-lg font-bold text-slate-900 dark:text-white">ë ˆì‹œí”¼ ì‚­ì œ</h3>
                                <p className="text-sm text-slate-500 dark:text-slate-400 text-center">ì´ ë ˆì‹œí”¼ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br/>ì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => window.history.back()} className="flex-1 py-3 bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 rounded-xl font-bold hover:bg-slate-200 dark:hover:bg-slate-700">
                                    ì·¨ì†Œ
                                </button>
                                <button onClick={confirmDelete} className="flex-1 py-3 bg-red-500 dark:bg-red-600 text-white rounded-xl font-bold hover:bg-red-600 dark:hover:bg-red-700">
                                    ì‚­ì œ
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Modal: Recipe List */}
                {showList && (
                    <div className="absolute inset-0 z-[100] bg-black/50 dark:bg-black/70 flex items-end" onClick={()=>window.history.back()}>
                        <div className="w-full bg-white dark:bg-slate-900 rounded-t-3xl h-[85%] p-5 flex flex-col animate-slide-up" onClick={e=>e.stopPropagation()}>
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="font-bold text-lg dark:text-white">Saved Recipes</h2>
                                <div className="flex items-center gap-3">
                                    <button onClick={() => { setRecipe({...INITIAL_RECIPE, id: Date.now()}); setRun(false); setMode('EDIT'); window.history.back(); }} className="px-3 py-1.5 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 rounded-full text-xs font-bold flex items-center gap-1"><Plus size={14}/> NEW</button>
                                    <X onClick={()=>window.history.back()} className="cursor-pointer text-slate-400"/>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto space-y-3 pb-10">
                                {recipes.map(r=>(
                                    <div key={r.id} onClick={()=>loadR(r)} className="bg-slate-50 dark:bg-slate-800 p-4 rounded-xl border dark:border-slate-700 flex justify-between items-center active:scale-95 transition-transform cursor-pointer">
                                        <div className="flex items-center gap-3">
                                            <div><h3 className="font-bold dark:text-white">{r.title}</h3><span className="text-xs text-slate-500 dark:text-slate-400 flex items-center gap-1"><CustomBeanIcon size={10} className="text-amber-700 dark:text-amber-500"/> {r.bean}g <span className="text-slate-300 dark:text-slate-600">Â·</span> <Calculator size={10} className="text-orange-400"/> {calculateRatio(r.bean, r.water)} <Droplet size={10} className="text-blue-400 ml-1"/> {r.water}</span></div>
                                        </div>
                                        <button onClick={(e)=>handleDelRequest(r.id,e)} className="p-2"><Trash2 size={16} className="text-slate-300 hover:text-red-500"/></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                )}
                
                <header className="p-4 pt-4 flex justify-between items-center bg-white dark:bg-slate-900 border-b dark:border-slate-800 sticky top-0 z-10">
                    <h1 className="text-xl font-black text-slate-900 dark:text-white flex items-center gap-2"><Timer className="text-blue-500"/> Brewing Timer</h1>
                    <div className="flex gap-2">
                        <button onClick={openRecipeList} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-500 dark:text-slate-400"><List size={18}/></button>
                        {mode==='TIMER' && <><button onClick={openMemo} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-500 dark:text-slate-400 hover:text-amber-500"><StickyNote size={18}/></button><button onClick={handleSettingClick} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-500 dark:text-slate-400"><Settings size={18}/></button></>}
                        {mode==='EDIT' && <button onClick={()=>setRecipe({...INITIAL_RECIPE, id: Date.now()})} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-blue-500 dark:text-blue-400 font-bold text-xs flex items-center gap-1"><Plus size={14}/> NEW</button>}
                    </div>
                </header>

                {mode === 'EDIT' && (
                    <div className="flex-1 overflow-y-auto p-6 pb-24 space-y-4">
                        <div className="mb-2"><div className="flex justify-between items-end mb-1"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Name</label><span className="text-xs font-bold text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 px-2 py-0.5 rounded-lg flex items-center gap-1"><Calculator size={12}/> {curRatio}</span></div><input className="w-full text-2xl font-bold font-brand bg-slate-100 dark:bg-slate-800 dark:text-white rounded-xl p-3 outline-none" value={recipe.title} onChange={e=>setRecipe({...recipe,title:e.target.value})} placeholder="ë ˆì‹œí”¼ ì´ë¦„"/></div>
                        <div><label className="text-xs font-bold text-slate-500 dark:text-slate-400">ì›ë‘ (g)</label><input className="w-full bg-slate-100 dark:bg-slate-800 dark:text-white p-3 rounded-xl font-bold outline-none border border-transparent focus:border-blue-200" value={recipe.bean} onChange={e=>setRecipe({...recipe,bean:e.target.value})}/></div>
                        <div><label className="text-xs font-bold text-slate-500 dark:text-slate-400">ë¬¼/ëª…ë ¹ì–´ (ex: cl 60 sw)</label><input className="w-full bg-slate-100 dark:bg-slate-800 dark:text-white p-3 rounded-xl font-bold outline-none border border-transparent focus:border-blue-200" value={recipe.water} onChange={e=>setRecipe({...recipe,water:e.target.value})}/>
                            <div className="bg-slate-50 dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-xl p-3 mt-2"><h4 className="text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-wider border-b border-slate-200 dark:border-slate-700 pb-1">Command Guide</h4><div className="grid grid-cols-2 gap-y-1 gap-x-2 text-[11px] text-slate-500 dark:text-slate-400 font-medium"><div className="flex items-center gap-1"><Droplet size={11} className="text-blue-400"/> <span className="text-slate-800 dark:text-slate-200 font-bold">60</span> : ë¬¼ 60ml</div><div className="flex items-center gap-1"><CustomBeanIcon size={11} className="text-amber-700 dark:text-amber-500"/> <span className="text-slate-800 dark:text-slate-200 font-bold">20g</span> : ì›ë‘ 20g</div><div>ğŸ”’ <span className="text-slate-800 dark:text-slate-200 font-bold">cl</span> : ìŠ¤ìœ„ì¹˜ ë‹«ê¸°</div><div>ğŸ”“ <span className="text-slate-800 dark:text-slate-200 font-bold">op</span> : ìŠ¤ìœ„ì¹˜ ì—´ê¸°</div><div>ğŸ¥„ <span className="text-slate-800 dark:text-slate-200 font-bold">st</span> : ì “ê¸°</div><div>ğŸ‘‹ <span className="text-slate-800 dark:text-slate-200 font-bold">sw</span> : í”ë“¤ê¸°</div><div>â­• <span className="text-slate-800 dark:text-slate-200 font-bold">c</span> : ì›í˜• í‘¸ì–´</div><div>ğŸŒ€ <span className="text-slate-800 dark:text-slate-200 font-bold">s</span> : ë‚˜ì„  í‘¸ì–´</div><div>ğŸ¯ <span className="text-slate-800 dark:text-slate-200 font-bold">ct</span> : ì¤‘ì•™ í‘¸ì–´</div></div><div className="mt-2 text-[11px] text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 px-2 py-1 rounded">âœ¨ <b>ì¡°í•© ì˜ˆì‹œ:</b> cl60sw <span className="text-blue-400 text-[10px]">(ë‹«ê³  60ml ë¶“ê³  í”ë“¤ê¸°)</span></div></div></div>
                        <div className="flex gap-2"><div><label className="text-xs font-bold text-slate-500 dark:text-slate-400">ê°„ê²© (ì´ˆ)</label><input className="w-full bg-slate-100 dark:bg-slate-800 dark:text-white p-3 rounded-xl font-bold outline-none border border-transparent focus:border-blue-200" value={recipe.interval} onChange={e=>setRecipe({...recipe,interval:e.target.value})}/></div><div><label className="text-xs font-bold text-slate-500 dark:text-slate-400">ì¢…ë£Œ ì‹œê°„</label><input className="w-full bg-slate-100 dark:bg-slate-800 dark:text-white p-3 rounded-xl font-bold outline-none border border-transparent focus:border-blue-200" value={recipe.endTime} onChange={e=>setRecipe({...recipe,endTime:e.target.value})}/></div></div>
                        <textarea className="w-full bg-amber-50 dark:bg-amber-900/20 p-3 rounded-xl h-20 text-sm outline-none resize-none placeholder-amber-800/30 dark:text-amber-100" placeholder="ë©”ëª¨" value={recipe.memo} onChange={e=>setRecipe({...recipe,memo:e.target.value})}/>
                        <div className="flex gap-2 pt-2"><button onClick={handleSaveRequest} className="flex-1 py-3 bg-blue-100 dark:bg-blue-900/40 text-blue-600 dark:text-blue-300 rounded-xl font-bold flex justify-center gap-2"><Save size={18}/> ë ˆì‹œí”¼ ì €ì¥</button></div>
                        <button onClick={startBrewing} className="w-full py-4 bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 rounded-2xl font-bold text-lg shadow-lg flex justify-center gap-2"><Play size={20} fill="currentColor"/> íƒ€ì´ë¨¸ ì‹œì‘</button>
                    </div>
                )}

                {mode === 'TIMER' && (
                    <div className="flex-1 flex flex-col relative overflow-hidden">
                        <div className="bg-white dark:bg-slate-900 p-6 pb-4 rounded-b-[32px] shadow-sm z-10 text-center relative shrink-0"> 
                            <h2 className="text-lg font-bold truncate mb-1 dark:text-white">{recipe.title}</h2>
                            <div className="text-xs font-bold text-slate-400 mb-6 bg-slate-100 dark:bg-slate-800 px-3 py-1 rounded-full inline-flex items-center gap-1"><CustomBeanIcon size={12} className="text-amber-700 dark:text-amber-500"/> {recipe.bean}g <span className="mx-1">Â·</span> <Calculator size={12} className="text-orange-400"/> {curRatio}</div>
                            <div className="flex justify-center items-center gap-6 mb-6">
                                <button onClick={handleReset} className="w-14 h-14 shrink-0 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center text-slate-400 shadow-sm hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors"><RefreshCw size={22}/></button>
                                <span className="text-6xl font-bold font-brand tabular-nums tracking-tighter w-48 text-center dark:text-white">{formatTime(time)}</span>
                                <button onClick={toggleRun} className={`w-14 h-14 shrink-0 rounded-full flex items-center justify-center text-white shadow-lg transition-all active:scale-95 ${run?'bg-amber-100 dark:bg-amber-900/40 text-amber-600 dark:text-amber-400':'bg-slate-900 dark:bg-slate-100 dark:text-slate-900'}`}>{run?<Pause size={24} fill="currentColor"/>:<Play size={24} fill="currentColor" className="ml-1"/>}</button>
                            </div>
                            <div className="w-full max-w-[320px] mx-auto bg-white dark:bg-slate-800 border-2 border-blue-500 shadow-xl rounded-2xl p-4 step-active flex items-center gap-4">
                                <div className="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-2 flex items-center justify-center border border-blue-100 dark:border-blue-900/30 w-[70px] shrink-0 h-[70px]">
                                    {curStep.icons?.length>0?curStep.icons.map((item, idx)=><MiniIcon key={idx} iconType={item.icon} isMain={item.type==='MAIN'}/>):<Clock size={20} className="text-slate-300"/>}
                                </div>
                                <div className="flex-1 text-center">
                                    <div className="text-2xl font-black text-slate-900 dark:text-white leading-none mb-1 break-keep">{curStep.desc}</div>
                                    {curStep.cumWater && (
                                        <div className="text-sm font-bold text-blue-500 mb-1">
                                            (ëˆ„ì  {curStep.cumWater}ml{curStep.pourCount ? ` â€¢ ${curStep.pourCount}ì°¨ í‘¸ì–´` : ''})
                                        </div>
                                    )}
                                    <div className="text-xs font-bold text-slate-400">{curStep.timeRange}</div>
                                </div>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto bg-slate-50 dark:bg-slate-950 relative no-scrollbar" ref={scrollRef}>
                            <div className="px-5 pt-6 pb-32 space-y-6 relative">
                                {timeline.map((s,i)=>(
                                    <div key={i} ref={el=>itemRefs.current[i]=el}>
                                        <TimerStepRow step={s} isCurrent={i===stepIdx} isPast={i<stepIdx} />
                                    </div>
                                ))}
                            </div>
                        </div>
                        {/* Modal: Memo */}
                        {showMemo && <div className="absolute inset-0 bg-black/60 dark:bg-black/80 z-50 flex items-end" onClick={()=>window.history.back()}><div className="w-full bg-white dark:bg-slate-900 rounded-t-3xl p-6" onClick={e=>e.stopPropagation()}><div className="flex justify-between mb-4"><h3 className="font-bold flex gap-2 dark:text-white"><StickyNote className="text-amber-500"/> Memo</h3><X onClick={()=>window.history.back()} className="dark:text-slate-400"/></div><div className="bg-amber-50 dark:bg-amber-900/20 p-4 rounded-2xl text-sm whitespace-pre-wrap min-h-[100px] dark:text-amber-100">{recipe.memo||"ë©”ëª¨ ì—†ìŒ"}</div></div></div>}
                    </div>
                )}
            </div>
        );
    };

    // --- STATS TAB ---
    const DashboardFilter = ({ selectedYear, onSelectYear, availableYears, selectedMonth, onSelectMonth, availableMonths }) => {
        const [isYearOpen, setIsYearOpen] = useState(false);
        const [isMonthOpen, setIsMonthOpen] = useState(false);
        return (
            <div className="flex gap-2 relative z-20">
                <div className="relative">
                    <button onClick={() => { setIsYearOpen(!isYearOpen); setIsMonthOpen(false); }} className="flex items-center gap-1.5 text-[11px] font-bold text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 pl-3 pr-2 py-1.5 rounded-xl shadow-sm active:scale-95 transition-transform"><span>{selectedYear === 'ALL' ? 'ì „ì²´ ê¸°ê°„' : `${selectedYear}ë…„`}</span><ChevronDown size={14} className={`text-slate-400 transition-transform duration-200 ${isYearOpen ? 'rotate-180' : ''}`}/></button>
                    {isYearOpen && (<><div className="fixed inset-0 z-10" onClick={() => setIsYearOpen(false)}></div><div className="absolute left-0 top-full mt-2 w-32 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden z-20 animate-in fade-in slide-in-from-top-2 flex flex-col max-h-[300px] overflow-y-auto"><button onClick={() => { onSelectYear('ALL'); setIsYearOpen(false); }} className={`text-left px-4 py-3 text-xs font-bold transition-colors ${selectedYear === 'ALL' ? 'bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>ì „ì²´ ê¸°ê°„</button>{availableYears.map(year => (<button key={year} onClick={() => { onSelectYear(year); setIsYearOpen(false); }} className={`text-left px-4 py-3 text-xs font-bold border-t border-slate-50 dark:border-slate-700 transition-colors ${selectedYear === year ? 'bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>{year}ë…„</button>))}</div></>)}
                </div>
                {selectedYear !== 'ALL' && (
                    <div className="relative">
                        <button onClick={() => { setIsMonthOpen(!isMonthOpen); setIsYearOpen(false); }} className="flex items-center gap-1.5 text-[11px] font-bold text-slate-700 dark:text-slate-300 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 pl-3 pr-2 py-1.5 rounded-xl shadow-sm active:scale-95 transition-transform"><span>{selectedMonth === 'ALL' ? 'ì „ì²´ ì›”' : `${parseInt(selectedMonth)}ì›”`}</span><ChevronDown size={14} className={`text-slate-400 transition-transform duration-200 ${isMonthOpen ? 'rotate-180' : ''}`}/></button>
                        {isMonthOpen && (<><div className="fixed inset-0 z-10" onClick={() => setIsMonthOpen(false)}></div><div className="absolute left-0 top-full mt-2 w-24 bg-white dark:bg-slate-800 rounded-xl shadow-xl border border-slate-100 dark:border-slate-700 overflow-hidden z-20 animate-in fade-in slide-in-from-top-2 flex flex-col max-h-[300px] overflow-y-auto"><button onClick={() => { onSelectMonth('ALL'); setIsMonthOpen(false); }} className={`text-left px-4 py-3 text-xs font-bold transition-colors ${selectedMonth === 'ALL' ? 'bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>ì „ì²´ ì›”</button>{availableMonths.map(month => (<button key={month} onClick={() => { onSelectMonth(month); setIsMonthOpen(false); }} className={`text-left px-4 py-3 text-xs font-bold border-t border-slate-50 dark:border-slate-700 transition-colors ${selectedMonth === month ? 'bg-slate-50 dark:bg-slate-700 text-slate-900 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>{parseInt(month)}ì›”</button>))}</div></>)}
                    </div>
                )}
            </div>
        );
    };

    const StatCard = ({ label, value, color, subValue, customIcon, subLabel, onClick }) => (
        <div onClick={onClick} className={`bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm flex items-center gap-3 ${onClick ? 'cursor-pointer active:scale-95 transition-transform' : ''}`}>
            <div className={`w-10 h-10 rounded-full flex items-center justify-center ${color} dark:bg-opacity-20`}>{customIcon}</div>
            <div>
                <p className="text-[10px] font-bold text-slate-400 uppercase">{label}</p>
                <div className="flex items-baseline gap-1.5"><p className="text-xl font-black text-slate-900 dark:text-white leading-none">{value}</p>{subValue && <span className="text-xs font-bold text-slate-400">{subValue}</span>}</div>
                {subLabel && <p className="text-[9px] text-slate-400 mt-0.5">{subLabel}</p>}
            </div>
        </div>
    );

    const CalendarView = ({ tastingDays, onSelectDate, selectedDate, onMonthChange, viewDate }) => {
        const year = viewDate.getFullYear();
        const month = viewDate.getMonth();
        const getDaysInMonth = (y, m) => new Date(y, m + 1, 0).getDate();
        const getFirstDayOfMonth = (y, m) => new Date(y, m, 1).getDay();
        const daysInMonth = getDaysInMonth(year, month);
        const firstDay = getFirstDayOfMonth(year, month);
        const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);
        const blanks = Array.from({ length: firstDay }, (_, i) => i);
        const isToday = (d) => { const today = new Date(); return d === today.getDate() && month === today.getMonth() && year === today.getFullYear(); };
        const isSelected = (d) => { if (!selectedDate) return false; const target = new Date(selectedDate); return d === target.getDate() && month === target.getMonth() && year === target.getFullYear(); };
        const hasTasting = (d) => { const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`; return tastingDays.includes(dateStr); };
        const handleDateClick = (d) => { const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`; onSelectDate(dateStr); };
        const changeMonth = (delta) => { onMonthChange(new Date(year, month + delta, 1)); };
        const changeYear = (delta) => { onMonthChange(new Date(year + delta, month, 1)); };

        return (
            <div className="bg-white dark:bg-slate-900 p-5 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm select-none">
                <div className="flex justify-between items-center mb-6">
                    <div className="flex items-center gap-1"><button onClick={() => changeYear(-1)} className="p-1.5 text-slate-300 hover:text-slate-600 dark:hover:text-slate-200 active:scale-90 transition-transform rounded-full hover:bg-slate-50 dark:hover:bg-slate-800"><ChevronsLeft size={20}/></button><button onClick={() => changeMonth(-1)} className="p-1.5 text-slate-300 hover:text-slate-600 dark:hover:text-slate-200 active:scale-90 transition-transform rounded-full hover:bg-slate-50 dark:hover:bg-slate-800"><ChevronLeft size={20}/></button></div>
                    <h3 className="text-base font-black text-slate-900 dark:text-white font-brand tabular-nums">{year}. {String(month + 1).padStart(2, '0')}</h3>
                    <div className="flex items-center gap-1"><button onClick={() => changeMonth(1)} className="p-1.5 text-slate-300 hover:text-slate-600 dark:hover:text-slate-200 active:scale-90 transition-transform rounded-full hover:bg-slate-50 dark:hover:bg-slate-800"><ChevronRight size={20}/></button><button onClick={() => changeYear(1)} className="p-1.5 text-slate-300 hover:text-slate-600 dark:hover:text-slate-200 active:scale-90 transition-transform rounded-full hover:bg-slate-50 dark:hover:bg-slate-800"><ChevronsRight size={20}/></button></div>
                </div>
                <div className="grid grid-cols-7 gap-1 text-center mb-2">{['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map((day,i) => (<div key={day} className={`text-[9px] font-bold uppercase tracking-wider ${i===0?'text-red-400':(i===6?'text-blue-400':'text-slate-300')}`}>{day}</div>))}</div>
                <div className="grid grid-cols-7 gap-1">{blanks.map(i => <div key={`blank-${i}`} className="aspect-square"></div>)}{days.map(d => (<button key={d} onClick={() => handleDateClick(d)} className={`aspect-square rounded-full flex flex-col items-center justify-center relative transition-all ${isSelected(d) ? 'bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 shadow-md scale-105' : 'text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-800'} ${isToday(d) && !isSelected(d) ? 'border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white font-bold' : ''}`}><span className="text-xs font-bold leading-none z-10">{d}</span>{hasTasting(d) && (<span className={`w-1 h-1 rounded-full mt-1 ${isSelected(d) ? 'bg-amber-400' : 'bg-amber-500'}`}></span>)}</button>))}</div>
            </div>
        );
    };

    const StatsTab = ({ active, onNavigateToBean, navKey }) => {
        const [beans, setBeans] = useState([]);
        const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
        const [viewDate, setViewDate] = useState(new Date());
        const [selectedYear, setSelectedYear] = useState('ALL');
        const [selectedMonth, setSelectedMonth] = useState('ALL');
        const scrollRef = useRef(null);
        const [statDetail, setStatDetail] = useState(null);
        const [showExpenditurePopup, setShowExpenditurePopup] = useState(false);
        const [shareData, setShareData] = useState(null);
        const [tastingMenuIdx, setTastingMenuIdx] = useState(null);
        const [toast, setToast] = useState(null);
        const isLongPress = useRef(false);
        const longPressTimer = useRef(null);

        // [New] Handle History for Modals (Close on Back Button)
        useEffect(() => {
            if (!active) return;
            const handlePop = (event) => {
                const modal = event.state ? event.state.modal : null;
                if (modal !== 'STAT_DETAIL' && statDetail) { setStatDetail(null); }
                if (modal !== 'EXPENDITURE' && showExpenditurePopup) { setShowExpenditurePopup(false); }
            };
            window.addEventListener('popstate', handlePop);
            return () => window.removeEventListener('popstate', handlePop);
        }, [active, statDetail, showExpenditurePopup]);

        useEffect(() => {
            if (active) {
                const data = safeStorage.get(`${STORAGE_KEY}_data`);
                if (Array.isArray(data)) setBeans(data);
                // [Fix] Reset scroll when Stats tab becomes active (via tab bar)
                if (scrollRef.current) scrollRef.current.scrollTop = 0;
            }
        }, [active, navKey]);

        const showToastMsg = (msg) => { setToast(msg); setTimeout(() => setToast(null), 3000); };
        const handleTouchStart = (idx) => { isLongPress.current = false; longPressTimer.current = setTimeout(() => { isLongPress.current = true; setTastingMenuIdx(idx); if (navigator.vibrate) navigator.vibrate(50); }, 600); };
        const handleTouchEnd = () => { if (longPressTimer.current) clearTimeout(longPressTimer.current); };

        const handleTextShare = async (tasting) => {
            const bean = beans.find(b => b.id === tasting.beanId);
            if (!bean) return;
            const text = generateShareText(bean, tasting);
            if (navigator.share) {
                try { await navigator.share({ text }); } catch (e) { console.log(e); }
            } else {
                try { await navigator.clipboard.writeText(text); showToastMsg("í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤."); } catch (e) { showToastMsg("ë³µì‚¬ ì‹¤íŒ¨"); }
            }
            setTastingMenuIdx(null);
        };

        const handleStatClick = (type) => {
            const isMatch = (dateStr) => {
                if (!dateStr) return false;
                if (selectedYear === 'ALL') return true;
                const [y, m] = dateStr.split('-');
                if (y !== selectedYear) return false;
                if (selectedMonth !== 'ALL' && m !== String(selectedMonth).padStart(2, '0')) return false;
                return true;
            };

            let title = "";
            let items = [];
            let dataType = 'BEAN';

            if (type === 'TOTAL_TASTINGS') {
                title = "ì‹œìŒ ê¸°ë¡ ëª©ë¡";
                dataType = 'TASTING';
                beans.forEach(b => {
                    if (b.tastings) {
                        b.tastings.forEach(t => {
                            if (isMatch(t.date)) {
                                items.push({ ...t, beanId: b.id, beanName: b.name });
                            }
                        });
                    }
                });
                items.sort((a, b) => b.date.localeCompare(a.date));
            } else {
                const filteredBeans = beans.filter(b => isMatch(b.purchaseDate));
                if (type === 'TOTAL_BEANS') {
                    title = "ì´ ì›ë‘ ëª©ë¡";
                    items = filteredBeans.filter(b => parseFloat(b.weight) > 0);
                } else if (type === 'ACTIVE_BEANS') {
                    title = "ë³´ìœ  ì›ë‘ ëª©ë¡";
                    items = filteredBeans.filter(b => parseFloat(b.weight) > 0 && !b.isFinished);
                } else if (type === 'SOLDOUT_BEANS') {
                    title = "ì†Œì§„ ì›ë‘ ëª©ë¡";
                    items = filteredBeans.filter(b => parseFloat(b.weight) > 0 && b.isFinished);
                } else if (type === 'TOTAL_CUPS') {
                    title = "í•œì” ì»¤í”¼ ëª©ë¡";
                    items = filteredBeans.filter(b => !parseFloat(b.weight));
                }
                items.sort((a, b) => (b.purchaseDate || "").localeCompare(a.purchaseDate || ""));
            }
            window.history.pushState({ tab: TAB.STATS, modal: 'STAT_DETAIL' }, '');
            setStatDetail({ title, items, type: dataType });
        };

        const stats = useMemo(() => {
            const isMatch = (dateStr) => {
                if (!dateStr) return false;
                if (selectedYear === 'ALL') return true;
                const [y, m] = dateStr.split('-');
                if (y !== selectedYear) return false;
                if (selectedMonth !== 'ALL' && m !== String(selectedMonth).padStart(2, '0')) return false;
                return true;
            };
            const filteredBeans = beans.filter(b => isMatch(b.purchaseDate));
            
            const isBean = (b) => parseFloat(b.weight) > 0;
            const beanEntries = filteredBeans.filter(isBean);
            const cupEntries = filteredBeans.filter(b => !isBean(b));

            const totalBeans = beanEntries.length;
            const totalWeight = beanEntries.reduce((acc, b) => acc + (parseFloat(b.weight)||0), 0);
            const activeBeans = beanEntries.filter(b => !b.isFinished).length;
            const soldOutBeans = beanEntries.filter(b => b.isFinished).length;
            const soldOutWeight = beanEntries.filter(b => b.isFinished).reduce((acc, b) => acc + (parseFloat(b.weight)||0), 0);
            const totalCups = cupEntries.length;

            let totalExpenditure = 0;
            let beanExpenditure = 0;
            let coffeeExpenditure = 0;
            filteredBeans.forEach(b => {
                if (isBean(b)) {
                    const p = (parseFloat(b.price) || 0); beanExpenditure += p; totalExpenditure += p;
                } else {
                    const p = (parseFloat(b.pricePerCup) || parseFloat(b.price) || 0); coffeeExpenditure += p; totalExpenditure += p;
                }
            });
            
            let totalTastings = 0;
            const tastingMap = {};
            const dateSet = new Set();
            
            let monthTastingCount = 0;
            let monthBeansBought = 0;
            const currentYear = viewDate.getFullYear();
            const currentMonth = viewDate.getMonth();

            beans.forEach(bean => {
                if (bean.tastings) {
                    bean.tastings.forEach(t => {
                        const tYear = t.date.split('-')[0];
                        if (isMatch(t.date)) { totalTastings++; }
                        dateSet.add(t.date);
                        if (!tastingMap[t.date]) tastingMap[t.date] = [];
                        tastingMap[t.date].push({ ...t, beanId: bean.id, beanName: bean.name });
                        const tDate = new Date(t.date);
                        if (tDate.getFullYear() === currentYear && tDate.getMonth() === currentMonth) { monthTastingCount++; }
                    });
                }
                if (bean.purchaseDate) {
                    const pDate = new Date(bean.purchaseDate);
                    if (pDate.getFullYear() === currentYear && pDate.getMonth() === currentMonth) { monthBeansBought++; }
                }
            });

            const availableYears = Array.from(new Set(
                beans.map(b => b.purchaseDate ? b.purchaseDate.split('-')[0] : null)
                .concat(beans.flatMap(b => b.tastings ? b.tastings.map(t => t.date.split('-')[0]) : []))
            )).filter(Boolean).sort().reverse();
            
            let availableMonths = [];
            if (selectedYear !== 'ALL') {
                const s = new Set();
                beans.forEach(b => {
                    if (b.purchaseDate && b.purchaseDate.startsWith(selectedYear)) s.add(b.purchaseDate.split('-')[1]);
                    if (b.tastings) b.tastings.forEach(t => { if (t.date.startsWith(selectedYear)) s.add(t.date.split('-')[1]); });
                });
                availableMonths = Array.from(s).filter(Boolean).sort();
            }

            return { totalBeans, totalWeight, activeBeans, soldOutBeans, soldOutWeight, totalCups, totalExpenditure, beanExpenditure, coffeeExpenditure, totalTastings, tastingMap, tastingDays: Array.from(dateSet), monthTastingCount, monthBeansBought, availableYears, availableMonths };
        }, [beans, viewDate, selectedYear, selectedMonth]);

        const selectedTastings = stats.tastingMap[selectedDate] || [];

        return (
            <div className={`h-full flex flex-col bg-slate-50 dark:bg-slate-950 ${active ? 'block' : 'hidden'}`}>
                {toast && <div className="fixed top-10 left-1/2 -translate-x-1/2 bg-slate-900/90 text-white px-6 py-3 rounded-full text-xs font-bold shadow-xl z-[120] whitespace-nowrap animate-in fade-in slide-in-from-top-2">{toast}</div>}
                {shareData && <ShareModal bean={shareData.bean} tasting={shareData.tasting} onClose={() => setShareData(null)} />}
                {statDetail && (
                    <div className="fixed inset-0 z-50 bg-black/50 dark:bg-black/70 flex items-center justify-center p-4 animate-in fade-in" onClick={() => window.history.back()}>
                        <div className="bg-white dark:bg-slate-900 w-full max-w-sm h-[60vh] rounded-2xl shadow-xl animate-pop flex flex-col overflow-hidden" onClick={e => e.stopPropagation()}>
                            <div className="flex justify-between items-center p-4 border-b dark:border-slate-800">
                                <h3 className="text-lg font-bold text-slate-900 dark:text-white">{statDetail.title} <span className="text-sm font-normal text-slate-500">({statDetail.items.length})</span></h3>
                                <button onClick={() => window.history.back()} className="p-1 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-400"><X size={18}/></button>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-3">
                                {statDetail.items.length === 0 ? <div className="text-center text-slate-400 py-10 text-sm">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div> : statDetail.items.map((item, i) => (
                                    <div key={i} onClick={() => { if(statDetail.type === 'BEAN') onNavigateToBean(item.id); else onNavigateToBean(item.beanId, item); }} className="flex items-center gap-3 p-3 bg-slate-50 dark:bg-slate-800 rounded-xl active:scale-95 transition-transform cursor-pointer">
                                        {statDetail.type === 'BEAN' ? (
                                            <>
                                                <div className={`w-10 h-10 rounded-lg bg-white dark:bg-slate-700 flex items-center justify-center shrink-0 overflow-hidden`}>{item.mainImage ? <img src={item.mainImage} className="w-full h-full object-cover"/> : <CustomBeanIcon size={20} className="text-slate-300"/>}</div>
                                                <div className="flex-1 min-w-0"><h4 className="font-bold text-sm text-slate-900 dark:text-white truncate">{item.name}</h4><div className="text-xs text-slate-500 truncate">{item.shop || '-'} Â· {item.purchaseDate || '-'}</div></div>
                                            </>
                                        ) : (
                                            <>
                                                <div className="w-10 h-10 rounded-lg bg-white dark:bg-slate-700 flex items-center justify-center shrink-0 font-black text-xs border dark:border-slate-600 dark:text-white">{getDisplayScore(item)}</div>
                                                <div className="flex-1 min-w-0"><h4 className="font-bold text-sm text-slate-900 dark:text-white truncate">{item.beanName}</h4><div className="text-xs text-slate-500 truncate">{item.date} Â· {item.notes || '-'}</div></div>
                                            </>
                                        )}
                                        <ChevronRight size={16} className="text-slate-300"/>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                )}
                {showExpenditurePopup && (
                    <div className="fixed inset-0 z-50 bg-black/50 dark:bg-black/70 flex items-center justify-center p-4 animate-in fade-in" onClick={() => window.history.back()}>
                        <div className="bg-white dark:bg-slate-900 w-full max-w-xs rounded-2xl p-6 shadow-xl animate-pop" onClick={e => e.stopPropagation()}>
                            <div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold text-slate-900 dark:text-white">ì§€ì¶œ ìƒì„¸</h3><button onClick={() => window.history.back()} className="p-1 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-400"><X size={16}/></button></div>
                            <div className="space-y-3">
                                <div className="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-800 rounded-xl"><span className="text-xs font-bold text-slate-500 dark:text-slate-400">ì´ ì§€ì¶œ</span><span className="text-lg font-black text-slate-900 dark:text-white">â‚©{stats.totalExpenditure.toLocaleString()}</span></div>
                                <div className="flex justify-between items-center px-2"><span className="text-xs font-bold text-slate-400 flex items-center gap-1"><CustomBeanIcon size={12}/> ì›ë‘ êµ¬ë§¤</span><span className="text-sm font-bold text-slate-700 dark:text-slate-300">â‚©{stats.beanExpenditure.toLocaleString()}</span></div>
                                <div className="flex justify-between items-center px-2"><span className="text-xs font-bold text-slate-400 flex items-center gap-1"><Coffee size={12}/> í•œì” ì»¤í”¼</span><span className="text-sm font-bold text-slate-700 dark:text-slate-300">â‚©{stats.coffeeExpenditure.toLocaleString()}</span></div>
                            </div>
                        </div>
                    </div>
                )}
                <header className="p-4 pt-4 border-b dark:border-slate-800 flex justify-between items-center bg-white dark:bg-slate-900 sticky top-0 z-10"><h1 className="text-xl font-black text-slate-900 dark:text-white flex items-center gap-2"><LayoutDashboard className="text-slate-900 dark:text-white"/> Insights</h1></header>
                <main className="flex-1 overflow-y-auto p-4 space-y-6 pb-24" ref={scrollRef}>
                    <section>
                        <div className="flex justify-between items-center mb-3 px-1 relative"><h2 className="text-xs font-bold text-slate-500 uppercase tracking-widest flex items-center gap-1"><BarChart3 size={14}/> Dashboard</h2><DashboardFilter selectedYear={selectedYear} onSelectYear={(y) => { setSelectedYear(y); setSelectedMonth('ALL'); }} availableYears={stats.availableYears} selectedMonth={selectedMonth} onSelectMonth={setSelectedMonth} availableMonths={stats.availableMonths} /></div>
                        <div className="grid grid-cols-2 gap-3">
                            <StatCard label={`${selectedYear === 'ALL' ? 'ëˆ„ì ' : (selectedMonth === 'ALL' ? `${selectedYear}ë…„` : `${selectedYear}.${selectedMonth}`)} ì´ ì›ë‘`} value={stats.totalBeans} subValue={formatWeight(stats.totalWeight)} customIcon={<CustomBeanIcon size={20} className="text-amber-700"/>} color="bg-amber-100" onClick={() => handleStatClick('TOTAL_BEANS')} />
                            <StatCard label="ëˆ„ì  ì§€ì¶œ" value={`â‚©${stats.totalExpenditure.toLocaleString()}`} customIcon={<ShoppingBag size={18} className="text-green-700"/>} color="bg-green-100" onClick={() => { window.history.pushState({ tab: TAB.STATS, modal: 'EXPENDITURE' }, ''); setShowExpenditurePopup(true); }} />
                            <StatCard label="ë³´ìœ  ì›ë‘" value={stats.activeBeans} customIcon={<CustomBeanIcon size={20} className="text-blue-600"/>} color="bg-blue-100" onClick={() => handleStatClick('ACTIVE_BEANS')} />
                            <StatCard label="ì†Œì§„ ì›ë‘" value={stats.soldOutBeans} subValue={formatWeight(stats.soldOutWeight)} customIcon={<CustomBeanIcon size={20} className="text-slate-500"/>} color="bg-slate-100" onClick={() => handleStatClick('SOLDOUT_BEANS')} />
                            <StatCard label="í•œì” ì»¤í”¼" value={stats.totalCups} customIcon={<Coffee size={18} className="text-orange-700"/>} color="bg-orange-100" subValue="Cups" onClick={() => handleStatClick('TOTAL_CUPS')} />
                            <StatCard label={`${selectedYear === 'ALL' ? 'ëˆ„ì ' : (selectedMonth === 'ALL' ? `${selectedYear}ë…„` : `${selectedYear}.${selectedMonth}`)} ì‹œìŒ`} value={stats.totalTastings} customIcon={<FileText size={18} className="text-purple-700"/>} color="bg-purple-100" subValue="Records" onClick={() => handleStatClick('TOTAL_TASTINGS')} />
                        </div>
                    </section>
                    <section>
                        <div className="flex items-center justify-between mb-3 px-1"><div className="flex items-center gap-2"><CalendarDays size={16} className="text-slate-400"/><h2 className="text-xs font-bold text-slate-500 uppercase tracking-widest">Coffee Calendar</h2></div><div className="flex gap-2 text-[10px] font-bold text-slate-400"><span className="bg-amber-50 dark:bg-amber-900/20 text-amber-600 dark:text-amber-400 px-1.5 py-0.5 rounded border border-amber-100 dark:border-amber-900/30 flex items-center gap-1"><Coffee size={10}/> {stats.monthTastingCount}ì” ë§ˆì‹¬</span><span className="bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 px-1.5 py-0.5 rounded border border-slate-200 dark:border-slate-700 flex items-center gap-1"><CustomBeanIcon size={10} className="text-amber-700 dark:text-amber-500"/> {stats.monthBeansBought}ê°œ êµ¬ë§¤</span></div></div>
                        <CalendarView tastingDays={stats.tastingDays} onSelectDate={setSelectedDate} selectedDate={selectedDate} onMonthChange={setViewDate} viewDate={viewDate} />
                    </section>
                    <section>
                        <div className="flex items-center justify-between mb-3 px-1"><h2 className="text-xs font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2"><Clock size={14}/> {selectedDate}</h2><span className="text-[10px] font-bold text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded-md">{selectedTastings.length} Records</span></div>
                        {selectedTastings.length > 0 ? (
                            <div className="space-y-3">
                                {selectedTastings.map((t, idx) => (
                                    <div key={idx} 
                                        className="bg-white dark:bg-slate-900 p-4 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm flex items-center gap-4 active:scale-95 transition-transform cursor-pointer hover:border-blue-100 dark:hover:border-blue-900 relative overflow-hidden select-none"
                                        onTouchStart={() => handleTouchStart(idx)} onTouchEnd={handleTouchEnd} onMouseDown={() => handleTouchStart(idx)} onMouseUp={handleTouchEnd} onMouseLeave={handleTouchEnd}
                                        onContextMenu={(e) => { e.preventDefault(); setTastingMenuIdx(idx); }}
                                        onClick={() => { if (isLongPress.current) return; if (tastingMenuIdx !== null) { setTastingMenuIdx(null); return; } onNavigateToBean(t.beanId, t); }}
                                    >
                                        <div className="w-12 h-12 bg-white dark:bg-slate-900 rounded-xl flex items-center justify-center font-black text-sm text-slate-900 dark:text-white border border-slate-100 dark:border-slate-800 shrink-0 shadow-sm">{getDisplayScore(t)}</div>
                                        <div className="flex-1 min-w-0"><h4 className="font-bold text-slate-900 dark:text-white truncate text-sm mb-0.5">{t.beanName}</h4><div className="flex items-center gap-1.5"><span className="text-[10px] bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 px-1 py-0.5 rounded font-bold">Flavor</span><p className="text-xs text-slate-400 truncate flex-1">{t.notes || "-"}</p></div></div><ChevronRight size={16} className="text-slate-300"/>
                                        {tastingMenuIdx === idx && (
                                            <div className="absolute inset-0 bg-slate-900/95 z-20 flex items-center justify-center gap-6 animate-in fade-in" onClick={(e) => e.stopPropagation()} onMouseDown={(e) => e.stopPropagation()} onTouchStart={(e) => e.stopPropagation()}>
                                                <button onClick={(e) => { e.stopPropagation(); const bean = beans.find(b => b.id === t.beanId); if(bean) setShareData({ bean, tasting: t }); setTastingMenuIdx(null); }} className="flex flex-col items-center text-white gap-1"><div className="p-2 bg-slate-800 rounded-full"><ImageIcon size={20}/></div><span className="text-[10px] font-bold">ì´ë¯¸ì§€ ê³µìœ </span></button>
                                                <button onClick={(e) => { e.stopPropagation(); handleTextShare(t); }} className="flex flex-col items-center text-white gap-1"><div className="p-2 bg-slate-800 rounded-full"><FileText size={20}/></div><span className="text-[10px] font-bold">í…ìŠ¤íŠ¸ ê³µìœ </span></button>
                                                <button onClick={(e) => { e.stopPropagation(); setTastingMenuIdx(null); }} className="absolute top-0 right-0 p-4 text-slate-500 hover:text-slate-300"><X size={20}/></button>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        ) : (<div className="py-12 text-center border-2 border-dashed border-slate-200 rounded-3xl bg-slate-50/50"><div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-300"><Coffee size={20} /></div><p className="text-xs font-bold text-slate-400">ì»¤í”¼ë¥¼ ë§ˆì‹œì§€ ì•Šì•˜ì–´ìš”</p></div>)}
                    </section>
                </main>
            </div>
        );
    };

    const SettingsTab = ({ active, apiKey, setApiKey, showToastMsg, theme, onToggleTheme, onLoadDemoData }) => {
        if (!active && !apiKey) return null;

        const backup = () => {
            const data = { beans: safeStorage.get(`${STORAGE_KEY}_data`), recipes: safeStorage.get(RECIPE_STORAGE_KEY), key: safeStorage.get(`${STORAGE_KEY}_key`) };
            const url = URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:"application/json"}));
            const a = document.createElement('a'); a.href=url; a.download=`beanlog_v2_backup_${new Date().toISOString().slice(0, 10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };
        const restore = (e) => {
            const f = e.target.files[0]; if (!f || !confirm("í˜„ì¬ ë°ì´í„°ë¥¼ ë®ì–´ì”Œì›ë‹ˆë‹¤. ì§„í–‰í• ê¹Œìš”?")) return;
            const r = new FileReader(); r.onload = (ev) => { try { const d = JSON.parse(ev.target.result); if (d.beans) { safeStorage.set(`${STORAGE_KEY}_data`, d.beans); alert("ì›ë‘ ë°ì´í„° ë³µì› ì™„ë£Œ"); } if (d.recipes) { safeStorage.set(RECIPE_STORAGE_KEY, d.recipes); alert("ë ˆì‹œí”¼ ë°ì´í„° ë³µì› ì™„ë£Œ"); } if (d.key) { safeStorage.set(`${STORAGE_KEY}_key`, d.key); setApiKey(d.key); } } catch (e) { alert("íŒŒì¼ ì˜¤ë¥˜"); } }; r.readAsText(f);
        };
        const reset = () => { if (confirm("ëª¨ë“  ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { localStorage.removeItem(`${STORAGE_KEY}_data`); localStorage.removeItem(RECIPE_STORAGE_KEY); localStorage.removeItem(`${STORAGE_KEY}_key`); location.reload(); } };

        const getThemeIcon = () => {
            if (theme === 'DARK') return <Moon size={20} />;
            if (theme === 'LIGHT') return <Sun size={20} />;
            return <Monitor size={20} />;
        };

        return (
            <div className={`h-full flex flex-col bg-white dark:bg-slate-900 dark:text-slate-100 ${active ? 'block' : 'hidden'}`}>
                <header className="p-4 pt-4 border-b dark:border-slate-800 flex justify-between items-center">
                    <h1 className="font-black text-xl">ì„¤ì •</h1>
                    <button onClick={onToggleTheme} className="p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">{getThemeIcon()}</button>
                </header>
                <div className="p-6 space-y-6 flex-1 overflow-y-auto">
                    <div className="space-y-2"><label className="text-xs font-bold text-slate-500 dark:text-slate-400">Gemini API Key</label><input type="password" className="w-full p-4 bg-slate-50 dark:bg-slate-800 dark:text-white rounded-2xl outline-none" value={apiKey} onChange={e=>{setApiKey(e.target.value); safeStorage.set(`${STORAGE_KEY}_key`,e.target.value);}} placeholder="API Key ì…ë ¥"/></div>
                    <div className="pt-8 border-t dark:border-slate-800 space-y-3"><h3 className="font-bold text-sm">ë°ì´í„° ê´€ë¦¬</h3><button onClick={onLoadDemoData} className="w-full py-4 bg-slate-100 dark:bg-slate-800 font-bold rounded-2xl flex items-center justify-center gap-2"><Sparkles size={18}/> ë°ëª¨ ë°ì´í„° ì ìš©</button><button onClick={backup} className="w-full py-4 bg-slate-100 dark:bg-slate-800 font-bold rounded-2xl flex items-center justify-center gap-2"><Download size={18}/> í†µí•© ë°±ì—…</button><div className="relative"><input type="file" onChange={restore} className="hidden" id="rFile" accept="file" /><label htmlFor="rFile" className="w-full py-4 bg-slate-100 dark:bg-slate-800 font-bold rounded-2xl flex items-center justify-center gap-2 cursor-pointer"><Upload size={18}/> ë³µì›</label></div><button onClick={reset} className="w-full py-4 text-red-500 font-bold bg-red-50 dark:bg-red-900/20 rounded-2xl mt-4 flex items-center justify-center gap-2"><Trash2 size={18}/> ì´ˆê¸°í™”</button></div>
                    <div className="pt-8 border-t dark:border-slate-800 space-y-3"><h3 className="font-bold text-sm">ì•± ê´€ë¦¬</h3><a href="https://imonraside.github.io/beanlog/guide/" target="_blank" rel="noopener noreferrer" className="w-full py-4 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 font-bold rounded-2xl flex items-center justify-center gap-2"><HelpCircle size={18}/> ë„ì›€ë§ & ê°€ì´ë“œ</a><button onClick={() => window.location.reload()} className="w-full py-4 bg-slate-100 dark:bg-slate-800 font-bold rounded-2xl flex items-center justify-center gap-2"><RefreshCw size={18}/> ì•± ìƒˆë¡œê³ ì¹¨</button></div>
                    <div className="pt-10 text-center"><p className="text-[10px] font-bold text-slate-300 uppercase tracking-widest">BeanLog {APP_VERSION}</p></div>
                </div>
            </div>
        );
    };

    const PWASetup = () => {
        const [deferredPrompt, setDeferredPrompt] = useState(null);
        const [showInstallBtn, setShowInstallBtn] = useState(false);

        useEffect(() => {
            const initPWA = async () => {
                // 1. Setup Icons & Manifest dynamically
                const svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="112 84 800 800" width="512" height="512" style="shape-rendering:geometricPrecision; fill-rule:evenodd; clip-rule:evenodd">
                <g fill="#4b2c20" stroke="#4b2c20" stroke-width="20" stroke-linejoin="round" stroke-linecap="round">
                    <path fill-opacity="0.9" d="M 606.5,191.5 C 626.3,189.9 645.6,192.1 664.5,198C 675.1,200.9 679.6,207.8 678,218.5C 673.5,239.2 662,254.5 643.5,264.5C 641.1,262.9 641.1,261.4 643.5,260C 642.4,258.6 641.1,257.6 639.5,257C 642.3,254.8 642,253.3 638.5,252.5C 653.5,243.8 662,230.8 664,213.5C 656.9,208.9 649.1,206.4 640.5,206C 628.2,204.8 615.9,204.3 603.5,204.5C 604.3,203.6 606,203.1 608.5,203C 605.1,202.8 601.8,202.3 598.5,201.5C 599.2,198.6 600.5,196.1 602.5,194C 601.5,193.7 600.5,193.3 599.5,193C 602,192.8 604.4,192.3 606.5,191.5 Z"/>
                    <path fill-opacity="0.8" d="M 708.5,221.5 C 732.2,236 749.7,256 761,281.5C 773.9,310.9 780.4,341.8 780.5,374C 780.4,399.5 777.7,424.7 772.5,449.5C 768.5,441.6 765.5,433.2 763.5,424.5C 771.2,379 767,334.6 751,291.5C 741.7,269.9 727.9,251.9 709.5,237.5C 712.1,237.3 712.1,236.8 709.5,236C 710.8,230.9 709.5,226.6 705.5,223C 706.7,222.8 707.7,222.3 708.5,221.5 Z"/>
                    <path fill-opacity="1.0" d="M 638.5,252.5 C 642,253.3 642.3,254.8 639.5,257C 641.1,257.6 642.4,258.6 643.5,260C 641.1,261.4 641.1,262.9 643.5,264.5C 630.7,271.7 618.1,279.2 605.5,287C 591.7,296.9 579.1,308.1 567.5,320.5C 563.5,318.7 559.7,318.7 556,320.5C 554.7,319.1 554.2,317.4 554.5,315.5C 560.9,307.6 567.9,300.1 575.5,293C 594.8,276.9 615.8,263.4 638.5,252.5 Z"/>
                    <path fill-opacity="0.8" d="M 606.5,191.5 C 604.4,192.3 602,192.8 599.5,193C 600.5,193.3 601.5,193.7 602.5,194C 600.5,196.1 599.2,198.6 598.5,201.5C 601.8,202.3 605.1,202.8 608.5,203C 606,203.1 604.3,203.6 603.5,204.5C 591.2,206.3 578.8,208.8 566.5,212C 529.9,223.1 496.3,239.8 465.5,262C 411.7,302.1 368.2,351.3 335,409.5C 310.1,452.9 293.6,499.2 285.5,548.5C 284.8,551.2 284.2,553.8 283.5,556.5C 282.7,557 282,558.3 281.5,560.5C 280.7,559.6 280.2,558.6 280,557.5C 279.7,558.3 279.2,559 278.5,559.5C 276.6,559.1 275.1,558.1 274,556.5C 273.7,557.2 273.3,557.8 273,558.5C 272.8,556.3 272.3,554.3 271.5,552.5C 276.3,515 286.4,479 302,444.5C 343,354.6 405.2,283.4 488.5,231C 515.5,215.2 544.1,203.6 574.5,196C 585,193.5 595.7,192 606.5,191.5 Z"/>
                    <path fill-opacity="0.9" d="M 554.5,315.5 C 554.2,317.4 554.7,319.1 556,320.5C 559.7,318.7 563.5,318.7 567.5,320.5C 528.7,366.6 506.6,420 501,480.5C 491.1,533.4 469.1,580.4 435,621.5C 428.2,628.3 421.3,635.2 414.5,642C 407.2,648 399.5,653.5 391.5,658.5C 391.2,657 390.2,656.3 388.5,656.5C 387.7,651.4 384.7,649.4 379.5,650.5C 389.2,644.3 398.5,637.5 407.5,630C 433.2,606 453,577.8 467,545.5C 480.9,510.7 489.9,474.7 494,437.5C 504.4,391.7 524.6,351 554.5,315.5 Z"/>
                    <path d="M 763.5,424.5 C 765.5,433.2 768.5,441.6 772.5,449.5C 748.4,553.2 695.8,639 614.5,707C 576.4,737.9 533.4,759.6 485.5,772C 474.2,774.2 462.9,776 451.5,777.5C 452.6,776.7 453.9,776.2 455.5,776C 452.2,775.7 448.8,775.3 445.5,775C 443.7,772.8 441.7,770.8 439.5,769C 443.5,766.7 447.8,765.3 452.5,765C 450.2,764.5 447.9,764.3 445.5,764.5C 445.5,764.2 445.5,763.8 445.5,763.5C 461.7,762.6 477.7,760.1 493.5,756C 533.4,743.5 569.8,724.5 602.5,699C 684.1,632.5 736.4,547.7 759.5,444.5C 760.9,442.5 761.6,440.2 761.5,437.5C 761.8,433 762.4,428.6 763.5,424.5 Z"/>
                    <path d="M 271.5,552.5 C 272.3,554.3 272.8,556.3 273,558.5C 273.3,557.8 273.7,557.2 274,556.5C 275.1,558.1 276.6,559.1 278.5,559.5C 279.2,559 279.7,558.3 280,557.5C 280.2,558.6 280.7,559.6 281.5,560.5C 282,558.3 282.7,557 283.5,556.5C 283.5,559.5 283.5,562.5 283.5,565.5C 280.6,594.5 282.8,623.2 290,651.5C 295.9,673.2 306.4,692.2 321.5,708.5C 319.9,708.5 318.2,708.5 316.5,708.5C 314,709.7 314,710.9 316.5,712C 314,714.2 314.3,716.2 317.5,718C 316.7,719.6 317.3,720.6 319.5,721C 318.6,721.3 317.9,721.8 317.5,722.5C 298.3,704.7 285.1,683.1 278,657.5C 268.3,622.8 266.2,587.8 271.5,552.5 Z"/>
                    <path fill-opacity="1.0" d="M 708.5,221.5 C 707.7,222.3 706.7,222.8 705.5,223C 709.5,226.6 710.8,230.9 709.5,236C 712.1,236.8 712.1,237.3 709.5,237.5C 708,236.7 706.7,236.7 705.5,237.5C 699.6,253.4 690.6,267.2 678.5,279C 664.2,289.5 649.5,299.5 634.5,309C 590.3,346.8 562.2,394.3 550,451.5C 546,481.8 539.3,511.5 530,540.5C 504.3,613.9 456.4,667.4 386.5,701C 373.4,709.9 365.4,722.1 362.5,737.5C 363,741.8 365,745.3 368.5,748C 380.6,756.1 393.9,760.9 408.5,762.5C 411.3,763.3 414.3,763.8 417.5,764C 426.8,764.5 436.1,764.6 445.5,764.5C 447.9,764.3 450.1,764.5 452.5,765C 447.8,765.3 443.5,766.6 439.5,769C 441.7,770.8 443.7,772.8 445.5,775C 448.8,775.3 452.1,775.6 455.5,776C 453.9,776.2 452.6,776.7 451.5,777.5C 422.4,780.6 394.8,776.1 368.5,764C 350.4,755.3 344.9,741.4 352,722.5C 359.2,707.2 370.1,695 384.5,686C 446.4,656.0 489.5,608.9 514,544.5C 519.5,529.1 524.2,513.4 528,497.5C 531.7,473.6 536.4,449.9 542,426.5C 557.4,375.6 585.3,333.1 625.5,299C 636.6,290.5 648.3,282.9 660.5,276C 678.3,262.5 690.3,245 696.5,223.5C 700,220.3 704,219.7 708.5,221.5 Z"/>
                    <path fill-opacity="1.0" d="M 379.5,650.5 C 384.7,649.3 387.7,651.3 388.5,656.5C 390.1,656.2 391.1,656.9 391.5,658.5C 377.8,665.8 365.3,674.8 354,685.5C 343.7,697 336.2,710.2 331.5,725C 326.2,727.4 321.5,726.6 317.5,722.5C 317.9,721.7 318.5,721.2 319.5,721C 317.3,720.5 316.6,719.5 317.5,718C 314.3,716.1 313.9,714.1 316.5,712C 313.9,710.9 313.9,709.7 316.5,708.5C 318.1,708.5 319.8,708.5 321.5,708.5C 322.3,709.5 323.2,709.5 324,708.5C 335.1,682.1 353.6,662.8 379.5,650.5 Z"/>
                </g>
                <g fill="white" fill-opacity="0.3"><path d="M 603.5,204.5 C 615.9,204.3 628.2,204.8 640.5,206C 649.1,206.4 656.9,208.9 664,213.5C 662,230.8 653.5,243.8 638.5,252.5C 615.8,263.4 594.8,276.9 575.5,293C 567.9,300.1 560.9,307.6 554.5,315.5C 524.6,351 504.4,391.7 494,437.5C 489.9,474.7 480.9,510.7 467,545.5C 453,577.8 433.2,606 407.5,630C 398.5,637.5 389.2,644.3 379.5,650.5C 353.7,662.8 335.2,682.2 324,708.5C 323.2,709.6 322.4,709.6 321.5,708.5C 306.4,692.2 295.9,673.2 290,651.5C 282.8,623.2 280.6,594.5 283.5,565.5C 284.9,560.1 285.6,554.4 285.5,548.5C 293.6,499.2 310.1,452.9 335,409.5C 368.2,351.3 411.7,302.1 465.5,262C 496.3,239.8 529.9,223.1 566.5,212C 578.8,208.8 591.2,206.3 603.5,204.5 Z"/></g>
                </svg>`;
                
                // [Fix] Use Base64 Data URI instead of Blob URL for Installer Access
                const svgUrl = "data:image/svg+xml;base64," + btoa(unescape(encodeURIComponent(svgIcon)));

                // 2. Convert to PNG (Critical for Samsung Internet)
                const canvas = document.createElement('canvas');
                canvas.width = 512;
                canvas.height = 512;
                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                const img = new Image();
                img.crossOrigin = "anonymous";
                
                await new Promise((resolve) => {
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0);
                        resolve();
                    };
                    img.src = svgUrl;
                });
                
                const pngUrl = canvas.toDataURL('image/png');

                // 3. Setup Head Tags
                const linkIcon = document.createElement('link'); linkIcon.rel = 'icon'; linkIcon.href = pngUrl; document.head.appendChild(linkIcon);
                const linkApple = document.createElement('link'); linkApple.rel = 'apple-touch-icon'; linkApple.href = pngUrl; document.head.appendChild(linkApple);
                
                // 4. Manifest with PNG
                const manifest = { 
                    name: "BeanLog", 
                    short_name: "BeanLog", 
                    start_url: ".", 
                    display: "standalone", 
                    background_color: "#f3f4f6", 
                    theme_color: "#f3f4f6", 
                    icons: [
                        { src: svgUrl, sizes: "512x512", type: "image/svg+xml", purpose: "any" },
                        { src: pngUrl, sizes: "512x512", type: "image/png", purpose: "any" }
                    ] 
                };
                
                // [Fix] Manifest as Data URI to prevent "Download failed"
                const manifestUrl = "data:application/manifest+json;base64," + btoa(unescape(encodeURIComponent(JSON.stringify(manifest))));
                const linkManifest = document.createElement('link'); linkManifest.rel = 'manifest'; linkManifest.href = manifestUrl; document.head.appendChild(linkManifest);
            };

            initPWA();

            // 5. Install Prompt Listener
            const handler = (e) => { 
                e.preventDefault(); 
                setDeferredPrompt(e); 
                if (!sessionStorage.getItem('pwa_dismissed')) {
                    setShowInstallBtn(true); 
                }
            };
            window.addEventListener('beforeinstallprompt', handler);
            return () => window.removeEventListener('beforeinstallprompt', handler);
        }, []);

        const handleInstall = () => { if (!deferredPrompt) return; deferredPrompt.prompt(); deferredPrompt.userChoice.then((res) => { if (res.outcome === 'accepted') setShowInstallBtn(false); setDeferredPrompt(null); }); };

        if (!showInstallBtn) return null;
        return (
            <div className="fixed bottom-20 left-1/2 -translate-x-1/2 z-[80] animate-in slide-in-from-bottom-4 fade-in duration-500">
                <button onClick={handleInstall} className="bg-slate-900 text-white px-5 py-3 rounded-full shadow-2xl flex items-center gap-3 font-bold text-sm border border-slate-700 whitespace-nowrap">
                    <div className="w-8 h-8 bg-white rounded-full flex items-center justify-center text-amber-700"><CustomBeanIcon size={20} /></div>
                    ì•± ë‹¤ìš´ë¡œë“œ (ë°”ë¡œê°€ê¸°)
                    <X size={16} className="text-slate-500 ml-1" onClick={(e) => { e.stopPropagation(); setShowInstallBtn(false); sessionStorage.setItem('pwa_dismissed', 'true'); }} />
                </button>
            </div>
        );
    };

    const App = () => {
        const [tab, setTab] = useState(TAB.BEANS);
        const [apiKey, setApiKey] = useState("");
        const [navKey, setNavKey] = useState(0);
        const [navProps, setNavProps] = useState(null);
        const [isTimerRunning, setIsTimerRunning] = useState(false);
        const [toast, setToast] = useState(null);
        const [theme, setTheme] = useState(() => safeStorage.get(`${STORAGE_KEY}_theme`) || 'SYSTEM');

        useEffect(() => {
            const root = window.document.documentElement;
            const apply = () => {
                const isDark = theme === 'DARK' || (theme === 'SYSTEM' && window.matchMedia('(prefers-color-scheme: dark)').matches);
                if (isDark) { root.classList.add('dark'); document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0f172a'); }
                else { root.classList.remove('dark'); document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff'); }
            };
            apply();
            if (theme === 'SYSTEM') { const mq = window.matchMedia('(prefers-color-scheme: dark)'); mq.addEventListener('change', apply); return () => mq.removeEventListener('change', apply); }
        }, [theme]);

        const toggleTheme = () => {
            const modes = ['LIGHT', 'DARK', 'SYSTEM']; const next = modes[(modes.indexOf(theme) + 1) % modes.length];
            setTheme(next); safeStorage.set(`${STORAGE_KEY}_theme`, next); showToastMsg(`í…Œë§ˆ ë³€ê²½: ${next === 'SYSTEM' ? 'ì‹œìŠ¤í…œ ì„¤ì •' : (next === 'DARK' ? 'ë‹¤í¬ ëª¨ë“œ' : 'ë¼ì´íŠ¸ ëª¨ë“œ')}`);
        };

        const loadDemoData = () => {
            if (confirm("ë°ëª¨ ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ê¸°ì¡´ ë°ì´í„°ì— ë°ëª¨ìš© ì›ë‘ì™€ ì‹œìŒ ê¸°ë¡ì´ ì¶”ê°€ë©ë‹ˆë‹¤.")) {
                const existingData = safeStorage.get(`${STORAGE_KEY}_data`) || [];
                const demoData = getDemoData();
                const nonDemoData = existingData.filter(item => !String(item.id).startsWith('demo_'));
                const newData = [...demoData, ...nonDemoData];
                if (safeStorage.set(`${STORAGE_KEY}_data`, newData)) {
                    showToastMsg("ë°ëª¨ ë°ì´í„° ì ìš© ì™„ë£Œ! ì•±ì„ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    showToastMsg("ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
            }
        };

        const showToastMsg = (msg) => { setToast(msg); setTimeout(() => setToast(null), 3000); };

        useEffect(() => { const k = safeStorage.get(`${STORAGE_KEY}_key`); if (k) setApiKey(k); }, []);

        const updateTab = (newTab) => {
            if (newTab === TAB.TIMER && isTimerRunning) {
                 window.history.pushState({ tab: TAB.TIMER, mode: 'TIMER' }, '');
                 setTab(newTab);
                 return;
            }
            const newState = { tab: newTab };
            if (newTab === TAB.BEANS) { newState.view = 'LIST'; newState.id = null; }
            else if (newTab === TAB.TIMER) { newState.mode = 'EDIT'; }
            window.history.pushState(newState, '');
            setNavKey(prev => prev + 1);
            setTab(newTab);
        };
        
        const handleNavigateToTasting = (beanId, tasting) => {
             const view = tasting ? 'EDIT_TASTING' : 'DETAIL';
             window.history.pushState({ tab: TAB.BEANS, view: view, id: beanId }, '');
             setNavProps({ view: view, beanId: beanId, tasting: tasting });
             setTab(TAB.BEANS);
        };

        useEffect(() => {
            const handlePop = (event) => {
                if(event.state && event.state.tab) { setTab(event.state.tab); } else { setTab(TAB.BEANS); }
            };
            window.addEventListener('popstate', handlePop);
            return () => window.removeEventListener('popstate', handlePop);
        }, []);

        return (
            <div className="h-[100dvh] flex flex-col bg-white dark:bg-slate-900 max-w-md mx-auto shadow-2xl overflow-hidden relative transition-colors duration-300">
                <FontLoader />
                <PWASetup />
                {toast && <div className="fixed top-10 left-1/2 -translate-x-1/2 bg-slate-900/90 text-white px-6 py-3 rounded-full text-xs font-bold shadow-xl z-[120] whitespace-nowrap animate-in fade-in slide-in-from-top-2">{toast}</div>}
                <div className="flex-1 overflow-hidden relative">
                    <BeansTab active={tab === TAB.BEANS} globalApiKey={apiKey} navProps={navProps} onNavConsumed={() => setNavProps(null)} navKey={navKey} />
                    <TimerTab active={tab === TAB.TIMER} setIsTimerRunning={setIsTimerRunning} navKey={navKey} />
                    <StatsTab active={tab === TAB.STATS} onNavigateToBean={handleNavigateToTasting} navKey={navKey} />
                    <SettingsTab active={tab === TAB.SETTINGS} apiKey={apiKey} setApiKey={setApiKey} showToastMsg={showToastMsg} theme={theme} onToggleTheme={toggleTheme} onLoadDemoData={loadDemoData} />
                </div>
                <div className="bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800 flex justify-between items-center shrink-0 z-[50] h-[50px] px-6 transition-colors duration-300">
                    <button onClick={() => updateTab(TAB.BEANS)} className={`flex items-center justify-center w-full h-full gap-1 transition-colors ${tab === TAB.BEANS ? 'text-slate-900 dark:text-slate-100' : 'text-slate-300 dark:text-slate-600'}`}><CustomBeanIcon size={20} className={tab === TAB.BEANS ? 'text-slate-900 dark:text-slate-100' : 'text-slate-300 dark:text-slate-600'} /></button>
                    <button onClick={() => updateTab(TAB.TIMER)} className={`flex items-center justify-center w-full h-full gap-1 transition-colors relative ${tab === TAB.TIMER ? 'text-blue-500' : 'text-slate-300'}`}>
                        <Timer size={20} strokeWidth={tab === TAB.TIMER ? 2.5 : 2} />
                        {isTimerRunning && <span className="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full animate-pulse border border-white"></span>}
                    </button>
                    <button onClick={() => updateTab(TAB.STATS)} className={`flex items-center justify-center w-full h-full gap-1 transition-colors ${tab === TAB.STATS ? 'text-slate-900 dark:text-slate-100' : 'text-slate-300 dark:text-slate-600'}`}><LayoutDashboard size={20} strokeWidth={tab === TAB.STATS ? 2.5 : 2} /></button>
                    <button onClick={() => updateTab(TAB.SETTINGS)} className={`flex items-center justify-center w-full h-full gap-1 transition-colors ${tab === TAB.SETTINGS ? 'text-slate-900 dark:text-slate-100' : 'text-slate-300 dark:text-slate-600'}`}><Settings size={20} strokeWidth={tab === TAB.SETTINGS ? 2.5 : 2} /></button>
                </div>
            </div>
        );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>