<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>BeanLog</title>
  <meta name="theme-color" content="#ffffff">
  <meta name="mobile-web-app-capable" content="yes">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&family=Montserrat:wght@600;700;900&family=Roboto+Mono:wght@400;500;700&display=swap');
    
    html, body { 
        height: 100%; 
        overflow: hidden; 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans KR", sans-serif; 
        background: #f8fafc;
    }
    
    .font-brand { font-family: 'Montserrat', sans-serif; }
    .font-timer { font-family: 'Montserrat', sans-serif; }
    .font-capture { font-family: 'Noto Sans KR', sans-serif; }
    
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    #app-loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #333; border-radius: 50%; animation: spin 1s linear infinite; }
    .loader-white { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid white; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    .animate-in { animation: fadeIn 0.3s ease-out forwards; }
    .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    .animate-pop { animation: pop 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    @keyframes pop { 0% { transform: scale(0.9); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    .step-active { background-color: #ffffff; border-left-width: 6px; border-color: #3b82f6; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: scale(1.02); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    .step-inactive { border-left-width: 2px; border-color: transparent; opacity: 0.6; filter: grayscale(100%); transform: scale(1); transition: all 0.4s ease; }
    
    .cropper-view-box, .cropper-face { outline: 2px solid white; }
    .dot-line { border-bottom: 2px dotted #cbd5e1; flex: 1; margin: 0 6px; position: relative; top: -4px; }
    .no-select { -webkit-user-select: none; user-select: none; }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  
  <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "html-to-image": "https://esm.sh/html-to-image@1.11.11"
      }
    }
  </script>
  <script src="https://unpkg.com/@babel/standalone@7.23.8/babel.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-900 select-none overflow-hidden w-full h-full">
  <div id="app-loader"><div class="spinner"></div><p style="margin-top:15px; font-weight:bold; color:#666;">BeanLog loading</p></div>
  <div id="root" class="h-full w-full"></div>
  <script>setTimeout(()=>{const l=document.getElementById('app-loader');if(l)l.style.display='none'},1500);</script>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo, useRef, useCallback, useLayoutEffect } from 'react';
    import { createRoot } from 'react-dom/client';
    import * as htmlToImage from 'html-to-image';
    import { 
      Plus, Camera, Settings, ChevronLeft, Trash2, Coffee, Calendar, Star,
      RefreshCw, Zap, FileText, Clock, ChevronRight, Info, CheckCircle2,
      Quote, StickyNote, Award, Save, Search, X, Check, ShoppingBag, Download, Upload, RotateCcw,
      ExternalLink, MapPin, Tag, User, Mountain, Flame, Bean, BeanOff, HelpCircle, Filter, LayoutList, LogOut,
      ArrowUpDown, CalendarDays, MoreHorizontal, ToggleLeft, ToggleRight, PenTool, Minus, Calculator, Share2, Layers, Sparkles, Palette,
      Layout, Timer, Play, Pause, Droplet, RefreshCcw, Tornado, Target, Utensils, Waves, List, AlertCircle,
      LayoutDashboard, PieChart, BarChart3, ChevronLeftCircle, ChevronRightCircle, ChevronDown, ChevronsLeft, ChevronsRight
    } from 'lucide-react';

    // --- 1. GLOBAL HELPERS & CONSTANTS ---
    const STORAGE_KEY = "BEAN_LOG_MASTER_FINAL";
    const RECIPE_STORAGE_KEY = `${STORAGE_KEY}_recipes`;
    const APP_VERSION = "v1.0.0";
    const TAB = { BEANS: 'BEANS', TIMER: 'TIMER', STATS: 'STATS', SETTINGS: 'SETTINGS' };
    
    const INITIAL_BEAN = { id: null, name: "", country: "", region: "", variety: "", processing: "", altitude: "", roastingLevel: "", producer: "", roastingDate: "", purchaseDate: "", shop: "", purchaseUrl: "", weight: "", price: "", pricePerCup: "", notes: "", flavorDesc: "", memo: "", isFinished: false, mainImage: null, ocrImage: null, tastings: [] };
    const INITIAL_TASTING = { date: new Date().toISOString().split('T')[0], scores: { acidity: 7.0, balance: 7.0, sweetness: 7.0, cleanCup: 7.0, body: 7.0, flavor: 7.0 }, isManualTotal: false, totalScore: 7.0, notes: "", desc: "", memo: "" };
    // [Fix] Empty Initial Recipe (Global Definition)
    const INITIAL_RECIPE = { id: null, title: "", bean: "", water: "", interval: "", endTime: "", memo: "" };

    const TASTE_ITEMS = [{ id: 'acidity', label: 'ÏÇ∞ÎØ∏' }, { id: 'balance', label: 'Î∞∏Îü∞Ïä§' }, { id: 'sweetness', label: 'Îã®Îßõ' }, { id: 'cleanCup', label: 'ÌÅ¥Î¶∞Ïªµ' }, { id: 'body', label: 'Î∞îÎîî' }, { id: 'flavor', label: 'Ìñ•ÎØ∏' }];
    const SCORE_LABELS_KO = { acidity: "ÏÇ∞ÎØ∏", balance: "Î∞∏Îü∞Ïä§", sweetness: "Îã®Îßõ", cleanCup: "ÌÅ¥Î¶∞Ïªµ", body: "Î∞îÎîî", flavor: "Ìñ•ÎØ∏" };

    const FLAVOR_DATA = [
      { id: 'fruity', label: 'Í≥ºÏùº (Fruity)', color: 'bg-red-500', bg: 'bg-red-50', text: 'text-red-700', subs: [ { group: 'Î≤†Î¶¨Î•ò', items: ['Îî∏Í∏∞', 'Î∏îÎ£®Î≤†Î¶¨', 'ÎùºÏ¶àÎ≤†Î¶¨'] }, { group: 'Í∞êÍ∑§Î•ò', items: ['Î†àÎ™¨', 'ÎùºÏûÑ', 'Ïò§Î†åÏßÄ', 'ÏûêÎ™Ω'] }, { group: 'ÌïµÍ≥ºÎ•ò', items: ['Î≥µÏà≠ÏïÑ', 'ÏÇ¥Íµ¨', 'ÏûêÎëê', 'Ï≤¥Î¶¨'] }, { group: 'Ïó¥ÎåÄ Í≥ºÏùº', items: ['ÎßùÍ≥†', 'ÌååÏù∏Ïï†Ìîå', 'ÏΩîÏΩîÎÑõ'] } ] },
      { id: 'floral', label: 'ÍΩÉ/Ï∞® (Floral)', color: 'bg-fuchsia-500', bg: 'bg-fuchsia-50', text: 'text-fuchsia-700', subs: [ { group: 'ÍΩÉ', items: ['ÏûêÏä§ÎØº', 'Ïû•ÎØ∏', 'Ïπ¥Î™®ÎßàÏùº', 'ÎùºÎ≤§Îçî', 'ÌûàÎπÑÏä§Ïª§Ïä§', 'ÏïÑÏπ¥ÏãúÏïÑ', 'ÏóòÎçîÌîåÎùºÏõå', 'Î≤öÍΩÉ', 'Î™©Î†®'] }, { group: 'Ï∞®', items: ['ÌôçÏ∞®', 'ÎÖπÏ∞®', 'ÏñºÍ∑∏Î†àÏù¥', 'Ïö∞Î°±Ï∞®', 'ÎßêÏ∞®', 'Î≥¥Î¶¨Ï∞®', 'ÌóàÎ∏åÌã∞'] } ] },
      { id: 'sweet', label: 'Îã¨ÏΩ§Ìï® (Sweet)', color: 'bg-orange-400', bg: 'bg-orange-50', text: 'text-orange-700', subs: [ { group: 'ÏÑ§ÌÉï/ÏãúÎüΩ', items: ['ÍøÄ', 'ÌùëÏÑ§ÌÉï', 'Ï∫¨ÎùºÎ©ú', 'Î©îÏù¥Ìîå ÏãúÎüΩ', 'Ï°∞Ï≤≠', 'ÎãπÎ∞Ä', 'Îã¨Í≥†ÎÇò', 'Ìô©ÏÑ§ÌÉï'] }, { group: 'ÎîîÏ†ÄÌä∏/ÌÅ¨Î¶º', items: ['Î∞îÎãêÎùº', 'Î≤ÑÌÑ∞', 'ÌÅ¨Î¶º', 'ÎßàÏãúÎ©úÎ°úÏö∞', 'ÌÜ†Ìîº', 'Ïó∞Ïú†', 'Ïª§Ïä§ÌÑ∞Îìú', 'ÏÉùÌÅ¨Î¶º'] } ] },
      { id: 'nutty', label: 'Í≤¨Í≥º/Ï¥àÏΩî (Nutty)', color: 'bg-amber-700', bg: 'bg-amber-50', text: 'text-amber-900', subs: [ { group: 'Ï¥àÏΩúÎ¶ø', items: ['Îã§ÌÅ¨ Ï¥àÏΩúÎ¶ø', 'Î∞ÄÌÅ¨ Ï¥àÏΩúÎ¶ø', 'Ïπ¥Ïπ¥Ïò§ÎãôÏä§', 'ÏΩîÏΩîÏïÑ ÌååÏö∞Îçî', 'Ï¥àÏΩîÏãúÎüΩ'] }, { group: 'Í≤¨Í≥ºÎ•ò', items: ['ÏïÑÎ™¨Îìú', 'Ìò∏Îëê', 'ÎïÖÏΩ©', 'Ìó§Ïù¥Ï¶êÎÑõ', 'ÌîºÏπ∏', 'Ï∫êÏäàÎÑõ', 'ÎßàÏπ¥Îã§ÎØ∏ÏïÑ', 'ÌîºÏä§ÌÉÄÏπòÏò§', 'Î∞§'] } ] },
      { id: 'roasted', label: 'Í≥†ÏÜåÌï® (Roasted)', color: 'bg-stone-500', bg: 'bg-stone-100', text: 'text-stone-700', subs: [ { group: 'Í≥°Î¨º (Cereal)', items: ['Í≥°Î¨º', 'Îß•ÏïÑ', 'Î≥∂ÏùÄ Î≥¥Î¶¨', 'ÌÜ†Ïä§Ìä∏', 'ÎàÑÎ£ΩÏßÄ', 'Îª•ÌäÄÍ∏∞', 'ÎπÑÏä§ÌÇ∑', 'ÎùºÏù¥Îß•', 'Ïò§Ìä∏Î∞Ä'] }, { group: 'Î°úÏä§Ìä∏ (Roast)', items: ['Ïä§Î™®ÌÇ§', 'ÌÉÑÎßõ', 'Ïû¨(Ash)', 'ÌÉÄÎ∞îÏΩî', 'Í∞ÄÏ£Ω', 'ÌõàÏ†ú'] }, { group: 'Í∞êÏπ†Îßõ (Savory)', items: ['Í∞ÑÏû•', 'ÎêúÏû•', 'ÌåùÏΩò', 'Î≤ÑÌÑ∞Îßõ'] } ] },
      { id: 'spices', label: 'Ìñ•Ïã†Î£å (Spices)', color: 'bg-rose-900', bg: 'bg-rose-50', text: 'text-rose-900', subs: [ { group: 'Î∏åÎùºÏö¥ Ïä§ÌååÏù¥Ïä§', items: ['ÏãúÎÇòÎ™¨', 'Ï†ïÌñ•', 'Ïú°ÎëêÍµ¨', 'ÏïÑÎãàÏä§', 'Í∞êÏ¥à', 'Í≥ÑÌîº'] }, { group: 'ÌóàÎ∏å/Í∏∞ÌÉÄ', items: ['ÌõÑÏ∂î', 'ÏÉùÍ∞ï', 'ÎØºÌä∏', 'ÏÑ∏Ïù¥ÏßÄ', 'Îîú', 'Î†àÎ™¨Í∑∏ÎùºÏä§', 'Î∞îÏßà', 'Ïú†ÏπºÎ¶ΩÌà¨Ïä§', 'Ïπ¥Î†à'] } ] },
      { id: 'vegetal', label: 'Ï±ÑÏÜå/ÏßÄÍµ¨ (Vegetal)', color: 'bg-green-600', bg: 'bg-green-50', text: 'text-green-700', subs: [ { group: 'ÌùôÎÇ¥Ïùå (Earthy)', items: ['Ìùô', 'ÎÇòÎ¨¥(Woody)', 'Í±¥Ï¥à', 'ÏßÄÌë∏ÎùºÍ∏∞', 'Î≤ÑÏÑØ', 'Ïù¥ÎÅº', 'Ïà≤Î∞îÎã•'] }, { group: 'Ï±ÑÏÜå (Vegetable)', items: ['Ïò§Ïù¥', 'ÏôÑÎëêÏΩ©', 'Ìò∏Î∞ï', 'ÌîºÎßù', 'ÌíÄ(Grassy)', 'Ïò¨Î¶¨Î∏å', 'ÍπªÏûé'] } ] },
      { id: 'sour', label: 'ÏÇ∞ÎØ∏/Î∞úÌö® (Sour)', color: 'bg-yellow-500', bg: 'bg-yellow-50', text: 'text-yellow-800', subs: [ { group: 'ÏïåÏΩú/Î∞úÌö®', items: ['ÏôÄÏù∏', 'ÏúÑÏä§ÌÇ§', 'Îüº', 'ÏÉ¥ÌéòÏù∏', 'ÎßâÍ±∏Î¶¨', 'Î∞úÌö®Ï∑®', 'Î±ÖÏáº'] }, { group: 'ÏÇ∞ÎØ∏/Í∏∞ÌÉÄ', items: ['ÏãùÏ¥à', 'ÏöîÍ±∞Ìä∏', 'ÏπòÏ¶à', 'ÏãúÌÅºÌïú', 'Í≥†Î¨¥', 'ÏïΩÌíà'] } ] }
    ];

    const safeStorage = {
      get: (key) => { try { return JSON.parse(localStorage.getItem(key)); } catch { return null; } },
      set: (key, value) => { try { localStorage.setItem(key, JSON.stringify(value)); return true; } catch { return false; } }
    };
    const formatTime = (sec) => `${Math.floor(sec/60)}:${(sec%60)<10?'0':''}${sec%60}`;
    const calculateRatio = (b, w) => { 
        const bean = parseFloat(b)||0; if(bean===0) return "0:0"; 
        let totalWater = 0; const matches = w.trim().match(/(\d+(?:\.\d+)?)(?:g)?/g); 
        if (matches) matches.forEach(m => { if (!m.includes('g')) totalWater += parseFloat(m); }); 
        return `1 : ${(totalWater/bean).toFixed(1)}`; 
    };

    const parseTags = (text) => {
        if (!text) return [];
        if (/[,/]/.test(text)) return text.split(/[,/]+/).map(t => t.trim()).filter(Boolean);
        return text.split(/\s+/).map(t => t.trim()).filter(Boolean);
    };
    const calcAvg = (scores) => { const values = Object.values(scores).map(v => parseFloat(v)); if (values.some(v => isNaN(v))) return "0.0"; return (values.reduce((a, b) => a + b, 0) / 6).toFixed(1); };
    const getDisplayScore = (tasting) => (tasting.isManualTotal && tasting.totalScore !== undefined) ? Number(tasting.totalScore).toFixed(1) : calcAvg(tasting.scores);
    const getMaxScoreVal = (tastings) => (!tastings.length) ? 0 : Math.max(...tastings.map(t => parseFloat(getDisplayScore(t))));
    const getMaxScore = (tastings) => getMaxScoreVal(tastings).toFixed(1);
    const getBestTastingNote = (tastings) => { if (!tastings || tastings.length === 0) return null; const sorted = [...tastings].sort((a, b) => parseFloat(getDisplayScore(b)) - parseFloat(getDisplayScore(a))); return sorted[0].notes; };
    const calcPricePer100g = (price, weight) => { if(!price || !weight) return null; const p = parseFloat(price.replace(/,/g, '')); const w = parseFloat(weight); if(isNaN(p) || isNaN(w) || w === 0) return null; return Math.round((p / w) * 100).toLocaleString(); };
    const formatWeight = (g) => { const num = parseFloat(g); if (isNaN(num)) return "0g"; if (num >= 1000) return `${(num/1000).toFixed(1)}kg`; return `${num}g`; };

    // --- 2. GLOBAL COMPONENTS (Defined at top) ---

    const FontLoader = () => {
        useEffect(() => {
          const fontUrl = 'https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Noto+Sans+KR:wght@400;500;700;900&family=Roboto+Mono:wght@500;700&display=swap';
          fetch(fontUrl)
            .then(res => res.text())
            .then(css => {
              const style = document.createElement('style');
              style.textContent = css;
              document.head.appendChild(style);
              document.documentElement.classList.add('font-loaded');
            })
            .catch(e => console.log('Font load skipped:', e));
        }, []);
        return null;
    };

    // --- Global Components ---
    /* ================================================================
       [DO NOT MODIFY START] CustomBeanIcon (Restored from v1.8.1 - Exact Match)
       !!! CRITICAL: Do not summarize or change path data !!!
    ================================================================ */
    const CustomBeanIcon = ({ size = 24, className = "" }) => (
      <svg 
        width={size} 
        height={size} 
        viewBox="212 184 600 600" 
        className={className}
        xmlns="http://www.w3.org/2000/svg"
        version="1.1"
        style={{ shapeRendering: "geometricPrecision", textRendering: "geometricPrecision", imageRendering: "optimizeQuality", fillRule: "evenodd", clipRule: "evenodd" }}
      >
        <g className="fill-current" stroke="currentColor" strokeWidth="20" strokeLinejoin="round" strokeLinecap="round">
            <path fillOpacity="0.9" d="M 606.5,191.5 C 626.3,189.9 645.6,192.1 664.5,198C 675.1,200.9 679.6,207.8 678,218.5C 673.5,239.2 662,254.5 643.5,264.5C 641.1,262.9 641.1,261.4 643.5,260C 642.4,258.6 641.1,257.6 639.5,257C 642.3,254.8 642,253.3 638.5,252.5C 653.5,243.8 662,230.8 664,213.5C 656.9,208.9 649.1,206.4 640.5,206C 628.2,204.8 615.9,204.3 603.5,204.5C 604.3,203.6 606,203.1 608.5,203C 605.1,202.8 601.8,202.3 598.5,201.5C 599.2,198.6 600.5,196.1 602.5,194C 601.5,193.7 600.5,193.3 599.5,193C 602,192.8 604.4,192.3 606.5,191.5 Z"/>
            <path fillOpacity="0.8" d="M 708.5,221.5 C 732.2,236 749.7,256 761,281.5C 773.9,310.9 780.4,341.8 780.5,374C 780.4,399.5 777.7,424.7 772.5,449.5C 768.5,441.6 765.5,433.2 763.5,424.5C 771.2,379 767,334.6 751,291.5C 741.7,269.9 727.9,251.9 709.5,237.5C 712.1,237.3 712.1,236.8 709.5,236C 710.8,230.9 709.5,226.6 705.5,223C 706.7,222.8 707.7,222.3 708.5,221.5 Z"/>
            <path fillOpacity="1.0" d="M 638.5,252.5 C 642,253.3 642.3,254.8 639.5,257C 641.1,257.6 642.4,258.6 643.5,260C 641.1,261.4 641.1,262.9 643.5,264.5C 630.7,271.7 618.1,279.2 605.5,287C 591.7,296.9 579.1,308.1 567.5,320.5C 563.5,318.7 559.7,318.7 556,320.5C 554.7,319.1 554.2,317.4 554.5,315.5C 560.9,307.6 567.9,300.1 575.5,293C 594.8,276.9 615.8,263.4 638.5,252.5 Z"/>
            <path fillOpacity="0.8" d="M 606.5,191.5 C 604.4,192.3 602,192.8 599.5,193C 600.5,193.3 601.5,193.7 602.5,194C 600.5,196.1 599.2,198.6 598.5,201.5C 601.8,202.3 605.1,202.8 608.5,203C 606,203.1 604.3,203.6 603.5,204.5C 591.2,206.3 578.8,208.8 566.5,212C 529.9,223.1 496.3,239.8 465.5,262C 411.7,302.1 368.2,351.3 335,409.5C 310.1,452.9 293.6,499.2 285.5,548.5C 284.8,551.2 284.2,553.8 283.5,556.5C 282.7,557 282,558.3 281.5,560.5C 280.7,559.6 280.2,558.6 280,557.5C 279.7,558.3 279.2,559 278.5,559.5C 276.6,559.1 275.1,558.1 274,556.5C 273.7,557.2 273.3,557.8 273,558.5C 272.8,556.3 272.3,554.3 271.5,552.5C 276.3,515 286.4,479 302,444.5C 343,354.6 405.2,283.4 488.5,231C 515.5,215.2 544.1,203.6 574.5,196C 585,193.5 595.7,192 606.5,191.5 Z"/>
            <path fillOpacity="0.9" d="M 554.5,315.5 C 554.2,317.4 554.7,319.1 556,320.5C 559.7,318.7 563.5,318.7 567.5,320.5C 528.7,366.6 506.6,420 501,480.5C 491.1,533.4 469.1,580.4 435,621.5C 428.2,628.3 421.3,635.2 414.5,642C 407.2,648 399.5,653.5 391.5,658.5C 391.2,657 390.2,656.3 388.5,656.5C 387.7,651.4 384.7,649.4 379.5,650.5C 389.2,644.3 398.5,637.5 407.5,630C 433.2,606 453,577.8 467,545.5C 480.9,510.7 489.9,474.7 494,437.5C 504.4,391.7 524.6,351 554.5,315.5 Z"/>
            <path d="M 763.5,424.5 C 765.5,433.2 768.5,441.6 772.5,449.5C 748.4,553.2 695.8,639 614.5,707C 576.4,737.9 533.4,759.6 485.5,772C 474.2,774.2 462.9,776 451.5,777.5C 452.6,776.7 453.9,776.2 455.5,776C 452.2,775.7 448.8,775.3 445.5,775C 443.7,772.8 441.7,770.8 439.5,769C 443.5,766.7 447.8,765.3 452.5,765C 450.2,764.5 447.9,764.3 445.5,764.5C 445.5,764.2 445.5,763.8 445.5,763.5C 461.7,762.6 477.7,760.1 493.5,756C 533.4,743.5 569.8,724.5 602.5,699C 684.1,632.5 736.4,547.7 759.5,444.5C 760.9,442.5 761.6,440.2 761.5,437.5C 761.8,433 762.4,428.6 763.5,424.5 Z"/>
            <path d="M 271.5,552.5 C 272.3,554.3 272.8,556.3 273,558.5C 273.3,557.8 273.7,557.2 274,556.5C 275.1,558.1 276.6,559.1 278.5,559.5C 279.2,559 279.7,558.3 280,557.5C 280.2,558.6 280.7,559.6 281.5,560.5C 282,558.3 282.7,557 283.5,556.5C 283.5,559.5 283.5,562.5 283.5,565.5C 280.6,594.5 282.8,623.2 290,651.5C 295.9,673.2 306.4,692.2 321.5,708.5C 319.9,708.5 318.2,708.5 316.5,708.5C 314,709.7 314,710.9 316.5,712C 314,714.2 314.3,716.2 317.5,718C 316.7,719.6 317.3,720.6 319.5,721C 318.6,721.3 317.9,721.8 317.5,722.5C 298.3,704.7 285.1,683.1 278,657.5C 268.3,622.8 266.2,587.8 271.5,552.5 Z"/>
            <path fillOpacity="1.0" d="M 708.5,221.5 C 707.7,222.3 706.7,222.8 705.5,223C 709.5,226.6 710.8,230.9 709.5,236C 712.1,236.8 712.1,237.3 709.5,237.5C 708,236.7 706.7,236.7 705.5,237.5C 699.6,253.4 690.6,267.2 678.5,279C 664.2,289.5 649.5,299.5 634.5,309C 590.3,346.8 562.2,394.3 550,451.5C 546,481.8 539.3,511.5 530,540.5C 504.3,613.9 456.4,667.4 386.5,701C 373.4,709.9 365.4,722.1 362.5,737.5C 363,741.8 365,745.3 368.5,748C 380.6,756.1 393.9,760.9 408.5,762.5C 411.3,763.3 414.3,763.8 417.5,764C 426.8,764.5 436.1,764.6 445.5,764.5C 447.9,764.3 450.1,764.5 452.5,765C 447.8,765.3 443.5,766.6 439.5,769C 441.7,770.8 443.7,772.8 445.5,775C 448.8,775.3 452.1,775.6 455.5,776C 453.9,776.2 452.6,776.7 451.5,777.5C 422.4,780.6 394.8,776.1 368.5,764C 350.4,755.3 344.9,741.4 352,722.5C 359.2,707.2 370.1,695 384.5,686C 446.4,656.0 489.5,608.9 514,544.5C 519.5,529.1 524.2,513.4 528,497.5C 531.7,473.6 536.4,449.9 542,426.5C 557.4,375.6 585.3,333.1 625.5,299C 636.6,290.5 648.3,282.9 660.5,276C 678.3,262.5 690.3,245 696.5,223.5C 700,220.3 704,219.7 708.5,221.5 Z"/>
            <path fillOpacity="1.0" d="M 379.5,650.5 C 384.7,649.3 387.7,651.3 388.5,656.5C 390.1,656.2 391.1,656.9 391.5,658.5C 377.8,665.8 365.3,674.8 354,685.5C 343.7,697 336.2,710.2 331.5,725C 326.2,727.4 321.5,726.6 317.5,722.5C 317.9,721.7 318.5,721.2 319.5,721C 317.3,720.5 316.6,719.5 317.5,718C 314.3,716.1 313.9,714.1 316.5,712C 313.9,710.9 313.9,709.7 316.5,708.5C 318.1,708.5 319.8,708.5 321.5,708.5C 322.3,709.5 323.2,709.5 324,708.5C 335.1,682.1 353.6,662.8 379.5,650.5 Z"/>
        </g>
        <g fill="white" fillOpacity="0.3"><path d="M 603.5,204.5 C 615.9,204.3 628.2,204.8 640.5,206C 649.1,206.4 656.9,208.9 664,213.5C 662,230.8 653.5,243.8 638.5,252.5C 615.8,263.4 594.8,276.9 575.5,293C 567.9,300.1 560.9,307.6 554.5,315.5C 524.6,351 504.4,391.7 494,437.5C 489.9,474.7 480.9,510.7 467,545.5C 453,577.8 433.2,606 407.5,630C 398.5,637.5 389.2,644.3 379.5,650.5C 353.7,662.8 335.2,682.2 324,708.5C 323.2,709.6 322.4,709.6 321.5,708.5C 306.4,692.2 295.9,673.2 290,651.5C 282.8,623.2 280.6,594.5 283.5,565.5C 284.9,560.1 285.6,554.4 285.5,548.5C 293.6,499.2 310.1,452.9 335,409.5C 368.2,351.3 411.7,302.1 465.5,262C 496.3,239.8 529.9,223.1 566.5,212C 578.8,208.8 591.2,206.3 603.5,204.5 Z"/></g>
      </svg>
    );
    /* [DO NOT MODIFY END] */

    const useLongPress = (callback = () => {}, speed = 100, delay = 400) => {
      const timerRef = useRef(null); 
      const delayRef = useRef(null); 
      const isTouchRef = useRef(false);
      const start = useCallback((event) => {
        if (event.type === 'touchstart') isTouchRef.current = true;
        else if (event.type === 'mousedown' && isTouchRef.current) return;
        callback(); 
        delayRef.current = setTimeout(() => { timerRef.current = setInterval(callback, speed); }, delay);
      }, [callback, speed, delay]);
      const stop = useCallback(() => {
        if (delayRef.current) clearTimeout(delayRef.current);
        if (timerRef.current) clearInterval(timerRef.current);
        delayRef.current = null; timerRef.current = null;
        setTimeout(() => { isTouchRef.current = false; }, 500);
      }, []);
      return { onMouseDown: start, onMouseUp: stop, onMouseLeave: stop, onTouchStart: (e) => { if(e.cancelable) e.preventDefault(); start(e); }, onTouchEnd: stop };
    };

    const ScoreButton = ({ onClick, icon: Icon }) => {
      const longPressProps = useLongPress(onClick, 80, 400); 
      return <button {...longPressProps} className="w-8 h-8 bg-white rounded-full shadow border flex items-center justify-center active:scale-95 transition-transform no-select">{Icon}</button>;
    };

    const ScoreButtonPlus = ({ onClick, icon: Icon }) => {
      const longPressProps = useLongPress(onClick, 80, 400); 
      return <button {...longPressProps} className="w-8 h-8 bg-slate-900 rounded-full shadow flex items-center justify-center active:scale-95 transition-transform no-select">{Icon}</button>;
    };

    const AccurateRadarChart = ({ scores }) => {
      const size = 100, center = size / 2, radius = size * 0.45;
      const keys = ['acidity', 'balance', 'sweetness', 'cleanCup', 'body', 'flavor'];
      const labels = ['ÏÇ∞ÎØ∏', 'Î∞∏Îü∞Ïä§', 'Îã®Îßõ', 'ÌÅ¥Î¶∞Ïªµ', 'Î∞îÎîî', 'Ìñ•ÎØ∏'];
      const getPoint = (value, index) => { const angle = (Math.PI * 2 * index) / 6 - Math.PI / 2; const val = parseFloat(value) || 0; const r = (val / 10) * radius; return `${center + r * Math.cos(angle)},${center + r * Math.sin(angle)}`; };
      const gridLevels = [10, 8, 6, 4, 2];
      const bgPoints = gridLevels.map(scale => keys.map((_, i) => getPoint(scale, i)).join(' '));
      const dataPoints = keys.map((key, i) => getPoint(scores[key], i)).join(' ');
      const labelCoords = keys.map((_, i) => { const angle = (Math.PI * 2 * i) / 6 - Math.PI / 2; const r = radius + 12; return { x: center + r * Math.cos(angle), y: center + r * Math.sin(angle), text: labels[i] }; });
      return (
        <svg width="100%" height="100%" viewBox={`0 0 ${size} ${size}`} className="overflow-visible font-capture">
          {bgPoints.map((pts, i) => <polygon key={i} points={pts} fill="none" stroke="#e2e8f0" strokeWidth={i === 0 ? "0.8" : "0.5"} />)}
          {keys.map((_, i) => { const end = getPoint(10, i).split(','); return <line key={i} x1={center} y1={center} x2={end[0]} y2={end[1]} stroke="#e2e8f0" strokeWidth="0.8" /> })}
          <polygon points={dataPoints} fill="rgba(120, 53, 15, 0.3)" stroke="#78350f" strokeWidth="1.5" />
          {labelCoords.map((l, i) => <text key={i} x={l.x} y={l.y} textAnchor="middle" dominantBaseline="middle" fontSize="8" fill="#64748b" fontWeight="bold">{l.text}</text>)}
        </svg>
      );
    };

    const RadarChart = ({ scores }) => {
        const size=120, center=size/2, radius=size*0.4;
        const pts = TASTE_ITEMS.map((item, i) => { const angle = (Math.PI*2*i)/6 - Math.PI/2; const val = parseFloat(scores[item.id])||0; return `${center + (val/10)*radius * Math.cos(angle)},${center + (val/10)*radius * Math.sin(angle)}`; }).join(' ');
        return <svg width={size} height={size} className="overflow-visible">{[1,2,3,4,5].map(s=><polygon key={s} points={TASTE_ITEMS.map((_,i)=>{const a=(Math.PI*2*i)/6-Math.PI/2;const r=(s/5)*radius;return`${center+r*Math.cos(a)},${center+r*Math.sin(a)}`;}).join(' ')} fill="none" stroke="#e2e8f0" strokeWidth="1"/>)}<polygon points={pts} fill="rgba(120, 53, 15, 0.3)" stroke="#78350f" strokeWidth="2"/>{TASTE_ITEMS.map((t,i)=><text key={i} x={center+(radius+15)*Math.cos((Math.PI*2*i)/6-Math.PI/2)} y={center+(radius+15)*Math.sin((Math.PI*2*i)/6-Math.PI/2)} textAnchor="middle" dominantBaseline="middle" fontSize="9" fontWeight="bold" fill="#475569">{t.label}</text>)}</svg>;
    };

    const ImageCropper = ({ imageSrc, aspectRatio, onComplete, onCancel }) => {
      const imageRef = useRef(null);
      const cropperRef = useRef(null);

      useLayoutEffect(() => {
        if (imageRef.current) {
          cropperRef.current = new Cropper(imageRef.current, {
            aspectRatio: aspectRatio,
            viewMode: 1,
            autoCropArea: 0.9,
            background: false,
            guides: true,
            rotatable: true,
          });
        }
        return () => {
          if (cropperRef.current) {
            cropperRef.current.destroy();
          }
        };
      }, [imageSrc, aspectRatio]);

      const handleCrop = () => {
        if (cropperRef.current) {
          const canvas = cropperRef.current.getCroppedCanvas({ width: 800, height: 800 });
          if (canvas) {
            onComplete(canvas.toDataURL('image/jpeg', 0.85));
          }
        }
      };

      return (
        <div className="fixed inset-0 z-[60] bg-black/90 flex flex-col animate-in fade-in">
          <div className="flex-1 relative bg-black flex items-center justify-center p-4 overflow-hidden">
             <img ref={imageRef} src={imageSrc} alt="Crop" style={{ maxWidth: '100%', maxHeight: '80vh' }} />
          </div>
          <div className="p-5 bg-slate-900 flex justify-between gap-4">
             <button onClick={onCancel} className="flex-1 py-3 bg-slate-800 text-white rounded-xl font-bold">Ï∑®ÏÜå</button>
             <button onClick={handleCrop} className="flex-1 py-3 bg-white text-slate-900 rounded-xl font-bold">ÏôÑÎ£å</button>
          </div>
        </div>
      );
    };

    const FlavorPicker = ({ onClose, onConfirm, initialNotes = "" }) => {
        const [activeTab, setActiveTab] = useState('fruity');
        const [selectedNotes, setSelectedNotes] = useState(parseTags(initialNotes));
        const toggleNote = (note) => setSelectedNotes(selectedNotes.includes(note) ? selectedNotes.filter(n => n !== note) : [...selectedNotes, note]);
        const activeCategory = FLAVOR_DATA.find(d => d.id === activeTab);
        return (
            <div className="fixed inset-0 z-50 bg-black/50 flex items-end sm:items-center justify-center animate-in fade-in backdrop-blur-sm" onClick={onClose}>
                <div className="w-full max-w-md h-[85vh] sm:h-[700px] bg-white sm:rounded-[32px] rounded-t-[32px] shadow-2xl flex flex-col relative animate-slide-up overflow-hidden font-sans" onClick={e=>e.stopPropagation()}>
                    <div className="p-5 pb-2 flex justify-between items-center bg-white z-10 shrink-0"><div><h2 className="text-xl font-black text-slate-900 flex items-center gap-2"><Palette size={20} className="text-indigo-500"/> Flavor Picker</h2><p className="text-xs text-slate-400 mt-1">ÏõêÌïòÎäî ÎßõÏùÑ ÌÑ∞ÏπòÌïòÏó¨ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</p></div><button onClick={onClose} className="p-2 bg-slate-100 rounded-full text-slate-400 hover:bg-slate-200"><X size={20}/></button></div>
                    <div className="border-b border-slate-100 bg-white shrink-0"><div className="flex overflow-x-auto no-scrollbar px-5 gap-2 pb-3 pt-1">{FLAVOR_DATA.map((cat) => (<button key={cat.id} onClick={() => setActiveTab(cat.id)} className={`whitespace-nowrap px-3.5 py-1.5 rounded-full text-xs font-bold transition-all ${activeTab === cat.id ? `${cat.color} text-white shadow-md scale-105` : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>{cat.label.split(' ')[0]}</button>))}</div></div>
                    <div className={`flex-1 overflow-y-auto p-5 pb-32 transition-colors duration-300 ${activeCategory.bg}`}>{activeCategory.subs.map((sub, idx) => (<div key={idx} className="mb-6 animate-pop" style={{ animationDelay: `${idx * 50}ms` }}><h3 className={`text-xs font-bold ${activeCategory.text} uppercase mb-2 ml-1 opacity-80 flex items-center gap-1`}><span className="w-1.5 h-1.5 rounded-full bg-current"></span> {sub.group}</h3><div className="flex flex-wrap gap-2">{sub.items.map((item) => { const isSelected = selectedNotes.includes(item); return (<button key={item} onClick={() => toggleNote(item)} className={`px-3 py-2 rounded-xl text-xs font-bold border-2 transition-all ${isSelected ? 'bg-slate-800 border-slate-800 text-white shadow-md scale-105' : 'bg-white border-transparent text-slate-600 hover:border-slate-200'}`}>{item}</button>) })}</div></div>))}</div>
                    <div className="absolute bottom-0 left-0 right-0 bg-white border-t border-slate-100 p-5 z-20 pb-8 sm:pb-5 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]"><div className="flex overflow-x-auto no-scrollbar gap-2 mb-4 pb-1 min-h-[30px] items-center">{selectedNotes.length > 0 ? selectedNotes.map(note => (<span key={note} className="whitespace-nowrap px-3 py-1 bg-slate-100 text-slate-700 rounded-lg text-xs font-bold flex items-center gap-1 border border-slate-200 animate-pop">{note} <button onClick={() => toggleNote(note)}><X size={10} className="text-slate-400 hover:text-red-500"/></button></span>)) : <span className="text-xs text-slate-400">ÏÑ†ÌÉùÎêú ÎßõÏù¥ ÏóÜÏäµÎãàÎã§.</span>}</div><button onClick={() => onConfirm(selectedNotes.join(', '))} className="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2 hover:bg-slate-800"><Check size={18}/> {selectedNotes.length}Í∞ú ÏÑ†ÌÉù ÏôÑÎ£å</button></div>
                </div>
            </div>
        );
    };
    
    const ShareModal = ({ bean, tasting, onClose }) => {
        const cardRef = useRef(null); const [generatedImg, setGeneratedImg] = useState(null); const [isGenerating, setIsGenerating] = useState(true);
        const totalScore = getDisplayScore(tasting); const beanTags = parseTags(bean.notes); const tastingTags = parseTags(tasting.notes);
        const specs = [{ label: "Region", value: bean.region, icon: <MapPin size={8}/> }, { label: "Process", value: bean.processing, icon: <Layers size={8}/> }, { label: "Roast", value: bean.roastingLevel, icon: <Flame size={8}/> }, { label: "Variety", value: bean.variety, icon: <Tag size={8}/> }].filter(s => s.value);
        useEffect(() => { const generate = async () => { await new Promise(r => setTimeout(r, 800)); if(cardRef.current) { try { const blob = await htmlToImage.toBlob(cardRef.current, { quality: 0.95, backgroundColor: '#ffffff', skipAutoScale: true, pixelRatio: 2, filter: (n) => n.tagName !== 'LINK' }); if (blob) { setGeneratedImg(URL.createObjectURL(blob)); } } catch(e) { console.error(e); } finally { setIsGenerating(false); } } }; generate(); }, []);
        const handleDownload = () => { if (generatedImg) { const link = document.createElement('a'); link.download = `BeanLog_${bean.name}_${tasting.date}.jpg`; link.href = generatedImg; link.click(); } };
        return (
            <div className="fixed inset-0 z-[60] bg-black/90 flex flex-col items-center justify-center p-4 animate-in fade-in">
                <div className="fixed top-0 left-[-9999px]"><div ref={cardRef} className="w-[320px] bg-white rounded-sm shadow-2xl overflow-hidden font-capture text-slate-800"><div className="relative h-60 bg-slate-200">{bean.mainImage ? (<div className="absolute inset-0 bg-cover bg-center" style={{ backgroundImage: `url(${bean.mainImage})` }} />) : (<div className="absolute inset-0 flex items-center justify-center text-slate-400"><CustomBeanIcon size={128} className="opacity-50"/></div>)}<div className="absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"></div><div className="absolute bottom-0 left-0 right-0 p-5 text-white z-10"><div className="flex items-center justify-between mb-2 opacity-100 items-start"><span className="text-[10px] font-black text-white font-capture whitespace-nowrap drop-shadow-md truncate max-w-[70%]">{bean.shop || "Home Cafe"}</span><div className="flex flex-col items-end drop-shadow-md">{bean.roastingDate && <span className="text-[8px] font-medium opacity-90 mb-0.5">Roast: {bean.roastingDate}</span>}<span className="text-[10px] font-bold opacity-100">Taste: {tasting.date}</span></div></div><h1 className="text-lg font-black leading-snug mb-1 line-clamp-2 drop-shadow-md font-capture">{bean.name}</h1><p className="text-xs font-bold text-amber-400 mb-3">{bean.country}</p><div className="flex flex-wrap gap-1.5">{specs.map((s, i) => (<span key={i} className="inline-flex items-center gap-1 px-1.5 h-[18px] rounded bg-black/40 border border-white/20 text-[9px] font-medium text-slate-100"><span className="opacity-70 flex items-center">{s.icon}</span> <span className="leading-none pt-[1.5px]">{s.value}</span></span>))}</div></div></div><div className="p-5 flex flex-col gap-4 bg-white"><div className="grid grid-cols-1 gap-3">{beanTags.length > 0 && (<div className="flex items-start gap-3"><span className="h-[20px] flex items-center justify-center text-[9px] font-black text-amber-700 bg-amber-50 px-2 rounded border border-amber-100 w-14 shrink-0 pt-[1px] gap-1"><CustomBeanIcon size={10} /> BEAN</span><p className="text-xs font-medium text-slate-600 leading-relaxed pt-[1px]">{beanTags.join(', ')}</p></div>)}{tastingTags.length > 0 && (<div className="flex items-start gap-3"><span className="h-[20px] flex items-center justify-center text-[9px] font-black text-blue-700 bg-blue-50 px-2 rounded border border-blue-100 w-14 shrink-0 pt-[1px] gap-1"><Coffee size={10} /> TASTE</span><p className="text-xs font-medium text-slate-600 leading-relaxed pt-[1px]">{tastingTags.join(', ')}</p></div>)}</div><div className="space-y-2 pt-2 border-t border-dashed border-slate-100">{tasting.desc && (<p className="text-xs text-slate-700 font-medium leading-relaxed"><Quote size={12} className="inline text-slate-300 mr-1 -mt-1"/>{tasting.desc}</p>)}{(tasting.memo || bean.memo) && (<div className="flex gap-2 items-start"><StickyNote size={12} className="text-slate-400 shrink-0 mt-0.5"/><div className="text-[10px] text-slate-500 font-medium leading-snug whitespace-pre-wrap">{tasting.memo || bean.memo}</div></div>)}</div></div><div className="bg-slate-50 border-t border-slate-100 p-4 px-5 flex items-center justify-between gap-3"><div className="flex flex-col shrink-0 items-center justify-center"><span className="text-[8px] font-bold text-slate-400 uppercase tracking-widest mb-0.5">Total</span><span className="text-4xl font-black text-slate-900 tracking-tighter leading-none font-capture">{totalScore}</span></div><div className="flex-1 grid grid-cols-2 gap-x-3 text-[9px] text-slate-500 font-bold border-l border-slate-200 pl-4">{Object.entries(tasting.scores).map(([k,v])=><div key={k} className="flex justify-between w-full items-end"><span>{SCORE_LABELS_KO[k]}</span><span className="dot-line"></span><span className="text-slate-900 text-[10px] font-black">{Number(v).toFixed(1)}</span></div>)}</div><div className="w-[70px] h-[70px] shrink-0"><AccurateRadarChart scores={tasting.scores} /></div></div><div className="bg-slate-900 text-white text-center py-2"><p className="text-[8px] font-bold tracking-[0.2em] uppercase opacity-60 font-brand">Recorded with BeanLog</p></div></div></div>
                <div className="flex flex-col items-center gap-6">{isGenerating ? (<div className="flex flex-col items-center text-white gap-2"><div className="loader-white"></div><span className="text-xs">Ïπ¥Îìú ÎßåÎìúÎäî Ï§ë...</span></div>) : (<div className="flex flex-col items-center animate-in zoom-in-95 duration-300"><img src={generatedImg} className="w-[300px] rounded-lg shadow-2xl mb-4" alt="Review Card" /><p className="text-white text-sm font-bold animate-pulse">üëÜ Ïù¥ÎØ∏ÏßÄÎ•º Íæπ ÎàåÎü¨ Ï†ÄÏû•ÌïòÏÑ∏Ïöî</p></div>)}<button onClick={onClose} className="bg-white/20 text-white px-8 py-3 rounded-full font-bold backdrop-blur-sm hover:bg-white/30 transition-colors">Îã´Í∏∞</button>{generatedImg && (<button onClick={handleDownload} className="text-white/60 text-xs hover:text-white underline">Îã§Ïö¥Î°úÎìú Î≤ÑÌäºÏúºÎ°ú Ï†ÄÏû•ÌïòÍ∏∞</button>)}</div>
            </div>
        );
    };

    // --- Helper Components & Functions for Timer (Moved outside for stability) ---
    
    // Timer Icons Component (Scoped)
    const MiniIcon = ({ iconType, isMain }) => {
        let IconComp = Droplet; let colorClass = "text-slate-400";
        if (iconType === 'BEAN') return <div className={`flex items-center justify-center ${isMain?'w-8 h-8 bg-amber-100 shadow-sm rounded-full border border-amber-200':'w-6 h-6'}`}><CustomBeanIcon size={isMain?20:16} className="text-amber-700"/></div>;
        switch (iconType) {
            case 'CLOSE': IconComp = ToggleRight; colorClass = "text-orange-500 rotate-180"; break;
            case 'OPEN': IconComp = ToggleRight; colorClass = "text-orange-500"; break;
            case 'STIR': IconComp = Utensils; colorClass = "text-purple-500"; break;
            case 'SWIRL': IconComp = Waves; colorClass = "text-purple-500"; break;
            case 'CIRCLE': IconComp = RefreshCcw; colorClass = "text-blue-500"; break;
            case 'SPIRAL': IconComp = Tornado; colorClass = "text-blue-500"; break;
            case 'CENTER': IconComp = Target; colorClass = "text-blue-500"; break;
            case 'POUR': IconComp = Droplet; colorClass = "text-blue-500"; break;
            case 'CLOCK': IconComp = Clock; colorClass = "text-slate-400"; break;
            case 'CHECK': IconComp = Check; colorClass = "text-green-500"; break;
            default: IconComp = Play;
        }
        return <div className={`flex items-center justify-center ${isMain?'w-8 h-8 bg-white shadow-sm rounded-full border border-slate-100':'w-6 h-6'}`}><IconComp size={isMain?18:14} className={colorClass} strokeWidth={isMain?2.5:2} /></div>;
    };

    const TimerStepRow = ({ step, isCurrent, isPast, itemRef }) => (
        <div ref={itemRef} className={`flex items-center gap-4 p-5 rounded-2xl border transition-all duration-500 cursor-pointer ${isCurrent ? `bg-white shadow-xl step-active border-l-8` : (isPast ? 'bg-slate-100 opacity-60 grayscale border-transparent step-inactive' : 'bg-white border-transparent opacity-70')}`}>
            <div className={`rounded-xl p-1.5 flex items-center gap-1 border shrink-0 min-w-[60px] justify-center transition-colors ${isCurrent ? 'bg-blue-50 border-blue-100' : 'bg-slate-50 border-slate-100'}`}>
                {step.icons && step.icons.length > 0 ? step.icons.map((item, idx) => <MiniIcon key={idx} iconType={item.icon} isMain={item.type === 'MAIN'} />) : <Clock size={16} className="text-slate-300"/>}
            </div>
            <div className="flex-1 min-w-0">
                <div className="flex justify-between items-center mb-0.5"><span className={`text-[10px] font-bold uppercase tracking-wider ${isCurrent ? 'text-blue-500' : 'text-slate-400'}`}>{step.originalCmd || 'STEP'}</span><span className="text-[10px] font-mono text-slate-400 bg-slate-100 px-1.5 rounded">{step.timeRange}</span></div>
                <h3 className={`text-base font-bold leading-tight break-keep flex flex-wrap items-baseline gap-1 ${isCurrent ? 'text-slate-900' : 'text-slate-500'}`}>
                    <span>{step.desc}</span>
                    {step.cumWater && (
                        <span className="text-xs text-blue-500 font-medium whitespace-nowrap ml-1">
                            (ÎàÑÏ†Å {step.cumWater}ml{step.pourCount ? ` ‚Ä¢ ${step.pourCount}Ï∞® Ìë∏Ïñ¥` : ''})
                        </span>
                    )}
                </h3>
            </div>
        </div>
    );

    const parseStepCommand = (inputStr) => {
        const lower = inputStr.toLowerCase().trim();
        const numMatch = lower.match(/(\d+(?:\.\d+)?)/);
        const value = numMatch ? parseFloat(numMatch[0]) : null;
        let prefixStr = "", suffixStr = "";
        if (value !== null) {
            const numIndex = lower.indexOf(numMatch[0]);
            prefixStr = lower.substring(0, numIndex);
            suffixStr = lower.substring(numIndex + numMatch[0].length);
        } else { prefixStr = lower; }

        const dict = {
            pre: { cl: { text: "Ïä§ÏúÑÏπò Îã´Í≥†", icon: 'CLOSE' }, op: { text: "Ïä§ÏúÑÏπò Ïó¥Í≥†", icon: 'OPEN' }, st: { text: "Ï†ìÍ≥†", icon: 'STIR' }, sw: { text: "ÌùîÎì§Í≥†", icon: 'SWIRL' } },
            post: { cl: { text: "Ïä§ÏúÑÏπò Îã´Í∏∞", icon: 'CLOSE' }, op: { text: "Ïä§ÏúÑÏπò Ïó¥Í∏∞", icon: 'OPEN' }, st: { text: "Ï†ìÍ∏∞", icon: 'STIR' }, sw: { text: "ÌùîÎì§Í∏∞", icon: 'SWIRL' } },
            style: { c: { text: "Circle", icon: 'CIRCLE' }, s: { text: "Spiral", icon: 'SPIRAL' }, ct: { text: "Center", icon: 'CENTER' }, k: { text: "Center", icon: 'CENTER' } }
        };

        const analyze = (str, type) => {
            let temp = str, items = [], foundStyle = null;
            ['cl', 'op', 'st', 'sw'].forEach(key => { if (temp.includes(key)) { items.push({ ...dict[type][key], key }); temp = temp.replace(key, ''); } });
            if (temp.includes('ct') || temp.includes('k')) { foundStyle = dict.style.ct; } else if (temp.includes('s')) { foundStyle = dict.style.s; } else if (temp.includes('c')) { foundStyle = dict.style.c; }
            return { items, foundStyle };
        };

        const pre = analyze(prefixStr, 'pre'), suf = analyze(suffixStr, 'post');
        let sentenceParts = [], icons = [];

        pre.items.forEach(item => {
            let text = item.text;
            if (value === null && dict.post[item.key]) text = dict.post[item.key].text;
            sentenceParts.push(text); icons.push({ type: 'PRE', icon: item.icon });
        });

        const appliedStyle = pre.foundStyle || suf.foundStyle;
        let stepMeta = { value: null, isBean: false };

        if (value !== null) {
            const isBean = lower.includes('g') && !lower.includes('ml');
            stepMeta = { value, isBean };
            if (isBean) { sentenceParts.push(`+ ÏõêÎëê ${value}g`); icons.push({ type: 'MAIN', icon: 'BEAN' }); }
            else { 
                let pourText = `+${value}ml`;
                if (appliedStyle) pourText += ` (${appliedStyle.text})`;
                sentenceParts.push(pourText); icons.push({ type: 'MAIN', icon: appliedStyle ? appliedStyle.icon : 'POUR' }); 
            }
        }

        if (suf.items.length > 0) {
            if (sentenceParts.length > 0) sentenceParts.push("ÌõÑ");
            suf.items.forEach(item => { sentenceParts.push(item.text); icons.push({ type: 'POST', icon: item.icon }); });
        }
        
        return { fullText: sentenceParts.join(' '), icons, stepMeta };
    };

    const parseRecipe = (data) => {
        const waterSteps = data.water.trim().split(/\s+/), intervalSteps = data.interval.trim().split(/\s+/);
        const [min, sec] = data.endTime.includes(':') ? data.endTime.split(':').map(Number) : [0, parseInt(data.endTime)];
        const totalSec = min * 60 + sec;
        let accTime = 0, cumWater = 0; const timeline = [];
        let pourCounter = 0;

        waterSteps.forEach((stepToken, i) => {
            let duration = parseInt(intervalSteps[i] || 0);
            if (i === waterSteps.length - 1 || isNaN(duration) || duration === 0) { const remaining = totalSec - accTime; duration = remaining > 0 ? remaining : 0; }
            const startTime = accTime, endTimeStr = formatTime(accTime + duration), timeRange = `${formatTime(startTime)} ~ ${endTimeStr}`;
            const { fullText, icons, stepMeta } = parseStepCommand(stepToken);
            
            let currentCumWater = null;
            let currentPourCount = null;

            if (stepMeta.value && !stepMeta.isBean) { 
                cumWater += stepMeta.value; 
                currentCumWater = cumWater; 
                pourCounter++;
                currentPourCount = pourCounter;
            }

            timeline.push({ startTime, duration, timeRange, desc: fullText || stepToken, icons, originalCmd: stepToken, cumWater: currentCumWater, pourCount: currentPourCount });
            accTime += duration;
        });

        if (accTime < totalSec) timeline.push({ startTime: accTime, duration: totalSec - accTime, timeRange: `${formatTime(accTime)} ~ ${formatTime(totalSec)}`, desc: 'Ï∂îÏ∂ú ÎåÄÍ∏∞ (Drawdown)', icons: [{ type: 'MAIN', icon: 'CLOCK' }] });
        timeline.push({ startTime: totalSec, timeRange: formatTime(totalSec), desc: 'Ï∂îÏ∂ú Ï¢ÖÎ£å (Finish)', duration: 0, icons: [{ type: 'MAIN', icon: 'CHECK' }] });
        return timeline;
    };


    // --- BEANS TAB ---
    const BeansTab = ({ active, globalApiKey, navProps, onNavConsumed }) => {
        const VIEW = { LIST: 'LIST', DETAIL: 'DETAIL', EDIT_BEAN: 'EDIT_BEAN', EDIT_TASTING: 'EDIT_TASTING' };
        const NOTE_MODE = { BEAN: 'BEAN', TASTING: 'TASTING' };
        const SORT_MODE = { CREATED_DESC: 'CREATED_DESC', PURCHASE_DESC: 'PURCHASE_DESC', ROAST_DESC: 'ROAST_DESC', SCORE_DESC: 'SCORE_DESC', STATUS_ASC: 'STATUS_ASC' };
        const SORT_LABELS = { [SORT_MODE.CREATED_DESC]: 'ÏµúÍ∑º ÏûÖÎ†•Ïàú', [SORT_MODE.PURCHASE_DESC]: 'ÏµúÍ∑º Íµ¨Îß§ÏùºÏàú', [SORT_MODE.ROAST_DESC]: 'ÏµúÍ∑º Î°úÏä§ÌåÖÏàú', [SORT_MODE.SCORE_DESC]: 'ÌèâÏ†ê ÎÜíÏùÄÏàú', [SORT_MODE.STATUS_ASC]: 'ÎÇ®ÏùÄ ÏõêÎëê Î®ºÏ†Ä' };

        const [view, setView] = useState(VIEW.LIST);
        const [beans, setBeans] = useState([]);
        const [selectedId, setSelectedId] = useState(null);
        const [editTastingIdx, setEditTastingIdx] = useState(null);
        const [searchTerm, setSearchTerm] = useState("");
        const [filterMode, setFilterMode] = useState("ALL");
        const [listNoteMode, setListNoteMode] = useState(NOTE_MODE.BEAN);
        const [sortMode, setSortMode] = useState(SORT_MODE.CREATED_DESC);
        const [showSortMenu, setShowSortMenu] = useState(false);
        const [shareData, setShareData] = useState(null);
        const [isProcessing, setIsProcessing] = useState(false);
        const [isSaving, setIsSaving] = useState(false);
        const [toast, setToast] = useState(null);
        const [showFlavorPicker, setShowFlavorPicker] = useState(false);
        const [pickerTarget, setPickerTarget] = useState(null);
        const [beanForm, setBeanForm] = useState({ ...INITIAL_BEAN });
        const [tastingForm, setTastingForm] = useState({ ...INITIAL_TASTING });
        const [tempOcrImage, setTempOcrImage] = useState(null);
        const [cropImage, setCropImage] = useState(null);
        const [cropTargetField, setCropTargetField] = useState(null);
        const [cropRatio, setCropRatio] = useState(NaN);
        const [showRandomPopup, setShowRandomPopup] = useState(false);
        const [randomBean, setRandomBean] = useState(null);
        
        // Scroll Management Refs
        const mainRef = useRef(null);
        const scrollMap = useRef({});

        // --- SCROLL MANAGEMENT LOGIC START ---
        const saveScrollPosition = (currentView, currentId) => {
             if (mainRef.current) {
                 const key = currentView === VIEW.DETAIL ? `DETAIL-${currentId}` : currentView;
                 scrollMap.current[key] = mainRef.current.scrollTop;
             }
        };

        useLayoutEffect(() => {
            if (active && mainRef.current) {
                 requestAnimationFrame(() => {
                     const key = view === VIEW.DETAIL ? `DETAIL-${selectedId}` : view;
                     mainRef.current.scrollTop = scrollMap.current[key] || 0;
                 });
            }
        }, [active, view, selectedId]);

        const updateView = (newView, id = null) => {
            saveScrollPosition(view, selectedId);
            window.history.pushState({ view: newView, id, tab: TAB.BEANS }, '');
            setView(newView);
            setSelectedId(id);
        };
        
        const replaceView = (newView, id = null) => {
            saveScrollPosition(view, selectedId);
            window.history.replaceState({ view: newView, id, tab: TAB.BEANS }, '');
            setView(newView);
            setSelectedId(id);
        };
        
        const goBack = () => window.history.back();
        // --- SCROLL MANAGEMENT LOGIC END ---

        const pickRandomBean = () => {
            const availableBeans = beans.filter(b => !b.isFinished && b.weight && parseFloat(b.weight) > 0);
            if (availableBeans.length === 0) { showToastMsg("Ï∂îÏ≤úÌï† ÏõêÎëêÍ∞Ä ÏóÜÏäµÎãàÎã§. (Ï°∞Í±¥: Î≥¥Ïú† Ï§ëÏù∏ ÏõêÎëê)"); return; }
            const random = availableBeans[Math.floor(Math.random() * availableBeans.length)];
            setRandomBean(random);
            // [Fix] Push history for modal
            window.history.pushState({ view, id: selectedId, tab: TAB.BEANS, modal: 'RANDOM' }, '');
            setShowRandomPopup(true);
        };

        // [Deep Link Handler]
        useEffect(() => {
            // [Fix 1] Check beans.length to prevent race condition when data isn't loaded yet
            if (active && navProps && beans.length > 0) {
                if (navProps.view === 'EDIT_TASTING' && navProps.beanId) {
                    const targetBean = beans.find(b => String(b.id) === String(navProps.beanId));
                    if (targetBean) {
                        // Use provided tasting object directly if available, or try to find it
                        // This fixes "cannot read property of undefined" when tasting form is not set
                        const targetTasting = navProps.tasting || (targetBean.tastings ? targetBean.tastings[0] : null);
                        
                        if (targetTasting) {
                             setSelectedId(navProps.beanId);
                             // Need to find index for delete/update operations
                             const tIdx = targetBean.tastings.findIndex(t => t === targetTasting || (t.date === targetTasting.date && JSON.stringify(t.scores) === JSON.stringify(targetTasting.scores)));
                             setEditTastingIdx(tIdx !== -1 ? tIdx : 0);
                             setTastingForm(targetTasting);
                             setView(VIEW.EDIT_TASTING);
                        } else {
                            // Fallback to detail if no tasting found
                            setSelectedId(navProps.beanId);
                            setView(VIEW.DETAIL);
                        }
                    }
                } else if (navProps.view === 'DETAIL' && navProps.beanId) {
                    setSelectedId(navProps.beanId);
                    setView(VIEW.DETAIL);
                }
                onNavConsumed();
            }
        }, [active, navProps, beans, onNavConsumed]);

        // [History Handler]
        useEffect(() => {
            if (!active) return;
            const handlePop = (event) => {
                if(shareData) { setShareData(null); return; }
                if(cropImage) { setCropImage(null); return; }
                if(showFlavorPicker) { setShowFlavorPicker(false); return; }
                if(showRandomPopup) { setShowRandomPopup(false); return; }
                
                if (event.state && event.state.tab === TAB.BEANS) {
                    if (event.state.view) {
                        setView(event.state.view);
                        if (event.state.id !== undefined) setSelectedId(event.state.id);
                    }
                } else if (!event.state) {
                    setView(VIEW.LIST);
                    setSelectedId(null);
                }
            };
            window.addEventListener('popstate', handlePop);
            return () => window.removeEventListener('popstate', handlePop);
        }, [active, shareData, cropImage, showFlavorPicker, showRandomPopup]);

        // [Fix for Ghost View]
        useEffect(() => {
            if (active && !navProps) {
                const currentState = window.history.state;
                if (currentState && currentState.view && currentState.tab === TAB.BEANS) {
                    setView(currentState.view);
                    setSelectedId(currentState.id || null);
                } else {
                    // Default to LIST only if no valid state
                   if (!selectedId) setView(VIEW.LIST);
                }
            }
        }, [active, navProps]);

        const openLink = (url) => {
            if (!url) return;
            let target = url;
            if (!/^https?:\/\//i.test(target)) {
                target = 'http://' + target;
            }
            window.open(target, '_blank');
        };

        useEffect(() => {
            try {
              let loadedData = safeStorage.get(`${STORAGE_KEY}_data`);
              if (Array.isArray(loadedData)) {
                setBeans(loadedData.map(b => ({ ...INITIAL_BEAN, ...b, tastings: Array.isArray(b.tastings) ? b.tastings : [] })));
              }
              const savedNoteMode = safeStorage.get(`${STORAGE_KEY}_note_mode`); if (savedNoteMode) setListNoteMode(savedNoteMode);
              const savedSortMode = safeStorage.get(`${STORAGE_KEY}_sort_mode`); if (savedSortMode) setSortMode(savedSortMode);
            } catch (e) { console.error(e); }
        }, [active]);

        const showToastMsg = (msg) => { setToast(msg); setTimeout(() => setToast(null), 3000); };
        const activeBean = useMemo(() => beans.find(b => String(b.id) === String(selectedId)) || null, [beans, selectedId]);
        const onSelectFile = (e, field) => { if (e.target.files && e.target.files.length > 0) { const reader = new FileReader(); reader.readAsDataURL(e.target.files[0]); reader.onload = () => { setCropImage(reader.result); setCropTargetField(field); setCropRatio(field === 'main' ? 1 : NaN); }; } e.target.value = null; };
        const onCropFinish = (croppedBase64) => { if (cropTargetField === 'main') setBeanForm(prev => ({ ...prev, mainImage: croppedBase64 })); else if (cropTargetField === 'ocr') setTempOcrImage(croppedBase64); setCropImage(null); };
        
        const runOCR = async () => {
            if (!tempOcrImage) return showToastMsg("Î∂ÑÏÑùÌï† ÏÇ¨ÏßÑÏùÑ Îì±Î°ùÌï¥Ï£ºÏÑ∏Ïöî.");
            if (!globalApiKey) return showToastMsg("ÏÑ§Ï†ï ÌÉ≠ÏóêÏÑú API ÌÇ§Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
            setIsProcessing(true);
            try {
                const base64Data = tempOcrImage.split(',')[1];
                const promptText = `Analyze the coffee bean image and return a valid JSON object. Rules: 1. Extract 'altitude' (look for 'm', 'masl'). 2. Separate 'notes' (short) and 'flavorDesc'. 3. Translate 'notes', 'flavorDesc', 'memo' to KOREAN. 4. Dates YYYY-MM-DD. 5. Return ONLY JSON. Keys: { "name": "", "country": "", "region": "", "altitude": "", "variety": "", "processing": "", "roastingLevel": "", "producer": "", "shop": "", "roastingDate": "", "purchaseUrl": "", "price": "", "weight": "", "notes": "", "flavorDesc": "", "memo": "" }`;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${globalApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: promptText },
                                { inlineData: { mimeType: "image/jpeg", data: base64Data } }
                            ]
                        }]
                    })
                });
                const res = await response.json();
                const text = res.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) {
                    const clean = text.replace(/```json|```/g, "").trim();
                    setBeanForm(p => ({ ...p, ...JSON.parse(clean) }));
                    showToastMsg("Ï†ïÎ≥¥ ÏûÖÎ†• ÏôÑÎ£å!");
                } else throw new Error();
            } catch (e) {
                showToastMsg("Î∂ÑÏÑù Ïã§Ìå®");
                console.error(e);
            } finally {
                setIsProcessing(false);
            }
        };
        
        const saveData = (updatedBeans, nextId, isNew) => { 
            if(safeStorage.set(`${STORAGE_KEY}_data`, updatedBeans)) { 
                setBeans(updatedBeans); setIsSaving(false); 
                setTimeout(() => { 
                    setTempOcrImage(null); 
                    if (isNew !== null) { 
                        if (isNew) { replaceView(VIEW.DETAIL, nextId); } else { goBack(); } 
                    } else {
                        // ÏàòÏ†ï Î™®ÎìúÏóêÏÑú Ï†ÄÏû• ÌõÑ Îí§Î°úÍ∞ÄÍ∏∞ (ÏÉÅÏÑ∏ ÎòêÎäî Ïù¥Ï†Ñ ÌôîÎ©¥ÏúºÎ°ú)
                        goBack();
                    }
                }, 300); 
            } else { setIsSaving(false); showToastMsg("Ïö©Îüâ Î∂ÄÏ°±!"); } 
        };
        
        const handleSaveBean = () => { 
            if (!beanForm.name.trim()) return showToastMsg("Ïù¥Î¶Ñ ÏûÖÎ†• ÌïÑÏöî"); 
            setIsSaving(true); 
            setTimeout(() => { 
                const isNew = !beanForm.id; 
                const id = isNew ? Date.now() : beanForm.id; 
                const newBean = { ...beanForm, id, tastings: beanForm.tastings || [], ocrImage: null }; 
                let newBeans = !isNew ? beans.map(b => String(b.id) === String(id) ? newBean : b) : [newBean, ...beans]; 
                saveData(newBeans, id, isNew); 
            }, 300); 
        };

        const handleSaveTasting = () => { if (!selectedId) return; setIsSaving(true); setTimeout(() => { const newBeans = beans.map(b => { if (String(b.id) === String(selectedId)) { const tList = [...b.tastings]; if (editTastingIdx !== null) tList[editTastingIdx] = tastingForm; else tList.unshift({ ...tastingForm, id: Date.now() }); return { ...b, tastings: tList }; } return b; }); saveData(newBeans, selectedId, false); }, 300); };
        const handleDelete = () => { if (confirm("ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) { const newBeans = beans.filter(b => String(b.id) !== String(selectedId)); if (safeStorage.set(`${STORAGE_KEY}_data`, newBeans)) { setBeans(newBeans); updateView(VIEW.LIST); } } };
        const handleDeleteTasting = () => { if (confirm("ÏÇ≠Ï†ú?")) { const newBeans = beans.map(b => { if (String(b.id) === String(selectedId)) { return { ...b, tastings: b.tastings.filter((_, i) => i !== editTastingIdx) }; } return b; }); saveData(newBeans, selectedId, false); } };
        const updateScore = (id, delta) => { setTastingForm(prev => { let nextVal = prev.scores[id] + delta; if (nextVal < 0) nextVal = 0; if (nextVal > 10) nextVal = 10; nextVal = Math.round(nextVal * 10) / 10; return { ...prev, scores: { ...prev.scores, [id]: nextVal } }; }); };
        const handleShopChange = (e) => { const val = e.target.value; setBeanForm(prev => ({ ...prev, shop: val })); if (!beanForm.purchaseUrl) { const match = beans.find(b => b.shop && b.shop.toLowerCase() === val.toLowerCase() && b.purchaseUrl); if (match) { setBeanForm(prev => ({ ...prev, purchaseUrl: match.purchaseUrl })); showToastMsg(`URL ÏûêÎèô ÏûÖÎ†•: ${match.shop}`); } } };
        const sortedBeans = useMemo(() => { let result = beans; if (filterMode === 'BEAN') result = result.filter(b => b.weight); else if (filterMode === 'CUP') result = result.filter(b => b.pricePerCup); if (searchTerm.trim()) { const terms = searchTerm.toLowerCase().split(/\s+/).filter(t => t.length > 0); result = result.filter(bean => { const text = [bean.name, bean.country, bean.region, bean.variety, bean.processing, bean.roastingLevel, bean.shop, bean.notes, bean.flavorDesc, bean.memo, ...(bean.tastings ? bean.tastings.map(t => `${t.notes} ${t.memo}`) : [])].join(" ").toLowerCase(); return terms.every(t => text.includes(t)); }); } return [...result].sort((a, b) => { switch (sortMode) { case SORT_MODE.PURCHASE_DESC: if (!a.purchaseDate) return 1; if (!b.purchaseDate) return -1; return b.purchaseDate.localeCompare(a.purchaseDate); case SORT_MODE.ROAST_DESC: if (!a.roastingDate) return 1; if (!b.roastingDate) return -1; return b.roastingDate.localeCompare(a.roastingDate); case SORT_MODE.SCORE_DESC: const scoreA = getMaxScoreVal(a.tastings); const scoreB = getMaxScoreVal(b.tastings); if (scoreA !== scoreB) return scoreB - scoreA; return b.id - a.id; case SORT_MODE.STATUS_ASC: const getRank = (item) => { const isBean = !!item.weight; if (isBean) return item.isFinished ? 1 : 0; return 2; }; const rankA = getRank(a); const rankB = getRank(b); if (rankA !== rankB) return rankA - rankB; return b.id - a.id; case SORT_MODE.CREATED_DESC: default: return b.id - a.id; } }); }, [beans, searchTerm, filterMode, sortMode]);

        if(!active) return null;

        return (
            <div className={`h-full flex flex-col bg-slate-50 relative ${active ? 'block' : 'hidden'}`}>
                {/* ... BeansTab Content ... */}
                {cropImage && <ImageCropper imageSrc={cropImage} aspectRatio={cropRatio} onComplete={onCropFinish} onCancel={() => setCropImage(null)} />}
                {shareData && <ShareModal bean={shareData.bean} tasting={shareData.tasting} onClose={() => setShareData(null)} />}
                {showFlavorPicker && (<FlavorPicker onClose={() => setShowFlavorPicker(false)} onConfirm={(text) => { if (pickerTarget === 'bean') { setBeanForm(prev => ({ ...prev, notes: text })); } else if (pickerTarget === 'tasting') { setTastingForm(prev => ({ ...prev, notes: text })); } setShowFlavorPicker(false); }} initialNotes={pickerTarget === 'bean' ? beanForm.notes : tastingForm.notes} />)}
                
                {showRandomPopup && randomBean && (
                    <div className="fixed inset-0 z-50 flex items-center justify-center p-6 bg-black/40 backdrop-blur-sm animate-[fadeIn_0.2s_ease-out]" onClick={() => window.history.back()}>
                        <div className="w-full max-w-xs bg-white rounded-3xl shadow-2xl relative overflow-hidden animate-[scaleIn_0.2s_ease-out]" style={{ animation: 'pop 0.3s cubic-bezier(0.16, 1, 0.3, 1)' }} onClick={e => e.stopPropagation()}>
                            <div className="bg-amber-50 p-4 flex justify-between items-center border-b border-amber-100">
                                <div className="flex items-center gap-1.5 text-amber-600"><Sparkles size={16} fill="currentColor" /><span className="text-xs font-bold uppercase tracking-wider">Today's Pick</span></div>
                                <button onClick={() => window.history.back()} className="bg-white text-slate-400 p-1.5 rounded-full hover:bg-slate-100 transition-colors"><X size={16}/></button>
                            </div>
                            <div className="p-6 pt-5 text-center flex flex-col items-center gap-1">
                                <h2 className="text-xl font-black text-slate-900 leading-tight mb-1 break-keep word-keep">{randomBean.name}</h2>
                                <div className="flex flex-wrap justify-center gap-1.5 mb-4">{randomBean.country && <span className="px-2 py-0.5 bg-slate-100 text-slate-500 rounded text-[10px] font-bold border border-slate-200">{randomBean.country}</span>}{randomBean.roastingLevel && <span className="px-2 py-0.5 bg-amber-50 text-amber-700 rounded text-[10px] font-bold border border-amber-100">{randomBean.roastingLevel}</span>}</div>
                                {randomBean.notes && (<p className="text-xs text-slate-400 mb-6 line-clamp-1">"{randomBean.notes}"</p>)}
                                <button onClick={() => { setShowRandomPopup(false); replaceView(VIEW.DETAIL, randomBean.id); }} className="px-6 py-2.5 bg-slate-900 hover:bg-slate-800 text-white rounded-xl text-xs font-bold transition-all active:scale-95 shadow-lg shadow-slate-200">ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î≥¥Í∏∞</button>
                            </div>
                        </div>
                    </div>
                )}

                {toast && <div className="fixed top-10 left-1/2 -translate-x-1/2 bg-slate-900/90 text-white px-6 py-3 rounded-full text-xs font-bold shadow-xl z-[70] whitespace-nowrap">{toast}</div>}

                {view === VIEW.LIST && (
                    <>
                        <header className="p-5 pb-3 pt-4 bg-white border-b sticky top-0 z-10 bg-white/90 backdrop-blur space-y-3">
                            <div className="flex justify-between items-center">
                                <div><h1 className="text-2xl font-black font-brand flex items-center gap-1">BeanLog <CustomBeanIcon size={24} className="text-[#4b2c20]"/></h1><p className="text-[10px] text-slate-400 font-bold uppercase tracking-widest font-brand">Coffee bean archive</p></div>
                                <div className="flex gap-2">
                                    <button onClick={pickRandomBean} className="w-10 h-10 bg-amber-50 text-amber-600 rounded-full flex items-center justify-center border border-amber-100 active:scale-95 transition-transform"><Sparkles size={18}/></button>
                                    <button onClick={() => { setBeanForm({ ...INITIAL_BEAN }); setTempOcrImage(null); updateView(VIEW.EDIT_BEAN); }} className="w-10 h-10 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center hover:bg-slate-200 active:scale-95 transition-all"><Plus size={20}/></button>
                                </div>
                            </div>
                            <div className="relative"><Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} /><input className="w-full bg-slate-100 p-3 pl-10 rounded-2xl text-sm font-bold outline-none" placeholder="Í≤ÄÏÉâ..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />{searchTerm && <button onClick={() => setSearchTerm("")} className="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400"><X size={16} fill="currentColor" className="text-slate-300"/></button>}</div>
                            <div className="flex gap-2"><div className="flex-1 flex bg-slate-100 p-1 rounded-xl">{["ALL", "BEAN", "CUP"].map(mode => (<button key={mode} onClick={() => setFilterMode(mode)} className={`flex-1 py-1.5 text-xs font-bold rounded-lg transition-all ${filterMode === mode ? 'bg-white text-slate-900 shadow-sm' : 'text-slate-400'}`}>{mode === 'ALL' ? 'Ï†ÑÏ≤¥' : (mode === 'BEAN' ? 'ÏõêÎëê' : 'ÌïúÏûî')}</button>))}</div><button onClick={() => { const newMode = listNoteMode === NOTE_MODE.BEAN ? NOTE_MODE.TASTING : NOTE_MODE.BEAN; setListNoteMode(newMode); safeStorage.set(`${STORAGE_KEY}_note_mode`, newMode); showToastMsg(newMode === NOTE_MODE.BEAN ? "ÏõêÎëê ÎÖ∏Ìä∏ Î≥¥Í∏∞" : "ÏãúÏùå ÎÖ∏Ìä∏ Î≥¥Í∏∞"); }} className="px-3 rounded-xl bg-slate-100 text-slate-500 flex items-center justify-center transition-colors hover:bg-slate-200">{listNoteMode === NOTE_MODE.BEAN ? <CustomBeanIcon size={18}/> : <Coffee size={18}/>}</button><div className="relative"><button onClick={() => setShowSortMenu(!showSortMenu)} className={`h-full px-3 rounded-xl flex items-center justify-center transition-colors ${showSortMenu ? 'bg-slate-900 text-white' : 'bg-slate-100 text-slate-500'}`}><ArrowUpDown size={16} /></button>{showSortMenu && (<><div className="fixed inset-0 z-20" onClick={() => setShowSortMenu(false)}></div><div className="absolute right-0 top-full mt-2 w-48 bg-white rounded-2xl shadow-2xl border p-2 z-30 flex flex-col gap-1 animate-in slide-in-from-top-2"><div className="px-3 py-2 text-[10px] font-bold text-slate-400 uppercase tracking-widest border-b mb-1">Sort By</div>{[SORT_MODE.CREATED_DESC, SORT_MODE.PURCHASE_DESC, SORT_MODE.ROAST_DESC, SORT_MODE.SCORE_DESC, SORT_MODE.STATUS_ASC].map(mode => (<button key={mode} onClick={() => { setSortMode(mode); safeStorage.set(`${STORAGE_KEY}_sort_mode`, mode); setShowSortMenu(false); }} className={`text-left px-3 py-2 rounded-lg text-xs font-bold flex items-center justify-between ${sortMode === mode ? 'bg-slate-100 text-slate-900' : 'text-slate-500 hover:bg-slate-50'}`}><span>{SORT_LABELS[mode]}</span> {sortMode === mode && <Check size={14}/>}</button>))}</div></>)}</div></div>
                            {sortMode !== SORT_MODE.CREATED_DESC && <div className="flex justify-end"><span className="text-[10px] font-bold text-slate-400 bg-slate-50 px-2 py-1 rounded flex items-center gap-1">{SORT_LABELS[sortMode]} Ï†ïÎ†¨ Ï§ë <ArrowUpDown size={10}/></span></div>}
                        </header>
                        <main className="flex-1 p-4 space-y-4 overflow-y-auto pb-24" ref={mainRef}>
                            {sortedBeans.length === 0 ? <div className="py-20 text-center opacity-40 font-bold">{searchTerm ? "Í≤ÄÏÉâ Í≤∞Í≥º ÏóÜÏùå" : "Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§"}</div> : sortedBeans.map(bean => (
                                <div key={bean.id} onClick={() => { updateView(VIEW.DETAIL, bean.id); }} className="bg-white p-4 rounded-3xl shadow-sm border flex items-start gap-4 active:scale-95 transition-transform">
                                    <div className="flex flex-col items-center gap-1.5 shrink-0">
                                        <div className={`w-16 h-16 rounded-xl bg-slate-100 overflow-hidden relative flex items-center justify-center ${bean.isFinished ? 'text-slate-300' : 'text-amber-800'}`}>{bean.mainImage ? <img src={bean.mainImage} className="w-full h-full object-cover"/> : <CustomBeanIcon size={32}/>}</div>
                                        <div className="flex items-center gap-1">{bean.tastings.length > 0 && (<span className="bg-amber-50 text-amber-700 px-1.5 py-0.5 rounded-md text-[10px] font-bold flex items-center gap-0.5 border border-amber-100"><Star size={8} fill="currentColor"/> {getMaxScore(bean.tastings)}</span>)}{bean.isFinished ? <CustomBeanIcon size={14} className="text-slate-300"/> : (bean.weight ? <CustomBeanIcon size={14} className="text-amber-700"/> : <Coffee size={14} className="text-slate-700"/>)}</div>
                                    </div>
                                    <div className="flex-1 min-w-0 space-y-1">
                                        <h3 className="font-black text-lg break-words leading-tight text-slate-900">{bean.name}</h3>
                                        <div className="text-xs text-slate-500 font-medium whitespace-normal leading-relaxed break-words"><span className="font-bold text-slate-700">{bean.shop || "-"}</span><span className="mx-1">¬∑</span>{bean.roastingLevel || "-"}<span className="mx-1">¬∑</span>{bean.purchaseDate || "-"}</div>
                                        <div className="text-slate-400 text-xs mt-1 leading-tight line-clamp-2">{parseTags(listNoteMode === NOTE_MODE.TASTING ? (getBestTastingNote(bean.tastings) || bean.notes) : bean.notes).join(', ')}</div>
                                    </div>
                                </div>
                            ))}
                        </main>
                    </>
                )}

                {view === VIEW.DETAIL && activeBean && (
                    <div className="flex flex-col h-full bg-white">
                        <header className="p-4 pt-4 border-b flex justify-between items-center sticky top-0 z-10 bg-white"><button onClick={goBack} className="p-2"><ChevronLeft/></button><span className="font-bold text-xs uppercase tracking-widest text-slate-400">Detail</span><button onClick={() => { setBeanForm({ ...activeBean }); setTempOcrImage(null); updateView(VIEW.EDIT_BEAN, activeBean.id); }} className="text-sm font-bold underline px-2">ÏàòÏ†ï</button></header>
                        <main className="flex-1 overflow-y-auto pb-24" ref={mainRef}>
                            <div className="p-6 pb-0">
                                <div className="flex items-center gap-2 mb-4"><h1 className="text-3xl font-black leading-tight break-words">{activeBean.name}</h1>{activeBean.isFinished && <span className="bg-slate-200 text-slate-500 text-[10px] font-bold px-2 py-0.5 rounded h-fit whitespace-nowrap">SOLD OUT</span>}</div>
                                <div className="flex gap-4 items-start">
                                    <div className="w-1/2 aspect-square bg-slate-100 relative rounded-2xl overflow-hidden shadow-sm shrink-0">{activeBean.mainImage ? <img src={activeBean.mainImage} className="w-full h-full object-cover"/> : <div className={`absolute inset-0 flex items-center justify-center ${activeBean.isFinished ? 'text-slate-300' : 'text-amber-800'}`}><CustomBeanIcon size={96}/></div>}</div>
                                    <div className="w-1/2 flex flex-wrap content-start gap-1.5">{activeBean.country && <span className="bg-slate-900 text-white px-2 py-1 rounded text-[10px] font-bold">{activeBean.country}</span>}{activeBean.region && <span className="bg-slate-100 text-slate-700 px-2 py-1 rounded text-[10px] font-bold border border-slate-200">{activeBean.region}</span>}{activeBean.variety && <span className="bg-slate-100 text-slate-600 px-2 py-1 rounded text-[10px] font-bold border border-slate-200">{activeBean.variety}</span>}{activeBean.processing && <span className="bg-slate-100 text-slate-600 px-2 py-1 rounded text-[10px] font-bold border border-slate-200">{activeBean.processing}</span>}{activeBean.producer && <span className="bg-slate-100 text-slate-600 px-2 py-1 rounded text-[10px] font-bold border border-slate-200">{activeBean.producer}</span>}{activeBean.altitude && <span className="bg-slate-100 text-slate-600 px-2 py-1 rounded text-[10px] font-bold border border-slate-200">{activeBean.altitude}</span>}{activeBean.roastingLevel && <span className="bg-amber-100 text-amber-900 px-2 py-1 rounded text-[10px] font-bold border border-amber-200">{activeBean.roastingLevel}</span>}{activeBean.roastingDate && <span className="bg-slate-50 text-slate-500 px-2 py-1 rounded text-[10px] font-bold border border-slate-200 flex items-center gap-1"><Flame size={8} className="text-orange-500"/> {activeBean.roastingDate}</span>}</div>
                                </div>
                            </div>
                            <div className="p-6 space-y-6">
                                {(activeBean.notes || activeBean.flavorDesc) && (<div className="bg-amber-50 p-5 rounded-2xl border border-amber-100 relative"><Quote size={20} className="absolute top-4 right-4 text-amber-200 opacity-50" /><span className="text-[10px] font-bold text-amber-500 uppercase block mb-3">Flavor Notes</span><div className="flex flex-wrap gap-2 mb-3">{parseTags(activeBean.notes).map((note, idx) => (<span key={idx} className="bg-white text-amber-800 px-3 py-1.5 rounded-full text-xs font-bold border border-amber-100 shadow-sm">{note}</span>))}</div>{activeBean.flavorDesc && <p className="text-amber-900 text-sm font-medium italic leading-relaxed border-t border-amber-200 pt-3 mt-2">{activeBean.flavorDesc}</p>}</div>)}
                                <div className="bg-white border border-slate-100 p-5 rounded-3xl shadow-sm space-y-3"><div className="flex justify-between items-center"><h3 className="text-xs font-bold text-slate-400 uppercase tracking-widest flex items-center gap-1"><ShoppingBag size={12}/> Purchase Info</h3>{activeBean.purchaseUrl && (<button onClick={() => openLink(activeBean.purchaseUrl)} className="text-[10px] font-bold text-blue-500 bg-blue-50 px-2 py-1 rounded-lg flex items-center gap-1">Íµ¨Îß§Ï≤ò Î∞©Î¨∏ <ExternalLink size={10}/></button>)}</div><div className="flex justify-between items-center text-sm font-medium"><span>Íµ¨Îß§Ï≤ò</span> <span className="font-bold">{activeBean.shop || '-'}</span></div><div className="flex justify-between items-center text-sm font-medium"><span>Íµ¨Îß§Ïùº</span> <span className="font-bold">{activeBean.purchaseDate || '-'}</span></div>{activeBean.weight && activeBean.price && (<div className="flex justify-between items-center text-sm font-medium"><span>Í∞ÄÍ≤© ({activeBean.weight}g)</span> <div className="text-right"><span className="font-bold block">{Number(activeBean.price).toLocaleString()}Ïõê</span><span className="text-[10px] text-slate-400">100gÎãπ {calcPricePer100g(activeBean.price, activeBean.weight)}Ïõê</span></div></div>)}{activeBean.pricePerCup && (<div className="flex justify-between items-center text-sm font-medium pt-2 border-t border-dashed"><span>Ìïú Ïûî Í∞ÄÍ≤©</span> <span className="font-bold text-amber-700">{Number(activeBean.pricePerCup).toLocaleString()}Ïõê</span></div>)}</div>
                                {activeBean.memo && <div className="bg-slate-50 p-5 rounded-2xl border text-slate-600 text-sm whitespace-pre-wrap">{activeBean.memo}</div>}
                                <div className="pt-6 border-t"><div className="flex justify-between items-center mb-4"><h2 className="font-black text-xl">ÏãúÏùå Í∏∞Î°ù</h2><div className="flex gap-2"><button onClick={() => { const updatedBeans = beans.map(b => String(b.id) === String(activeBean.id) ? { ...b, isFinished: !b.isFinished } : b); if(safeStorage.set(`${STORAGE_KEY}_data`, updatedBeans)) { setBeans(updatedBeans); } }} className={`px-3 py-1.5 rounded-full text-xs font-bold border transition-colors ${activeBean.isFinished ? 'bg-slate-200 text-slate-500 border-transparent' : 'bg-white text-slate-700 border-slate-200'}`}>{activeBean.isFinished ? "ÏõêÎëê ÏÜåÏßÑÎê®" : "ÏõêÎëê Î≥¥Ïú† Ï§ë"}</button><button onClick={() => { setTastingForm({...INITIAL_TASTING}); setEditTastingIdx(null); updateView(VIEW.EDIT_TASTING, activeBean.id); }} className="bg-slate-900 text-white px-3 py-1.5 rounded-full text-xs font-bold">+ Ï∂îÍ∞Ä</button></div></div>{activeBean.tastings.length === 0 ? <p className="text-center text-slate-400 text-xs py-4">Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§.</p> : (<div className="space-y-3">{activeBean.tastings.map((t, idx) => (<div key={idx} className="bg-slate-50 p-4 rounded-2xl border flex items-center gap-4 active:scale-95 cursor-pointer" onClick={() => { setTastingForm(t); setEditTastingIdx(idx); updateView(VIEW.EDIT_TASTING, activeBean.id); }}><div className="w-12 h-12 bg-white rounded-xl flex items-center justify-center font-black border text-sm">{getDisplayScore(t)}</div><div className="flex-1 min-w-0"><p className="font-bold text-sm mb-1">{t.date}</p><div className="flex flex-wrap gap-1">{t.notes ? parseTags(t.notes).map((n, i) => <span key={i} className="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded border">{n}</span>) : <span className="text-xs text-slate-300">ÎÖ∏Ìä∏ ÏóÜÏùå</span>}</div></div><button onClick={(e) => { e.stopPropagation(); setShareData({ bean: activeBean, tasting: t }); }} className="p-2 text-slate-300 hover:text-slate-500 hover:bg-slate-200 rounded-full transition-colors"><Share2 size={16}/></button></div>))}</div>)}</div>
                            </div>
                        </main>
                    </div>
                )}

                {view === VIEW.EDIT_BEAN && (
                    <div className="flex flex-col h-full bg-white">
                        <header className="p-4 pt-4 border-b flex justify-between items-center sticky top-0 z-10 bg-white"><button onClick={() => { goBack(); }} className="p-2"><ChevronLeft/></button><h1 className="font-black">ÏõêÎëê ÏûÖÎ†•</h1><button onClick={handleSaveBean} disabled={isSaving} className="bg-slate-900 text-white px-4 py-2 rounded-full text-xs font-bold disabled:bg-slate-300">{isSaving ? 'Ï†ÄÏû•...' : 'ÏôÑÎ£å'}</button></header>
                        <main className="flex-1 overflow-y-auto p-6 space-y-6 pb-64">
                            <div className="flex gap-4"><label className="flex-1 aspect-square bg-slate-100 rounded-2xl flex flex-col items-center justify-center border-2 border-dashed relative overflow-hidden active:scale-95 transition-transform">{beanForm.mainImage ? <img src={beanForm.mainImage} className="w-full h-full object-cover"/> : <><Camera size={24} className="text-slate-400"/><span className="text-[10px] font-bold text-slate-400 mt-1">ÎåÄÌëúÏÇ¨ÏßÑ</span></>}<input type="file" className="hidden" accept="image/*" onChange={(e) => onSelectFile(e, 'main')} /></label><label className="flex-1 aspect-square bg-blue-50 rounded-2xl flex flex-col items-center justify-center border-2 border-dashed border-blue-200 relative overflow-hidden active:scale-95 transition-transform">{tempOcrImage ? <><img src={tempOcrImage} className="w-full h-full object-cover opacity-50"/><CheckCircle2 className="absolute text-blue-600" size={24}/></> : <><FileText size={24} className="text-blue-400"/><span className="text-[10px] font-bold text-blue-400 mt-1">OCR Î∂ÑÏÑùÏö©</span></>}<input type="file" className="hidden" accept="image/*" onChange={(e) => onSelectFile(e, 'ocr')} /></label></div><button onClick={runOCR} disabled={isProcessing} className="w-full py-3 bg-blue-100 text-blue-900 font-bold rounded-2xl flex items-center justify-center gap-2">{isProcessing ? <RefreshCw className="animate-spin" size={16}/> : <Zap size={16}/>} {isProcessing ? "Î∂ÑÏÑù Ï§ë..." : "AI Ï†ïÎ≥¥ ÏûêÎèô ÏûÖÎ†•"}</button>
                            <div className="space-y-4"><input className="w-full text-2xl font-black border-b py-2 outline-none" placeholder="ÏõêÎëê Ïù¥Î¶Ñ (ÌïÑÏàò)" value={beanForm.name} onChange={e => setBeanForm({...beanForm, name: e.target.value})}/><div className="flex items-center gap-3 p-4 bg-slate-50 rounded-xl"><input type="checkbox" checked={beanForm.isFinished} onChange={e => setBeanForm({...beanForm, isFinished: e.target.checked})} className="w-5 h-5 accent-slate-900"/><label className="text-sm font-bold text-slate-700">ÏõêÎëê Îã§ Î®πÏùå (Sold Out)</label></div><div className="grid grid-cols-2 gap-3"><input className="bg-slate-50 p-3 rounded-xl text-sm font-bold outline-none" placeholder="ÎÇòÎùº (Country)" value={beanForm.country} onChange={e => setBeanForm({...beanForm, country: e.target.value})}/><input className="bg-slate-50 p-3 rounded-xl text-sm font-bold outline-none" placeholder="ÏßÄÏó≠ (Region)" value={beanForm.region} onChange={e => setBeanForm({...beanForm, region: e.target.value})}/><input className="bg-slate-50 p-3 rounded-xl text-sm font-bold outline-none" placeholder="ÌíàÏ¢Ö" value={beanForm.variety} onChange={e => setBeanForm({...beanForm, variety: e.target.value})}/><input className="bg-slate-50 p-3 rounded-xl text-sm font-bold outline-none" placeholder="Í∞ÄÍ≥µ Î∞©Ïãù" value={beanForm.processing} onChange={e => setBeanForm({...beanForm, processing: e.target.value})}/><input className="bg-slate-50 p-3 rounded-xl text-sm font-bold outline-none" placeholder="Í≥†ÎèÑ (m)" value={beanForm.altitude} onChange={e => setBeanForm({...beanForm, altitude: e.target.value})}/><input className="bg-slate-50 p-3 rounded-xl text-sm font-bold outline-none" placeholder="Î°úÏä§ÌåÖ Ìè¨Ïù∏Ìä∏" value={beanForm.roastingLevel} onChange={e => setBeanForm({...beanForm, roastingLevel: e.target.value})}/></div><input className="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold outline-none" placeholder="ÏÉùÏÇ∞Ïûê/ÎÜçÏû•" value={beanForm.producer} onChange={e => setBeanForm({...beanForm, producer: e.target.value})}/><div className="bg-slate-50 p-3 rounded-xl flex flex-col justify-center"><label className="text-[10px] font-bold text-slate-400 uppercase mb-1">Î°úÏä§ÌåÖ ÎÇ†Ïßú</label><input type="date" className="bg-transparent font-bold outline-none w-full" value={beanForm.roastingDate} onChange={e => setBeanForm({...beanForm, roastingDate: e.target.value})}/></div><div className="space-y-3 pt-2"><h3 className="text-xs font-bold text-slate-400 uppercase">Íµ¨Îß§ Ï†ïÎ≥¥</h3><div className="bg-slate-50 p-3 rounded-xl flex flex-col justify-center"><label className="text-[10px] font-bold text-slate-400 uppercase mb-1">Íµ¨Îß§Ïùº (Purchase Date)</label><input type="date" className="bg-transparent font-bold outline-none w-full" value={beanForm.purchaseDate} onChange={e => setBeanForm({...beanForm, purchaseDate: e.target.value})}/></div><div className="space-y-1"><label className="text-xs font-bold text-slate-500 ml-1">Íµ¨Îß§Ï≤ò (Shop)</label><div className="relative"><ShoppingBag className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18}/><input list="shop-suggestions" className="w-full bg-slate-100 p-3 pl-10 rounded-xl text-sm font-bold outline-none" placeholder="Ïòà: Momos Coffee" value={beanForm.shop} onChange={handleShopChange}/><datalist id="shop-suggestions">{[...new Set(beans.map(b => b.shop).filter(Boolean))].map((shop, i) => (<option key={i} value={shop} />))}</datalist></div></div><input className="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold outline-none" placeholder="Íµ¨Îß§ URL (http://...)" value={beanForm.purchaseUrl} onChange={e => setBeanForm({...beanForm, purchaseUrl: e.target.value})}/><div className="grid grid-cols-2 gap-3"><div className="col-span-2"></div><input className="bg-slate-50 p-3 rounded-xl text-sm font-bold outline-none" placeholder="Ïö©Îüâ (g)" value={beanForm.weight} onChange={e => setBeanForm({...beanForm, weight: e.target.value})}/><input className="bg-slate-50 p-3 rounded-xl text-sm font-bold outline-none" placeholder="Í∞ÄÍ≤© (Ïõê)" value={beanForm.price} onChange={e => setBeanForm({...beanForm, price: e.target.value})}/></div><input className="w-full bg-slate-50 p-3 rounded-xl text-sm font-bold outline-none" placeholder="Ìïú Ïûî Í∞ÄÍ≤© (Ïπ¥Ìéò)" value={beanForm.pricePerCup} onChange={e => setBeanForm({...beanForm, pricePerCup: e.target.value})}/></div><div className="space-y-2"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Flavor Keywords</label><div className="relative"><input className="w-full bg-amber-50 p-4 pr-12 rounded-xl text-sm font-bold text-amber-900 outline-none placeholder-amber-900/30" placeholder="Î≤†Î¶¨, Ï¥àÏΩúÎ¶ø (ÏΩ§Îßà Íµ¨Î∂Ñ)" value={beanForm.notes} onChange={e => setBeanForm({...beanForm, notes: e.target.value})}/><button onClick={() => { setPickerTarget('bean'); setShowFlavorPicker(true); }} className="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-white rounded-lg shadow-sm text-amber-600 border border-amber-100"><Palette size={16}/></button></div></div><textarea className="w-full bg-amber-50 p-4 rounded-2xl h-24 text-sm font-medium text-amber-900 outline-none resize-none" placeholder="Ìñ•ÎØ∏Ïóê ÎåÄÌïú ÏûêÏÑ∏Ìïú ÏÑ§Î™Ö (Ï§ÑÍ∏Ä)" value={beanForm.flavorDesc} onChange={e => setBeanForm({...beanForm, flavorDesc: e.target.value})}/><textarea className="w-full bg-slate-50 p-4 rounded-2xl h-24 text-sm outline-none resize-none" placeholder="Î©îÎ™®" value={beanForm.memo} onChange={e => setBeanForm({...beanForm, memo: e.target.value})}/></div>
                            {selectedId && <button onClick={handleDelete} className="w-full py-4 text-red-500 font-bold bg-red-50 rounded-2xl flex items-center justify-center gap-2"><Trash2 size={18}/> ÏÇ≠Ï†ú</button>}
                        </main>
                    </div>
                )}

                {view === VIEW.EDIT_TASTING && (
                    <div className="flex flex-col h-full bg-white">
                        <header className="p-4 border-b flex justify-between items-center sticky top-0 z-10 bg-white"><button onClick={() => { goBack(); }} className="p-2"><ChevronLeft/></button><h1 className="font-black">ÌèâÍ∞Ä ÏûëÏÑ±</h1><button onClick={handleSaveTasting} disabled={isSaving} className="bg-slate-900 text-white px-5 py-2 rounded-full text-xs font-bold disabled:bg-slate-300">{isSaving ? 'Ï†ÄÏû•...' : 'ÏôÑÎ£å'}</button></header>
                        <main className="flex-1 overflow-y-auto p-6 space-y-8 pb-64">
                            <input type="date" className="w-full bg-slate-50 p-3 rounded-2xl text-center font-bold outline-none" value={tastingForm.date} onChange={e => setTastingForm({...tastingForm, date: e.target.value})}/>
                            <div className="flex items-center justify-between"><div className="text-center flex-1 flex flex-col items-center"><div className="relative"><div className="inline-flex items-center justify-center w-24 h-24 bg-slate-900 text-white rounded-3xl text-4xl font-black shadow-xl mb-2">{tastingForm.isManualTotal ? (<input type="number" className="w-full bg-transparent text-center text-white outline-none" value={tastingForm.totalScore || ""} onChange={(e) => setTastingForm(prev => ({ ...prev, totalScore: e.target.value }))} placeholder="0.0"/>) : ( calcAvg(tastingForm.scores) )}</div><button onClick={() => setTastingForm(prev => { const nextMode = !prev.isManualTotal; return { ...prev, isManualTotal: nextMode, totalScore: nextMode ? calcAvg(prev.scores) : undefined }; })} className="absolute -right-2 -top-2 bg-white text-slate-900 p-1.5 rounded-full shadow-md border">{tastingForm.isManualTotal ? <Calculator size={12}/> : <PenTool size={12}/>}</button></div><p className="text-[10px] font-bold text-slate-400 uppercase">{tastingForm.isManualTotal ? "Manual Score" : "Total Score"}</p></div><div className="flex-1 flex justify-center"><RadarChart scores={tastingForm.scores} /></div></div>
                            <div className="grid grid-cols-2 gap-3">{TASTE_ITEMS.map(item => (<div key={item.id} className="bg-slate-50 p-3 rounded-2xl flex flex-col items-center justify-center gap-2"><span className="text-xs font-bold uppercase text-slate-500">{item.label}</span><div className="flex items-center gap-2"><ScoreButton onClick={() => updateScore(item.id, -0.1)} icon={<Minus size={14} className="text-slate-400"/>} /><input type="number" value={tastingForm.scores[item.id]} onChange={(e) => setTastingForm(prev => ({ ...prev, scores: { ...prev.scores, [item.id]: e.target.value } }))} className="w-12 text-center font-black text-xl bg-transparent outline-none p-0 m-0 border-0 focus:ring-0" /><ScoreButtonPlus onClick={() => updateScore(item.id, +0.1)} icon={<Plus size={14} className="text-white"/>} /></div></div>))}</div>
                            <div className="space-y-2"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Keywords</label><div className="relative"><input className="w-full bg-amber-50 p-4 pr-12 rounded-xl text-sm font-bold text-amber-900 outline-none placeholder-amber-900/30" placeholder="ÏÇ∞ÎØ∏, Îã®Îßõ (ÏΩ§Îßà Íµ¨Î∂Ñ)" value={tastingForm.notes} onChange={e => setTastingForm({...tastingForm, notes: e.target.value})}/><button onClick={() => { setPickerTarget('tasting'); setShowFlavorPicker(true); }} className="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-white rounded-lg shadow-sm text-amber-600 border border-amber-100"><Palette size={16}/></button></div></div>
                            <textarea className="w-full bg-amber-50 p-4 rounded-2xl h-24 text-sm font-medium text-amber-900 outline-none resize-none" placeholder="ÎßõÏóê ÎåÄÌïú ÏûêÏÑ∏Ìïú ÌèâÍ∞Ä" value={tastingForm.desc} onChange={e => setTastingForm({...tastingForm, desc: e.target.value})}/><textarea className="w-full bg-slate-50 p-4 rounded-2xl h-32 text-sm outline-none resize-none" placeholder="Î†àÏãúÌîº / Î©îÎ™®" value={tastingForm.memo} onChange={e => setTastingForm({...tastingForm, memo: e.target.value})}/>
                            {editTastingIdx !== null && (<button onClick={handleDeleteTasting} className="w-full py-4 text-red-500 font-bold bg-red-50 rounded-2xl flex items-center justify-center gap-2 mt-4"><Trash2 size={16}/> Ïù¥ Í∏∞Î°ù ÏÇ≠Ï†ú</button>)}
                        </main>
                    </div>
                )}
            </div>
        );
    };

    // --- TIMER TAB ---
    const TimerTab = ({ active, setIsTimerRunning }) => { 
        // v54 Constants & Default Recipes (Restored)
        const DEFAULT_RECIPES = [
            { id: 1, title: "Í∏∞Î≥∏ Ìë∏Ïñ¥ Ïò§Î≤Ñ 20g", bean: "20", water: "60 80 80 80", interval: "30 30 30", endTime: "3:00", memo: "Î¨º Ïò®ÎèÑÎäî 93ÎèÑÍ∞Ä Ï†ÅÎãπÌï©ÎãàÎã§.\nÎú∏ Îì§Ïù¥Í∏∞Îäî 30Ï¥à Ï†ïÎèÑ ÏßÑÌñâÌï¥Ï£ºÏÑ∏Ïöî." },
            { id: 2, title: "10g Ìë∏Ïñ¥Ïò§Î≤Ñ", bean: "10", water: "30 40 40 40", interval: "30 30 30", endTime: "2:10", memo: "" },
            { id: 3, title: "Ïä§ÏúÑÏπò 10g", bean: "10", water: "cl150 10g op", interval: "20 120", endTime: "3:20", memo: "Ïä§ÏúÑÏπòÎ•º Îã´Í≥† Î¨ºÏùÑ Ìïú Î≤àÏóê Î∂ìÏäµÎãàÎã§." },
            { id: 4, title: "Ïä§ÏúÑÏπò Î¶¨Î≤ÑÏä§ 15g", bean: "15", water: "cl30 15g 30 op 170", interval: "30 30 30 10", endTime: "3:00", memo: "Ïπ®Ï∂úÏãùÍ≥º Ìà¨Í≥ºÏãùÏùÑ ÌòºÌï©Ìïú Î∞©ÏãùÏûÖÎãàÎã§." },
            { id: 5, title: "Î∞îÎ¶¨Ïä§ÌÉÄ ÌÖåÌÅ¨Îãâ", bean: "20", water: "c40 s60 ct60 st 100", interval: "40 40 40 10", endTime: "3:30", memo: "Îã§ÏñëÌïú Ìë∏Ïñ¥ÎßÅ Í∏∞Î≤ï Ïó∞ÏäµÏö© Î†àÏãúÌîºÏûÖÎãàÎã§." }
        ];

        // Main Timer Logic
        const [mode, setMode] = useState('EDIT'); 
        const [recipe, setRecipe] = useState({...INITIAL_RECIPE});
        const [recipes, setRecipes] = useState(DEFAULT_RECIPES);
        const [showList, setShowList] = useState(false);
        const [showMemo, setShowMemo] = useState(false);
        const [timeline, setTimeline] = useState([]);
        const [time, setTime] = useState(0);
        const [run, setRun] = useState(false);
        const [stepIdx, setStepIdx] = useState(0);
        const scrollRef = useRef(null), itemRefs = useRef([]);
        
        // [New] Modal states for confirmation
        const [showSaveModal, setShowSaveModal] = useState(false);
        const [showDeleteModal, setShowDeleteModal] = useState(false);
        const [deleteTargetId, setDeleteTargetId] = useState(null);
        const [toast, setToast] = useState(null);

        const showToastMsg = (msg) => { setToast(msg); setTimeout(() => setToast(null), 3000); };

        useEffect(() => { 
            const r = safeStorage.get(RECIPE_STORAGE_KEY); 
            if(r && Array.isArray(r) && r.length > 0) setRecipes(r);
            else setRecipes(DEFAULT_RECIPES); 
        }, []);

        // Sync Timer State with App
        useEffect(() => {
            setIsTimerRunning(run);
        }, [run, setIsTimerRunning]);

        const openRecipeList = () => {
            window.history.pushState({ tab: TAB.TIMER, modal: 'LIST' }, '');
            setShowList(true);
        };
        useEffect(() => {
            if (active && !run) openRecipeList();
        }, [active]);

        const openMemo = () => {
             window.history.pushState({ tab: TAB.TIMER, modal: 'MEMO' }, '');
             setShowMemo(true);
        };
        const handleSettingClick = () => {
            setRun(false);
            setMode('EDIT');
            window.history.replaceState({ tab: TAB.TIMER, mode: 'EDIT' }, '');
        };

        useEffect(() => {
            const handlePop = (event) => {
                if(!active) return;
                
                const modal = event.state ? event.state.modal : null;
                setShowList(modal === 'LIST');
                setShowMemo(modal === 'MEMO');
                setShowSaveModal(modal === 'SAVE');
                setShowDeleteModal(modal === 'DELETE');

                if (mode === 'TIMER') { 
                     if (!event.state || event.state.mode !== 'TIMER') {
                         setMode('EDIT'); 
                         setRun(false); 
                     }
                }
            };
            window.addEventListener('popstate', handlePop);
            return () => window.removeEventListener('popstate', handlePop);
        }, [active, mode]);

        useEffect(() => {
            let wakeLock = null;
            const requestWakeLock = async () => { if ('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) { console.log('Wake Lock Error:', err); } } };
            const releaseWakeLock = async () => { if (wakeLock !== null) { await wakeLock.release(); wakeLock = null; } };
            if (active && mode === 'TIMER') { requestWakeLock(); } else { releaseWakeLock(); }
            return () => { releaseWakeLock(); };
        }, [active, mode]); 

        const goBackFromTimer = () => { window.history.back(); };

        useEffect(() => { let i; if(run) i = setInterval(() => setTime(p=>{ if(p>=timeline[timeline.length-1]?.startTime){setRun(false);return p;} return p+1; }), 1000); return ()=>clearInterval(i); }, [run, timeline]);
        
        const scrollToStep = (index) => {
            const list = scrollRef.current;
            if (!list) return;
            if (index === 0) { list.scrollTo({ top: 0, behavior: 'smooth' }); return; }
            const item = itemRefs.current[index];
            if (item) { 
                const containerHeight = list.clientHeight;
                const itemHeight = item.clientHeight;
                const targetTop = item.offsetTop - (containerHeight / 2) + (itemHeight / 2);
                list.scrollTo({ top: targetTop, behavior: 'smooth' }); 
            }
        };

        useLayoutEffect(() => { if (active && mode === 'TIMER') { scrollToStep(stepIdx); } }, [stepIdx, mode, active]);
        useEffect(() => { if(mode==='TIMER') { const idx = timeline.findLastIndex(s=>s.startTime<=time); if(idx!==-1) setStepIdx(idx); } }, [time, mode]);

        // [Fix] Save Modal Logic
        const handleSaveRequest = () => {
            if (!recipe.title?.trim() || !recipe.bean?.trim() || !recipe.water?.trim() || !recipe.interval?.trim() || !recipe.endTime?.trim()) {
                showToastMsg("ÎπàÏπ∏ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî");
                return;
            }
            window.history.pushState({ tab: TAB.TIMER, modal: 'SAVE' }, '');
            setShowSaveModal(true);
        };

        const confirmSave = (isOverwrite) => {
            let updatedRecipes;
            if (isOverwrite && recipe.id) {
                updatedRecipes = recipes.map(r => r.id === recipe.id ? recipe : r);
            } else {
                updatedRecipes = [...recipes, { ...recipe, id: Date.now() }];
            }
            setRecipes(updatedRecipes);
            safeStorage.set(RECIPE_STORAGE_KEY, updatedRecipes);
            // Close modal by going back
            window.history.back();
        };

        const loadR = (r) => { 
            setRecipe(r); 
            if (mode === 'TIMER') {
                setTimeline(parseRecipe(r));
                setTime(0);
                setRun(false);
                setStepIdx(0);
                if (scrollRef.current) scrollRef.current.scrollTo({ top: 0, behavior: 'smooth' });
            }
            // [Fix] Close list modal
            if (showList) window.history.back(); 
        };

        // [Fix] Delete Modal Logic
        const handleDelRequest = (id, e) => { 
            e.stopPropagation(); 
            setDeleteTargetId(id);
            window.history.pushState({ tab: TAB.TIMER, modal: 'DELETE' }, '');
            setShowDeleteModal(true);
        };
        
        const confirmDelete = () => {
            if (deleteTargetId) {
                const n = recipes.filter(r => r.id !== deleteTargetId);
                setRecipes(n);
                safeStorage.set(RECIPE_STORAGE_KEY, n);
            }
            window.history.back();
        };
        
        const startBrewing = () => { 
            if (!recipe.title?.trim() || !recipe.bean?.trim() || !recipe.water?.trim() || !recipe.interval?.trim() || !recipe.endTime?.trim()) {
                showToastMsg("ÎπàÏπ∏ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî");
                return;
            }
            const newTimeline = parseRecipe(recipe);
            setTimeline(newTimeline); 
            // Push history for Timer Mode
            window.history.pushState({ tab: TAB.TIMER, mode: 'TIMER' }, ''); 
            setMode('TIMER'); 
            setTime(0); 
            setRun(false); 
            setStepIdx(0); 
        };
        const handleReset = () => { setRun(false); setTime(0); setStepIdx(0); if (scrollRef.current) { scrollRef.current.scrollTo({ top: 0, behavior: 'smooth' }); } };
        const toggleRun = () => { if (!run && time === 0) { if (scrollRef.current) scrollRef.current.scrollTo({ top: 0, behavior: 'smooth' }); } setRun(!run); };
        
        const curStep = timeline[stepIdx] || {};
        const curRatio = useMemo(()=>calculateRatio(recipe.bean, recipe.water),[recipe.bean,recipe.water]);

        return (
            <div className={`h-full flex flex-col bg-slate-50 relative ${active ? 'block' : 'hidden'}`}>
                {toast && <div className="fixed top-10 left-1/2 -translate-x-1/2 bg-slate-900/90 text-white px-6 py-3 rounded-full text-xs font-bold shadow-xl z-[120] whitespace-nowrap animate-in fade-in slide-in-from-top-2">{toast}</div>}

                {/* [Fix] Save Modal */}
                {showSaveModal && (
                    <div className="absolute inset-0 z-[110] bg-black/50 flex items-center justify-center p-4 animate-in fade-in" onClick={() => window.history.back()}>
                        <div className="bg-white w-full max-w-xs rounded-2xl p-5 shadow-xl animate-pop" onClick={e => e.stopPropagation()}>
                            <h3 className="text-lg font-bold mb-3 text-slate-900">Î†àÏãúÌîº Ï†ÄÏû•</h3>
                            <div className="flex flex-col gap-2">
                                {recipe.id && (
                                    <button onClick={() => confirmSave(true)} className="w-full py-3 bg-blue-50 text-blue-600 rounded-xl font-bold hover:bg-blue-100">
                                        Í∏∞Ï°¥ Î†àÏãúÌîº ÎçÆÏñ¥Ïì∞Í∏∞
                                    </button>
                                )}
                                <button onClick={() => confirmSave(false)} className="w-full py-3 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800">
                                    ÏÉà Î†àÏãúÌîºÎ°ú Ï†ÄÏû•
                                </button>
                                <button onClick={() => window.history.back()} className="w-full py-3 text-slate-400 font-bold hover:text-slate-600">
                                    Ï∑®ÏÜå
                                </button>
                            </div>
                        </div>
                    </div>
                )}
                
                {/* [Fix] Delete Modal */}
                {showDeleteModal && (
                    <div className="absolute inset-0 z-[110] bg-black/50 flex items-center justify-center p-4 animate-in fade-in" onClick={() => window.history.back()}>
                        <div className="bg-white w-full max-w-xs rounded-2xl p-5 shadow-xl animate-pop" onClick={e => e.stopPropagation()}>
                            <div className="flex flex-col items-center gap-2 mb-4">
                                <div className="w-10 h-10 bg-red-50 text-red-500 rounded-full flex items-center justify-center">
                                    <Trash2 size={20} />
                                </div>
                                <h3 className="text-lg font-bold text-slate-900">Î†àÏãúÌîº ÏÇ≠Ï†ú</h3>
                                <p className="text-sm text-slate-500 text-center">Ïù¥ Î†àÏãúÌîºÎ•º Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?<br/>ÏÇ≠Ï†úÎêú Îç∞Ïù¥ÌÑ∞Îäî Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => window.history.back()} className="flex-1 py-3 bg-slate-100 text-slate-500 rounded-xl font-bold hover:bg-slate-200">
                                    Ï∑®ÏÜå
                                </button>
                                <button onClick={confirmDelete} className="flex-1 py-3 bg-red-500 text-white rounded-xl font-bold hover:bg-red-600">
                                    ÏÇ≠Ï†ú
                                </button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Modal: Recipe List */}
                {showList && (
                    <div className="absolute inset-0 z-[100] bg-black/50 flex items-end" onClick={()=>window.history.back()}>
                        <div className="w-full bg-white rounded-t-3xl h-[85%] p-5 flex flex-col animate-slide-up" onClick={e=>e.stopPropagation()}>
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="font-bold text-lg">Saved Recipes</h2>
                                <div className="flex items-center gap-3">
                                    <button onClick={() => { setRecipe({...INITIAL_RECIPE, id: Date.now()}); setRun(false); setMode('EDIT'); window.history.back(); }} className="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-full text-xs font-bold flex items-center gap-1"><Plus size={14}/> NEW</button>
                                    <X onClick={()=>window.history.back()} className="cursor-pointer text-slate-400"/>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto space-y-3 pb-10">
                                {recipes.map(r=>(
                                    <div key={r.id} onClick={()=>loadR(r)} className="bg-slate-50 p-4 rounded-xl border flex justify-between items-center active:scale-95 transition-transform cursor-pointer">
                                        <div className="flex items-center gap-3">
                                            <div><h3 className="font-bold">{r.title}</h3><span className="text-xs text-slate-500 flex items-center gap-1"><CustomBeanIcon size={10} className="text-amber-700"/> {r.bean}g <span className="text-slate-300">¬∑</span> <Calculator size={10} className="text-orange-400"/> {calculateRatio(r.bean, r.water)} <Droplet size={10} className="text-blue-400 ml-1"/> {r.water}</span></div>
                                        </div>
                                        <button onClick={(e)=>handleDelRequest(r.id,e)} className="p-2"><Trash2 size={16} className="text-slate-300 hover:text-red-500"/></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                )}
                
                <header className="p-4 pt-4 flex justify-between items-center bg-white border-b sticky top-0 z-10">
                    <h1 className="text-xl font-black text-slate-900 flex items-center gap-2"><Timer className="text-blue-500"/> Brewing Timer</h1>
                    <div className="flex gap-2">
                        <button onClick={openRecipeList} className="p-2 bg-slate-100 rounded-full text-slate-500"><List size={18}/></button>
                        {mode==='TIMER' && <><button onClick={openMemo} className="p-2 bg-slate-100 rounded-full text-slate-500 hover:text-amber-500"><StickyNote size={18}/></button><button onClick={handleSettingClick} className="p-2 bg-slate-100 rounded-full text-slate-500"><Settings size={18}/></button></>}
                        {mode==='EDIT' && <button onClick={()=>setRecipe({...INITIAL_RECIPE, id: Date.now()})} className="p-2 bg-slate-100 rounded-full text-blue-500 font-bold text-xs flex items-center gap-1"><Plus size={14}/> NEW</button>}
                    </div>
                </header>

                {mode === 'EDIT' && (
                    <div className="flex-1 overflow-y-auto p-6 pb-24 space-y-4">
                        <div className="mb-2"><div className="flex justify-between items-end mb-1"><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Name</label><span className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded-lg flex items-center gap-1"><Calculator size={12}/> {curRatio}</span></div><input className="w-full text-2xl font-bold font-brand bg-slate-100 rounded-xl p-3 outline-none" value={recipe.title} onChange={e=>setRecipe({...recipe,title:e.target.value})} placeholder="Î†àÏãúÌîº Ïù¥Î¶Ñ"/></div>
                        <div><label className="text-xs font-bold text-slate-500">ÏõêÎëê (g)</label><input className="w-full bg-slate-100 p-3 rounded-xl font-bold outline-none border border-transparent focus:border-blue-200" value={recipe.bean} onChange={e=>setRecipe({...recipe,bean:e.target.value})}/></div>
                        <div><label className="text-xs font-bold text-slate-500">Î¨º/Î™ÖÎ†πÏñ¥ (ex: cl 60 sw)</label><input className="w-full bg-slate-100 p-3 rounded-xl font-bold outline-none border border-transparent focus:border-blue-200" value={recipe.water} onChange={e=>setRecipe({...recipe,water:e.target.value})}/>
                            <div className="bg-slate-50 border border-slate-100 rounded-xl p-3 mt-2"><h4 className="text-[10px] font-bold text-slate-400 mb-2 uppercase tracking-wider border-b border-slate-200 pb-1">Command Guide</h4><div className="grid grid-cols-2 gap-y-1 gap-x-2 text-[11px] text-slate-500 font-medium"><div className="flex items-center gap-1"><Droplet size={11} className="text-blue-400"/> <span className="text-slate-800 font-bold">60</span> : Î¨º 60ml</div><div className="flex items-center gap-1"><CustomBeanIcon size={11} className="text-amber-700"/> <span className="text-slate-800 font-bold">20g</span> : ÏõêÎëê 20g</div><div>üîí <span className="text-slate-800 font-bold">cl</span> : Ïä§ÏúÑÏπò Îã´Í∏∞</div><div>üîì <span className="text-slate-800 font-bold">op</span> : Ïä§ÏúÑÏπò Ïó¥Í∏∞</div><div>ü•Ñ <span className="text-slate-800 font-bold">st</span> : Ï†ìÍ∏∞</div><div>üëã <span className="text-slate-800 font-bold">sw</span> : ÌùîÎì§Í∏∞</div><div>‚≠ï <span className="text-slate-800 font-bold">c</span> : ÏõêÌòï Ìë∏Ïñ¥</div><div>üåÄ <span className="text-slate-800 font-bold">s</span> : ÎÇòÏÑ† Ìë∏Ïñ¥</div><div>üéØ <span className="text-slate-800 font-bold">ct</span> : Ï§ëÏïô Ìë∏Ïñ¥</div></div><div className="mt-2 text-[11px] text-blue-600 bg-blue-50 px-2 py-1 rounded">‚ú® <b>Ï°∞Ìï© ÏòàÏãú:</b> cl60sw <span className="text-blue-400 text-[10px]">(Îã´Í≥† 60ml Î∂ìÍ≥† ÌùîÎì§Í∏∞)</span></div></div></div>
                        <div className="flex gap-2"><div><label className="text-xs font-bold text-slate-500">Í∞ÑÍ≤© (Ï¥à)</label><input className="w-full bg-slate-100 p-3 rounded-xl font-bold outline-none border border-transparent focus:border-blue-200" value={recipe.interval} onChange={e=>setRecipe({...recipe,interval:e.target.value})}/></div><div><label className="text-xs font-bold text-slate-500">Ï¢ÖÎ£å ÏãúÍ∞Ñ</label><input className="w-full bg-slate-100 p-3 rounded-xl font-bold outline-none border border-transparent focus:border-blue-200" value={recipe.endTime} onChange={e=>setRecipe({...recipe,endTime:e.target.value})}/></div></div>
                        <textarea className="w-full bg-amber-50 p-3 rounded-xl h-20 text-sm outline-none resize-none placeholder-amber-800/30" placeholder="Î©îÎ™®" value={recipe.memo} onChange={e=>setRecipe({...recipe,memo:e.target.value})}/>
                        <div className="flex gap-2 pt-2"><button onClick={handleSaveRequest} className="flex-1 py-3 bg-blue-100 text-blue-600 rounded-xl font-bold flex justify-center gap-2"><Save size={18}/> Î†àÏãúÌîº Ï†ÄÏû•</button></div>
                        <button onClick={startBrewing} className="w-full py-4 bg-slate-900 text-white rounded-2xl font-bold text-lg shadow-lg flex justify-center gap-2"><Play size={20} fill="currentColor"/> ÌÉÄÏù¥Î®∏ ÏãúÏûë</button>
                    </div>
                )}

                {mode === 'TIMER' && (
                    <div className="flex-1 flex flex-col relative overflow-hidden">
                        <div className="bg-white p-6 pb-4 rounded-b-[32px] shadow-sm z-10 text-center relative shrink-0"> 
                            <h2 className="text-lg font-bold truncate mb-1">{recipe.title}</h2>
                            <div className="text-xs font-bold text-slate-400 mb-6 bg-slate-100 px-3 py-1 rounded-full inline-flex items-center gap-1"><CustomBeanIcon size={12} className="text-amber-700"/> {recipe.bean}g <span className="mx-1">¬∑</span> <Calculator size={12} className="text-orange-400"/> {curRatio}</div>
                            <div className="flex justify-center items-center gap-6 mb-6">
                                <button onClick={handleReset} className="w-14 h-14 shrink-0 bg-slate-100 rounded-full flex items-center justify-center text-slate-400 shadow-sm hover:text-red-500 hover:bg-red-50 transition-colors"><RefreshCw size={22}/></button>
                                <span className="text-6xl font-bold font-brand tabular-nums tracking-tighter w-48 text-center">{formatTime(time)}</span>
                                <button onClick={toggleRun} className={`w-14 h-14 shrink-0 rounded-full flex items-center justify-center text-white shadow-lg transition-all active:scale-95 ${run?'bg-amber-100 text-amber-600':'bg-slate-900'}`}>{run?<Pause size={24} fill="currentColor"/>:<Play size={24} fill="currentColor" className="ml-1"/>}</button>
                            </div>
                            <div className="w-full max-w-[320px] mx-auto bg-white border-2 border-blue-500 shadow-xl rounded-2xl p-4 step-active flex items-center gap-4">
                                <div className="bg-blue-50 rounded-xl p-2 flex items-center justify-center border border-blue-100 w-[70px] shrink-0 h-[70px]">
                                    {curStep.icons?.length>0?curStep.icons.map((item, idx)=><MiniIcon key={idx} iconType={item.icon} isMain={item.type==='MAIN'}/>):<Clock size={20} className="text-slate-300"/>}
                                </div>
                                <div className="flex-1 text-center">
                                    <div className="text-2xl font-black text-slate-900 leading-none mb-1 break-keep">{curStep.desc}</div>
                                    {curStep.cumWater && (
                                        <div className="text-sm font-bold text-blue-500 mb-1">
                                            (ÎàÑÏ†Å {curStep.cumWater}ml{curStep.pourCount ? ` ‚Ä¢ ${curStep.pourCount}Ï∞® Ìë∏Ïñ¥` : ''})
                                        </div>
                                    )}
                                    <div className="text-xs font-bold text-slate-400">{curStep.timeRange}</div>
                                </div>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto bg-slate-50 relative no-scrollbar" ref={scrollRef}>
                            <div className="px-5 pt-6 pb-[60vh] space-y-6 relative">
                                {timeline.map((s,i)=>(
                                    <div key={i} ref={el=>itemRefs.current[i]=el}>
                                        <TimerStepRow step={s} isCurrent={i===stepIdx} isPast={i<stepIdx} />
                                    </div>
                                ))}
                            </div>
                        </div>
                        {/* Modal: Memo */}
                        {showMemo && <div className="absolute inset-0 bg-black/60 z-50 flex items-end" onClick={()=>window.history.back()}><div className="w-full bg-white rounded-t-3xl p-6" onClick={e=>e.stopPropagation()}><div className="flex justify-between mb-4"><h3 className="font-bold flex gap-2"><StickyNote className="text-amber-500"/> Memo</h3><X onClick={()=>window.history.back()}/></div><div className="bg-amber-50 p-4 rounded-2xl text-sm whitespace-pre-wrap min-h-[100px]">{recipe.memo||"Î©îÎ™® ÏóÜÏùå"}</div></div></div>}
                    </div>
                )}
            </div>
        );
    };

    // --- STATS TAB ---
    const DashboardFilter = ({ selectedYear, onSelectYear, availableYears }) => {
        const [isOpen, setIsOpen] = useState(false);
        return (
            <div className="relative z-20">
                <button onClick={() => setIsOpen(!isOpen)} className="flex items-center gap-1.5 text-[11px] font-bold text-slate-700 bg-white border border-slate-200 pl-3 pr-2 py-1.5 rounded-xl shadow-sm active:scale-95 transition-transform"><span>{selectedYear === 'ALL' ? 'Ï†ÑÏ≤¥ Í∏∞Í∞Ñ' : `${selectedYear}ÎÖÑ`}</span><ChevronDown size={14} className={`text-slate-400 transition-transform duration-200 ${isOpen ? 'rotate-180' : ''}`}/></button>
                {isOpen && (<><div className="fixed inset-0 z-10" onClick={() => setIsOpen(false)}></div><div className="absolute right-0 top-full mt-2 w-32 bg-white rounded-xl shadow-xl border border-slate-100 overflow-hidden z-20 animate-in fade-in slide-in-from-top-2 flex flex-col max-h-[300px] overflow-y-auto"><button onClick={() => { onSelectYear('ALL'); setIsOpen(false); }} className={`text-left px-4 py-3 text-xs font-bold transition-colors ${selectedYear === 'ALL' ? 'bg-slate-50 text-slate-900' : 'text-slate-500 hover:bg-slate-50'}`}>Ï†ÑÏ≤¥ Í∏∞Í∞Ñ</button>{availableYears.map(year => (<button key={year} onClick={() => { onSelectYear(year); setIsOpen(false); }} className={`text-left px-4 py-3 text-xs font-bold border-t border-slate-50 transition-colors ${selectedYear === year ? 'bg-slate-50 text-slate-900' : 'text-slate-500 hover:bg-slate-50'}`}>{year}ÎÖÑ</button>))}</div></>)}
            </div>
        );
    };

    const StatCard = ({ label, value, color, subValue, customIcon, subLabel }) => (
        <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-3">
            <div className={`w-10 h-10 rounded-full flex items-center justify-center ${color}`}>{customIcon}</div>
            <div>
                <p className="text-[10px] font-bold text-slate-400 uppercase">{label}</p>
                <div className="flex items-baseline gap-1.5"><p className="text-xl font-black text-slate-900 leading-none">{value}</p>{subValue && <span className="text-xs font-bold text-slate-400">{subValue}</span>}</div>
                {subLabel && <p className="text-[9px] text-slate-400 mt-0.5">{subLabel}</p>}
            </div>
        </div>
    );

    const CalendarView = ({ tastingDays, onSelectDate, selectedDate, onMonthChange, viewDate }) => {
        const year = viewDate.getFullYear();
        const month = viewDate.getMonth();
        const getDaysInMonth = (y, m) => new Date(y, m + 1, 0).getDate();
        const getFirstDayOfMonth = (y, m) => new Date(y, m, 1).getDay();
        const daysInMonth = getDaysInMonth(year, month);
        const firstDay = getFirstDayOfMonth(year, month);
        const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);
        const blanks = Array.from({ length: firstDay }, (_, i) => i);
        const isToday = (d) => { const today = new Date(); return d === today.getDate() && month === today.getMonth() && year === today.getFullYear(); };
        const isSelected = (d) => { if (!selectedDate) return false; const target = new Date(selectedDate); return d === target.getDate() && month === target.getMonth() && year === target.getFullYear(); };
        const hasTasting = (d) => { const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`; return tastingDays.includes(dateStr); };
        const handleDateClick = (d) => { const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`; onSelectDate(dateStr); };
        const changeMonth = (delta) => { onMonthChange(new Date(year, month + delta, 1)); };
        const changeYear = (delta) => { onMonthChange(new Date(year + delta, month, 1)); };

        return (
            <div className="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm select-none">
                <div className="flex justify-between items-center mb-6">
                    <div className="flex items-center gap-1"><button onClick={() => changeYear(-1)} className="p-1.5 text-slate-300 hover:text-slate-600 active:scale-90 transition-transform rounded-full hover:bg-slate-50"><ChevronsLeft size={20}/></button><button onClick={() => changeMonth(-1)} className="p-1.5 text-slate-300 hover:text-slate-600 active:scale-90 transition-transform rounded-full hover:bg-slate-50"><ChevronLeft size={20}/></button></div>
                    <h3 className="text-base font-black text-slate-900 font-brand tabular-nums">{year}. {String(month + 1).padStart(2, '0')}</h3>
                    <div className="flex items-center gap-1"><button onClick={() => changeMonth(1)} className="p-1.5 text-slate-300 hover:text-slate-600 active:scale-90 transition-transform rounded-full hover:bg-slate-50"><ChevronRight size={20}/></button><button onClick={() => changeYear(1)} className="p-1.5 text-slate-300 hover:text-slate-600 active:scale-90 transition-transform rounded-full hover:bg-slate-50"><ChevronsRight size={20}/></button></div>
                </div>
                <div className="grid grid-cols-7 gap-1 text-center mb-2">{['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map((day,i) => (<div key={day} className={`text-[9px] font-bold uppercase tracking-wider ${i===0?'text-red-400':(i===6?'text-blue-400':'text-slate-300')}`}>{day}</div>))}</div>
                <div className="grid grid-cols-7 gap-1">{blanks.map(i => <div key={`blank-${i}`} className="aspect-square"></div>)}{days.map(d => (<button key={d} onClick={() => handleDateClick(d)} className={`aspect-square rounded-full flex flex-col items-center justify-center relative transition-all ${isSelected(d) ? 'bg-slate-900 text-white shadow-md scale-105' : 'text-slate-700 hover:bg-slate-50'} ${isToday(d) && !isSelected(d) ? 'border border-slate-200 text-slate-900 font-bold' : ''}`}><span className="text-xs font-bold leading-none z-10">{d}</span>{hasTasting(d) && (<span className={`w-1 h-1 rounded-full mt-1 ${isSelected(d) ? 'bg-amber-400' : 'bg-amber-500'}`}></span>)}</button>))}</div>
            </div>
        );
    };

    const StatsTab = ({ active, onNavigateToBean }) => {
        const [beans, setBeans] = useState([]);
        const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
        const [viewDate, setViewDate] = useState(new Date());
        const [selectedYear, setSelectedYear] = useState('ALL');
        const scrollRef = useRef(null);

        useEffect(() => {
            if (active) {
                const data = safeStorage.get(`${STORAGE_KEY}_data`);
                if (Array.isArray(data)) setBeans(data);
                // [Fix] Reset scroll when Stats tab becomes active (via tab bar)
                if (scrollRef.current) scrollRef.current.scrollTop = 0;
            }
        }, [active]);

        const stats = useMemo(() => {
            const filteredBeans = selectedYear === 'ALL' ? beans : beans.filter(b => b.purchaseDate && b.purchaseDate.startsWith(selectedYear));
            const totalBeans = filteredBeans.length;
            const totalWeight = filteredBeans.reduce((acc, b) => acc + (parseFloat(b.weight)||0), 0);
            const activeBeans = filteredBeans.filter(b => !b.isFinished).length;
            const soldOutBeans = filteredBeans.filter(b => b.isFinished).length;
            const soldOutWeight = filteredBeans.filter(b => b.isFinished).reduce((acc, b) => acc + (parseFloat(b.weight)||0), 0);
            
            let totalTastings = 0;
            const tastingMap = {};
            const dateSet = new Set();
            
            let monthTastingCount = 0;
            let monthBeansBought = 0;
            const currentYear = viewDate.getFullYear();
            const currentMonth = viewDate.getMonth();

            beans.forEach(bean => {
                if (bean.tastings) {
                    bean.tastings.forEach(t => {
                        const tYear = t.date.split('-')[0];
                        if (selectedYear === 'ALL' || tYear === selectedYear) { totalTastings++; }
                        dateSet.add(t.date);
                        if (!tastingMap[t.date]) tastingMap[t.date] = [];
                        tastingMap[t.date].push({ ...t, beanId: bean.id, beanName: bean.name });
                        const tDate = new Date(t.date);
                        if (tDate.getFullYear() === currentYear && tDate.getMonth() === currentMonth) { monthTastingCount++; }
                    });
                }
                if (bean.purchaseDate) {
                    const pDate = new Date(bean.purchaseDate);
                    if (pDate.getFullYear() === currentYear && pDate.getMonth() === currentMonth) { monthBeansBought++; }
                }
            });

            const availableYears = Array.from(new Set(
                beans.map(b => b.purchaseDate ? b.purchaseDate.split('-')[0] : null)
                .concat(beans.flatMap(b => b.tastings ? b.tastings.map(t => t.date.split('-')[0]) : []))
            )).filter(Boolean).sort().reverse();

            return { totalBeans, totalWeight, activeBeans, soldOutBeans, soldOutWeight, totalTastings, tastingMap, tastingDays: Array.from(dateSet), monthTastingCount, monthBeansBought, availableYears };
        }, [beans, viewDate, selectedYear]);

        const selectedTastings = stats.tastingMap[selectedDate] || [];

        return (
            <div className={`h-full flex flex-col bg-slate-50 ${active ? 'block' : 'hidden'}`}>
                <header className="p-4 pt-4 border-b flex justify-between items-center bg-white sticky top-0 z-10"><h1 className="text-xl font-black text-slate-900 flex items-center gap-2"><LayoutDashboard className="text-slate-900"/> Insights</h1></header>
                <main className="flex-1 overflow-y-auto p-4 space-y-6 pb-24" ref={scrollRef}>
                    <section>
                        <div className="flex justify-between items-center mb-3 px-1 relative"><h2 className="text-xs font-bold text-slate-500 uppercase tracking-widest flex items-center gap-1"><BarChart3 size={14}/> Dashboard</h2><DashboardFilter selectedYear={selectedYear} onSelectYear={setSelectedYear} availableYears={stats.availableYears} /></div>
                        <div className="grid grid-cols-2 gap-3">
                            <StatCard label={`${selectedYear === 'ALL' ? 'ÎàÑÏ†Å' : selectedYear} Íµ¨Îß§`} value={stats.totalBeans} subValue={formatWeight(stats.totalWeight)} customIcon={<CustomBeanIcon size={20} className="text-amber-700"/>} color="bg-amber-100" />
                            <StatCard label="Îã§ Î®πÏùå" value={stats.soldOutBeans} subValue={formatWeight(stats.soldOutWeight)} customIcon={<CustomBeanIcon size={20} className="text-slate-500"/>} color="bg-slate-100" />
                            <StatCard label="ÎÇ®ÏùÄ ÏõêÎëê" value={stats.activeBeans} subLabel="ÌòÑÏû¨ Î≥¥Ïú† Ï§ë" customIcon={<CustomBeanIcon size={20} className="text-blue-600"/>} color="bg-blue-100" />
                            <StatCard label={`${selectedYear === 'ALL' ? 'ÎàÑÏ†Å' : selectedYear} ÏãúÏùå`} value={stats.totalTastings} customIcon={<Coffee size={18} className="text-purple-700"/>} color="bg-purple-100" subValue="Cups" />
                        </div>
                    </section>
                    <section>
                        <div className="flex items-center justify-between mb-3 px-1"><div className="flex items-center gap-2"><CalendarDays size={16} className="text-slate-400"/><h2 className="text-xs font-bold text-slate-500 uppercase tracking-widest">Coffee Calendar</h2></div><div className="flex gap-2 text-[10px] font-bold text-slate-400"><span className="bg-amber-50 text-amber-600 px-1.5 py-0.5 rounded border border-amber-100 flex items-center gap-1"><Coffee size={10}/> {stats.monthTastingCount}Ïûî ÎßàÏã¨</span><span className="bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded border border-slate-200 flex items-center gap-1"><CustomBeanIcon size={10} className="text-amber-700"/> {stats.monthBeansBought}Í∞ú Íµ¨Îß§</span></div></div>
                        <CalendarView tastingDays={stats.tastingDays} onSelectDate={setSelectedDate} selectedDate={selectedDate} onMonthChange={setViewDate} viewDate={viewDate} />
                    </section>
                    <section>
                        <div className="flex items-center justify-between mb-3 px-1"><h2 className="text-xs font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2"><Clock size={14}/> {selectedDate}</h2><span className="text-[10px] font-bold text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded-md">{selectedTastings.length} Records</span></div>
                        {selectedTastings.length > 0 ? (
                            <div className="space-y-3">
                                {selectedTastings.map((t, idx) => (
                                    <div key={idx} onClick={() => onNavigateToBean(t.beanId, t)} className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex items-center gap-4 active:scale-95 transition-transform cursor-pointer hover:border-blue-100">
                                        <div className="w-12 h-12 bg-white rounded-xl flex items-center justify-center font-black text-sm text-slate-900 border border-slate-100 shrink-0 shadow-sm">{getDisplayScore(t)}</div>
                                        <div className="flex-1 min-w-0"><h4 className="font-bold text-slate-900 truncate text-sm mb-0.5">{t.beanName}</h4><div className="flex items-center gap-1.5"><span className="text-[10px] bg-slate-100 text-slate-500 px-1 py-0.5 rounded font-bold">Flavor</span><p className="text-xs text-slate-400 truncate flex-1">{t.notes || "-"}</p></div></div><ChevronRight size={16} className="text-slate-300"/>
                                    </div>
                                ))}
                            </div>
                        ) : (<div className="py-12 text-center border-2 border-dashed border-slate-200 rounded-3xl bg-slate-50/50"><div className="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-300"><Coffee size={20} /></div><p className="text-xs font-bold text-slate-400">Ïª§ÌîºÎ•º ÎßàÏãúÏßÄ ÏïäÏïòÏñ¥Ïöî</p></div>)}
                    </section>
                </main>
            </div>
        );
    };

    const SettingsTab = ({ active, apiKey, setApiKey, showToastMsg }) => {
        if (!active && !apiKey) return null;
        const backup = () => {
            const data = { beans: safeStorage.get(`${STORAGE_KEY}_data`), recipes: safeStorage.get(RECIPE_STORAGE_KEY), key: safeStorage.get(`${STORAGE_KEY}_key`) };
            const url = URL.createObjectURL(new Blob([JSON.stringify(data,null,2)],{type:"application/json"}));
            const a = document.createElement('a'); a.href=url; a.download=`beanlog_v2_backup_${new Date().toISOString().slice(0, 10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        };
        const restore = (e) => {
            const f = e.target.files[0]; if (!f || !confirm("ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Î•º ÎçÆÏñ¥ÏîåÏõÅÎãàÎã§. ÏßÑÌñâÌï†ÍπåÏöî?")) return;
            const r = new FileReader(); r.onload = (ev) => { try { const d = JSON.parse(ev.target.result); if (d.beans) { safeStorage.set(`${STORAGE_KEY}_data`, d.beans); alert("ÏõêÎëê Îç∞Ïù¥ÌÑ∞ Î≥µÏõê ÏôÑÎ£å"); } if (d.recipes) { safeStorage.set(RECIPE_STORAGE_KEY, d.recipes); alert("Î†àÏãúÌîº Îç∞Ïù¥ÌÑ∞ Î≥µÏõê ÏôÑÎ£å"); } if (d.key) { safeStorage.set(`${STORAGE_KEY}_key`, d.key); setApiKey(d.key); } } catch (e) { alert("ÌååÏùº Ïò§Î•ò"); } }; r.readAsText(f);
        };
        const reset = () => { if (confirm("Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎê©ÎãàÎã§. Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) { localStorage.removeItem(`${STORAGE_KEY}_data`); localStorage.removeItem(RECIPE_STORAGE_KEY); localStorage.removeItem(`${STORAGE_KEY}_key`); location.reload(); } };
        const exitApp = () => { window.opener=null; window.open('','_self'); window.close(); setTimeout(()=>showToastMsg("Í∏∞Í∏∞Ïùò Ìôà Î≤ÑÌäºÏù¥ÎÇò Ï†úÏä§Ï≤òÎ•º ÏÇ¨Ïö©ÌïòÏó¨ Ï¢ÖÎ£åÌï¥Ï£ºÏÑ∏Ïöî."), 500); };

        return (
            <div className={`h-full flex flex-col bg-white ${active ? 'block' : 'hidden'}`}>
                <header className="p-4 pt-4 border-b"><h1 className="font-black text-xl">ÏÑ§Ï†ï</h1></header>
                <div className="p-6 space-y-6 flex-1 overflow-y-auto">
                    <div className="space-y-2"><label className="text-xs font-bold text-slate-500">Gemini API Key</label><input type="password" className="w-full p-4 bg-slate-50 rounded-2xl outline-none" value={apiKey} onChange={e=>{setApiKey(e.target.value); safeStorage.set(`${STORAGE_KEY}_key`,e.target.value);}} placeholder="API Key ÏûÖÎ†•"/></div>
                    <div className="pt-8 border-t space-y-3"><h3 className="font-bold text-sm">Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨</h3><button onClick={backup} className="w-full py-4 bg-slate-100 font-bold rounded-2xl flex items-center justify-center gap-2"><Download size={18}/> ÌÜµÌï© Î∞±ÏóÖ</button><div className="relative"><input type="file" onChange={restore} className="hidden" id="rFile" accept=".json" /><label htmlFor="rFile" className="w-full py-4 bg-slate-100 font-bold rounded-2xl flex items-center justify-center gap-2 cursor-pointer"><Upload size={18}/> Î≥µÏõê</label></div><button onClick={reset} className="w-full py-4 text-red-500 font-bold bg-red-50 rounded-2xl mt-4 flex items-center justify-center gap-2"><Trash2 size={18}/> Ï¥àÍ∏∞Ìôî</button></div>
                    <div className="pt-8 border-t space-y-3"><h3 className="font-bold text-sm">Ïï± Í¥ÄÎ¶¨</h3><button onClick={() => window.location.reload()} className="w-full py-4 bg-slate-100 font-bold rounded-2xl flex items-center justify-center gap-2"><RefreshCw size={18}/> Ïï± ÏÉàÎ°úÍ≥†Ïπ®</button><button onClick={exitApp} className="w-full py-4 bg-slate-100 font-bold rounded-2xl flex items-center justify-center gap-2"><LogOut size={18}/> Ïï± Ï¢ÖÎ£å</button></div>
                    <div className="pt-10 text-center"><p className="text-[10px] font-bold text-slate-300 uppercase tracking-widest">BeanLog {APP_VERSION}</p></div>
                </div>
            </div>
        );
    };

    const PWASetup = () => {
        const [deferredPrompt, setDeferredPrompt] = useState(null);
        const [showInstallBtn, setShowInstallBtn] = useState(false);

        useEffect(() => {
            // 1. Setup Icons & Manifest dynamically
            const svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="152 124 720 720" width="512" height="512" style="background-color:#f3f4f6">
            <g fill="#b45309" stroke="#b45309" stroke-width="20" stroke-linejoin="round" stroke-linecap="round">
                <path fill-opacity="0.9" d="M 606.5,191.5 C 626.3,189.9 645.6,192.1 664.5,198C 675.1,200.9 679.6,207.8 678,218.5C 673.5,239.2 662,254.5 643.5,264.5C 641.1,262.9 641.1,261.4 643.5,260C 642.4,258.6 641.1,257.6 639.5,257C 642.3,254.8 642,253.3 638.5,252.5C 653.5,243.8 662,230.8 664,213.5C 656.9,208.9 649.1,206.4 640.5,206C 628.2,204.8 615.9,204.3 603.5,204.5C 604.3,203.6 606,203.1 608.5,203C 605.1,202.8 601.8,202.3 598.5,201.5C 599.2,198.6 600.5,196.1 602.5,194C 601.5,193.7 600.5,193.3 599.5,193C 602,192.8 604.4,192.3 606.5,191.5 Z"/>
                <path fill-opacity="0.8" d="M 708.5,221.5 C 732.2,236 749.7,256 761,281.5C 773.9,310.9 780.4,341.8 780.5,374C 780.4,399.5 777.7,424.7 772.5,449.5C 768.5,441.6 765.5,433.2 763.5,424.5C 771.2,379 767,334.6 751,291.5C 741.7,269.9 727.9,251.9 709.5,237.5C 712.1,237.3 712.1,236.8 709.5,236C 710.8,230.9 709.5,226.6 705.5,223C 706.7,222.8 707.7,222.3 708.5,221.5 Z"/>
                <path fill-opacity="1.0" d="M 638.5,252.5 C 642,253.3 642.3,254.8 639.5,257C 641.1,257.6 642.4,258.6 643.5,260C 641.1,261.4 641.1,262.9 643.5,264.5C 630.7,271.7 618.1,279.2 605.5,287C 591.7,296.9 579.1,308.1 567.5,320.5C 563.5,318.7 559.7,318.7 556,320.5C 554.7,319.1 554.2,317.4 554.5,315.5C 560.9,307.6 567.9,300.1 575.5,293C 594.8,276.9 615.8,263.4 638.5,252.5 Z"/>
                <path fill-opacity="0.8" d="M 606.5,191.5 C 604.4,192.3 602,192.8 599.5,193C 600.5,193.3 601.5,193.7 602.5,194C 600.5,196.1 599.2,198.6 598.5,201.5C 601.8,202.3 605.1,202.8 608.5,203C 606,203.1 604.3,203.6 603.5,204.5C 591.2,206.3 578.8,208.8 566.5,212C 529.9,223.1 496.3,239.8 465.5,262C 411.7,302.1 368.2,351.3 335,409.5C 310.1,452.9 293.6,499.2 285.5,548.5C 284.8,551.2 284.2,553.8 283.5,556.5C 282.7,557 282,558.3 281.5,560.5C 280.7,559.6 280.2,558.6 280,557.5C 279.7,558.3 279.2,559 278.5,559.5C 276.6,559.1 275.1,558.1 274,556.5C 273.7,557.2 273.3,557.8 273,558.5C 272.8,556.3 272.3,554.3 271.5,552.5C 276.3,515 286.4,479 302,444.5C 343,354.6 405.2,283.4 488.5,231C 515.5,215.2 544.1,203.6 574.5,196C 585,193.5 595.7,192 606.5,191.5 Z"/>
                <path fill-opacity="0.9" d="M 554.5,315.5 C 554.2,317.4 554.7,319.1 556,320.5C 559.7,318.7 563.5,318.7 567.5,320.5C 528.7,366.6 506.6,420 501,480.5C 491.1,533.4 469.1,580.4 435,621.5C 428.2,628.3 421.3,635.2 414.5,642C 407.2,648 399.5,653.5 391.5,658.5C 391.2,657 390.2,656.3 388.5,656.5C 387.7,651.4 384.7,649.4 379.5,650.5C 389.2,644.3 398.5,637.5 407.5,630C 433.2,606 453,577.8 467,545.5C 480.9,510.7 489.9,474.7 494,437.5C 504.4,391.7 524.6,351 554.5,315.5 Z"/>
                <path d="M 763.5,424.5 C 765.5,433.2 768.5,441.6 772.5,449.5C 748.4,553.2 695.8,639 614.5,707C 576.4,737.9 533.4,759.6 485.5,772C 474.2,774.2 462.9,776 451.5,777.5C 452.6,776.7 453.9,776.2 455.5,776C 452.2,775.7 448.8,775.3 445.5,775C 443.7,772.8 441.7,770.8 439.5,769C 443.5,766.7 447.8,765.3 452.5,765C 450.2,764.5 447.9,764.3 445.5,764.5C 445.5,764.2 445.5,763.8 445.5,763.5C 461.7,762.6 477.7,760.1 493.5,756C 533.4,743.5 569.8,724.5 602.5,699C 684.1,632.5 736.4,547.7 759.5,444.5C 760.9,442.5 761.6,440.2 761.5,437.5C 761.8,433 762.4,428.6 763.5,424.5 Z"/>
                <path d="M 271.5,552.5 C 272.3,554.3 272.8,556.3 273,558.5C 273.3,557.8 273.7,557.2 274,556.5C 275.1,558.1 276.6,559.1 278.5,559.5C 279.2,559 279.7,558.3 280,557.5C 280.2,558.6 280.7,559.6 281.5,560.5C 282,558.3 282.7,557 283.5,556.5C 283.5,559.5 283.5,562.5 283.5,565.5C 280.6,594.5 282.8,623.2 290,651.5C 295.9,673.2 306.4,692.2 321.5,708.5C 319.9,708.5 318.2,708.5 316.5,708.5C 314,709.7 314,710.9 316.5,712C 314,714.2 314.3,716.2 317.5,718C 316.7,719.6 317.3,720.6 319.5,721C 318.6,721.3 317.9,721.8 317.5,722.5C 298.3,704.7 285.1,683.1 278,657.5C 268.3,622.8 266.2,587.8 271.5,552.5 Z"/>
                <path fill-opacity="1.0" d="M 708.5,221.5 C 707.7,222.3 706.7,222.8 705.5,223C 709.5,226.6 710.8,230.9 709.5,236C 712.1,236.8 712.1,237.3 709.5,237.5C 708,236.7 706.7,236.7 705.5,237.5C 699.6,253.4 690.6,267.2 678.5,279C 664.2,289.5 649.5,299.5 634.5,309C 590.3,346.8 562.2,394.3 550,451.5C 546,481.8 539.3,511.5 530,540.5C 504.3,613.9 456.4,667.4 386.5,701C 373.4,709.9 365.4,722.1 362.5,737.5C 363,741.8 365,745.3 368.5,748C 380.6,756.1 393.9,760.9 408.5,762.5C 411.3,763.3 414.3,763.8 417.5,764C 426.8,764.5 436.1,764.6 445.5,764.5C 447.9,764.3 450.1,764.5 452.5,765C 447.8,765.3 443.5,766.6 439.5,769C 441.7,770.8 443.7,772.8 445.5,775C 448.8,775.3 452.1,775.6 455.5,776C 453.9,776.2 452.6,776.7 451.5,777.5C 422.4,780.6 394.8,776.1 368.5,764C 350.4,755.3 344.9,741.4 352,722.5C 359.2,707.2 370.1,695 384.5,686C 446.4,656.0 489.5,608.9 514,544.5C 519.5,529.1 524.2,513.4 528,497.5C 531.7,473.6 536.4,449.9 542,426.5C 557.4,375.6 585.3,333.1 625.5,299C 636.6,290.5 648.3,282.9 660.5,276C 678.3,262.5 690.3,245 696.5,223.5C 700,220.3 704,219.7 708.5,221.5 Z"/>
                <path fill-opacity="1.0" d="M 379.5,650.5 C 384.7,649.3 387.7,651.3 388.5,656.5C 390.1,656.2 391.1,656.9 391.5,658.5C 377.8,665.8 365.3,674.8 354,685.5C 343.7,697 336.2,710.2 331.5,725C 326.2,727.4 321.5,726.6 317.5,722.5C 317.9,721.7 318.5,721.2 319.5,721C 317.3,720.5 316.6,719.5 317.5,718C 314.3,716.1 313.9,714.1 316.5,712C 313.9,710.9 313.9,709.7 316.5,708.5C 318.1,708.5 319.8,708.5 321.5,708.5C 322.3,709.5 323.2,709.5 324,708.5C 335.1,682.1 353.6,662.8 379.5,650.5 Z"/>
            </g>
            <g fill="white" fill-opacity="0.3"><path d="M 603.5,204.5 C 615.9,204.3 628.2,204.8 640.5,206C 649.1,206.4 656.9,208.9 664,213.5C 662,230.8 653.5,243.8 638.5,252.5C 615.8,263.4 594.8,276.9 575.5,293C 567.9,300.1 560.9,307.6 554.5,315.5C 524.6,351 504.4,391.7 494,437.5C 489.9,474.7 480.9,510.7 467,545.5C 453,577.8 433.2,606 407.5,630C 398.5,637.5 389.2,644.3 379.5,650.5C 353.7,662.8 335.2,682.2 324,708.5C 323.2,709.6 322.4,709.6 321.5,708.5C 306.4,692.2 295.9,673.2 290,651.5C 282.8,623.2 280.6,594.5 283.5,565.5C 284.9,560.1 285.6,554.4 285.5,548.5C 293.6,499.2 310.1,452.9 335,409.5C 368.2,351.3 411.7,302.1 465.5,262C 496.3,239.8 529.9,223.1 566.5,212C 578.8,208.8 591.2,206.3 603.5,204.5 Z"/></g>
            </svg>`;
            
            const iconBlob = new Blob([svgIcon], { type: 'image/svg+xml' });
            const iconUrl = URL.createObjectURL(iconBlob);
            
            const linkIcon = document.createElement('link'); linkIcon.rel = 'icon'; linkIcon.href = iconUrl; document.head.appendChild(linkIcon);
            const linkApple = document.createElement('link'); linkApple.rel = 'apple-touch-icon'; linkApple.href = iconUrl; document.head.appendChild(linkApple);
            
            const manifest = { name: "BeanLog", short_name: "BeanLog", start_url: ".", display: "standalone", background_color: "#f3f4f6", theme_color: "#f3f4f6", icons: [{ src: iconUrl, sizes: "512x512", type: "image/svg+xml" }] };
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);
            const linkManifest = document.createElement('link'); linkManifest.rel = 'manifest'; linkManifest.href = manifestUrl; document.head.appendChild(linkManifest);

            // 2. Install Prompt Listener
            const handler = (e) => { e.preventDefault(); setDeferredPrompt(e); setShowInstallBtn(true); };
            window.addEventListener('beforeinstallprompt', handler);
            return () => window.removeEventListener('beforeinstallprompt', handler);
        }, []);

        const handleInstall = () => { if (!deferredPrompt) return; deferredPrompt.prompt(); deferredPrompt.userChoice.then((res) => { if (res.outcome === 'accepted') setShowInstallBtn(false); setDeferredPrompt(null); }); };

        if (!showInstallBtn) return null;
        return (
            <div className="fixed bottom-20 left-1/2 -translate-x-1/2 z-[80] animate-in slide-in-from-bottom-4 fade-in duration-500">
                <button onClick={handleInstall} className="bg-slate-900 text-white px-5 py-3 rounded-full shadow-2xl flex items-center gap-3 font-bold text-sm border border-slate-700 whitespace-nowrap">
                    <div className="w-8 h-8 bg-white rounded-full flex items-center justify-center text-amber-700"><CustomBeanIcon size={20} /></div>
                    Ïï± Îã§Ïö¥Î°úÎìú (Î∞îÎ°úÍ∞ÄÍ∏∞)
                    <X size={16} className="text-slate-500 ml-1" onClick={(e) => { e.stopPropagation(); setShowInstallBtn(false); }} />
                </button>
            </div>
        );
    };

    const App = () => {
        const [tab, setTab] = useState(TAB.BEANS);
        const [apiKey, setApiKey] = useState("");
        const [navProps, setNavProps] = useState(null);
        const [isTimerRunning, setIsTimerRunning] = useState(false);
        const [toast, setToast] = useState(null);
        const showToastMsg = (msg) => { setToast(msg); setTimeout(() => setToast(null), 3000); };

        useEffect(() => { const k = safeStorage.get(`${STORAGE_KEY}_key`); if (k) setApiKey(k); }, []);

        const updateTab = (newTab) => {
            if (newTab === TAB.TIMER && isTimerRunning) {
                 window.history.pushState({ tab: TAB.TIMER, mode: 'TIMER' }, '');
                 setTab(newTab);
                 return;
            }
            const newState = { tab: newTab };
            if (newTab === TAB.BEANS) { newState.view = 'LIST'; newState.id = null; }
            else if (newTab === TAB.TIMER) { newState.mode = 'EDIT'; }
            window.history.pushState(newState, '');
            setTab(newTab);
        };
        
        const handleNavigateToTasting = (beanId, tasting) => {
             window.history.pushState({ tab: TAB.BEANS, view: 'EDIT_TASTING', id: beanId }, '');
             setNavProps({ view: 'EDIT_TASTING', beanId: beanId, tasting: tasting });
             setTab(TAB.BEANS);
        };

        useEffect(() => {
            const handlePop = (event) => {
                if(event.state && event.state.tab) { setTab(event.state.tab); } else { setTab(TAB.BEANS); }
            };
            window.addEventListener('popstate', handlePop);
            return () => window.removeEventListener('popstate', handlePop);
        }, []);

        return (
            <div className="h-[100dvh] flex flex-col bg-white max-w-md mx-auto shadow-2xl overflow-hidden relative">
                <FontLoader />
                <PWASetup />
                {toast && <div className="fixed top-10 left-1/2 -translate-x-1/2 bg-slate-900/90 text-white px-6 py-3 rounded-full text-xs font-bold shadow-xl z-[120] whitespace-nowrap animate-in fade-in slide-in-from-top-2">{toast}</div>}
                <div className="flex-1 overflow-hidden relative">
                    <BeansTab active={tab === TAB.BEANS} globalApiKey={apiKey} navProps={navProps} onNavConsumed={() => setNavProps(null)} />
                    <TimerTab active={tab === TAB.TIMER} setIsTimerRunning={setIsTimerRunning} />
                    <StatsTab active={tab === TAB.STATS} onNavigateToBean={handleNavigateToTasting} />
                    <SettingsTab active={tab === TAB.SETTINGS} apiKey={apiKey} setApiKey={setApiKey} showToastMsg={showToastMsg} />
                </div>
                <div className="bg-white border-t border-slate-100 flex justify-between items-center shrink-0 z-[50] h-[50px] px-6">
                    <button onClick={() => updateTab(TAB.BEANS)} className={`flex items-center justify-center w-full h-full gap-1 transition-colors ${tab === TAB.BEANS ? 'text-slate-900' : 'text-slate-300'}`}><CustomBeanIcon size={20} className={tab === TAB.BEANS ? 'text-slate-900' : 'text-slate-300'} /></button>
                    <button onClick={() => updateTab(TAB.TIMER)} className={`flex items-center justify-center w-full h-full gap-1 transition-colors relative ${tab === TAB.TIMER ? 'text-blue-500' : 'text-slate-300'}`}>
                        <Timer size={20} strokeWidth={tab === TAB.TIMER ? 2.5 : 2} />
                        {isTimerRunning && <span className="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full animate-pulse border border-white"></span>}
                    </button>
                    <button onClick={() => updateTab(TAB.STATS)} className={`flex items-center justify-center w-full h-full gap-1 transition-colors ${tab === TAB.STATS ? 'text-slate-900' : 'text-slate-300'}`}><LayoutDashboard size={20} strokeWidth={tab === TAB.STATS ? 2.5 : 2} /></button>
                    <button onClick={() => updateTab(TAB.SETTINGS)} className={`flex items-center justify-center w-full h-full gap-1 transition-colors ${tab === TAB.SETTINGS ? 'text-slate-900' : 'text-slate-300'}`}><Settings size={20} strokeWidth={tab === TAB.SETTINGS ? 2.5 : 2} /></button>
                </div>
            </div>
        );
    };

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>